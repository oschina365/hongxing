<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
        "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
    <title></title>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
    <script type="text/javascript" src="/js/jQuery.js"></script>
    <link rel="stylesheet" href="/NSWEditor/themes/default/default.css" type="text/css" />
    <link rel="stylesheet" href="template.css" type="text/css" />
<!-- hongxin.com.cn/Mobile Baidu tongji analytics -->
<script>
var _hmt = _hmt || [];
(function() {
var hm = document.createElement("script");
hm.src = "https://hm.baidu.com/hm.js?25e431cff63a206eb286efd246de5f2d";
var s = document.getElementsByTagName("script")[0];
s.parentNode.insertBefore(hm, s);
})();
</script>
</head>
<body>
    <div class="wrapper">
        <div class="templateMain">
            <div class="navigate fl">
                <ul>
                    <li>我的模板</li>
                    <li>模板市场</li>
                </ul>
            </div>
            <div class="info fl">
                <div class="myTem elem-hide">
                    <div class="my-top">
                    <dl><dd class="dd1"></dd>
                            <dd>模板名称</dd>
                            <dd>保存时间</dd>
                            <dd>操作</dd></dl>
                        <div class="clear"></div>
                    </div>
                    <div class="my-info" id="myList">
                       
                    </div>
                    <div class="my-foot">
                       <dl> <dd class="dd1">
                            <input type="checkbox" class="checkAll" /></dd><dd>
                            <input class="dpl-btn dpl-btn-disabled" id="delete-temp"  type="button" value="删除" />
                          </dd><dd class="dd2"></dd></dl>
                        <div class="clear">
                        </div>
                    </div>
                </div>
                <div class="temMarket elem-hide">
                    <div class="temSelect">
                        模板栏目：<select id="first" class="tselect">
                            <option value="-1" sid='-1'>--请选择--</option>
                        </select>
                        <select id="second" class="elem-hide tselect">
                            <option value="-1" sid='-1'>--请选择--</option>
                        </select>
                        <select id="third" class="elem-hide tselect">
                            <option value="-1" sid='-1'>--请选择--</option>
                        </select>
                    </div>
                    <ul id="marketList" class="market-info">
                    
                    </ul>
                    <div class="marketview">
                    </div>
                </div>
            </div>
            <div class="clear"></div>
        </div>
    </div>
    <div id="view"></div>
    <div id="viewimg"><a href="javascript:;"></a><div class="viewimg"><div class="img-priview"><img class="" alt="" /></div></div></div>
    <script type="text/javascript" src="template.js"></script>

    <script type="text/javascript">
        if (typeof dialog == "undefined") { dialog = {}; }
        function initdel(b) {
            var del = $("#delete-temp");
            if (b == null) {
                if ($("#myList").find("input:checked").length) {
                    del.addClass("dpl-btn-disabled");
                } else {
                    del.removeClass("dpl-btn-disabled");
                }
            } else {
                if (b) {
                    del.addClass("dpl-btn-disabled");
                } else { del.removeClass("dpl-btn-disabled"); }
            }
        }
        $(".checkAll").click(function () {
            if (!!$(this).attr("checked")) {
                $("#myList").find("input").attr("checked", true); initdel(0);
            }
            else {
                $("#myList").find("input").attr("checked", false); initdel(1);
            }
        }).parent().next().children("#delete-temp").click(function () {
            if (!$(this).hasClass("dpl-btn-disabled")) {
                if (confirm("删除后，模板将无法恢复，确定删除吗？")) {
                    var _del = "";
                    $("#myList").find("input:checked").each(function () {
                        _del += $(this).parents("dl").attr("data-id") + ",";
                    });
                    if (_del.length) {
                        _del = _del.substring(0, _del.length - 1);
                        $.post("/Ajax.ashx?action=deltpl&t=", { data: _del }, function (rsp) {
                            var state = gav(rsp, "state");
                            if (state == 1) {
                                $.each(_del.split(","), function (i, v) {
                                    $("#myList>dl[data-id='" + v + "'").remove();
                                });
                            } else {
                                alert(gav(rsp, "msg"));
                            }
                        });
                    }
                }
            }
        });
        $(function () {
            $(".navigate li").click(function () {
                var index = $(this).addClass("cur").siblings("li").removeClass("cur").parent().children().index(this);
                $(this).parents(".navigate").next(".info").children().eq(index).show().siblings().hide();
            }).eq(0).trigger("click");
        });
        dialog.onok = function (datainfo) {
            if (!datainfo) { return; }
            if (editor.hasContents()) {//判断UE是否有值
                if (confirm("您当前有正在编辑的模板，继续使用将会替换当前编辑的模板内容，确定替换吗？")) {//提示是否更改
                    editor.setContent(datainfo);
                    dialog.close(false);
                }
            } else {
                editor.setContent(datainfo);
                dialog.close(false);
            }
        }
        
        $(".btn-view").click(function () {
            var viewbg = $("#view"),
            viewimg = $("#viewimg");
            var width = $(window).width() - viewimg.width();
            var height = $(window).height();
            viewbg.height(height).show(); viewimg.show();
            viewimg.css({ top: "10px", left: width / 2, height: height - 10 });
            viewimg.find("div").height(height - 30);
            viewimg.children("a").click(function () {
                viewimg.hide(); viewbg.hide();
            });
        });
        $("#viewimg img").mousemove(function () {
            var size = [$(this).width(), $(this).height()];
        });

        function getLocalTemplateModel(url, data, func) {
            $.getJSON(url, data, func);
        }
        function getTemplateModel(url, data, func) {
            $.ajax({
                type: "get",
                contentType: "application/json",
                url: url,
                data: data,
                dataType: "jsonp",
                success: func
            });
        }

        $(function () {
            //获取模板市场的分类
            var data = { domain: "nsw88.com", userName: "admin", password: "admin", ParentId: 1 };
            getTemplateModel("http://mb.nsw88.net.cn/WebService.asmx/GetTemplateColumn?jsoncallback=?", data, function (rsp) {
                if (rsp.Status == 1) {
                    if (rsp.Data && rsp.Data.length > 0) {
                        initSelect(rsp.Data, myTpl.select, $("#first"));
                        $(".temSelect select").change(function () {
                            var oid = $(this).val(),
                            cid = $(this).attr("id");
                            sid = $(this).children("option:selected").attr("sid");
                            initSelectChange(cid, oid, sid);
                        });
                    }
                } else {
                    alert(rsp.Error);
                }
            });
            data = {};
            //获取本地信息
            //{"State":1,"StateMSG":"","Data":[{"id":1,"title":"我的自定义信息","content":"","inputtime":"2014-03-29T00:00:00","isdefault":0}]}
            //{"State":0,"StateMSG":"暂无数据！","Data":null}
            data = {};
            getLocalTemplateModel("/Ajax.ashx?action=gettpls&t=" + Math.random(), data, function (rsp) {
                if (rsp.State == 1) {
                    if (rsp.Data && rsp.Data.length > 0) {
                        initMyTpl(rsp.Data, myTpl.my, $("#myList"));
                        $("#myList").find("input").bind("click", initdel(null));
                        $(".btn-detail").click(function () {//本地使用
                            var s = $(this).parents("dl").attr("data-id");
                            $.post("/ajax.ashx?action=gettpl&t=" + Math.random(), { oid: s }, function (rsp) {
                                var state = gav(rsp, "state");
                                if (state == "1") {
                                    dialog.onok(gav(rsp, "msg"));
                                } else {
                                    alert(gav(rsp, "msg"));
                                }
                            });
                        }).prev().click(function () { //本地预览
                            //                            window.open("/manager/NSWUEditor/dialogs/nswtemplate/pageview.htm?id=" + $(this).parents("dl").attr("data-id"), $(this).parents("dl").find("dd:eq(1").text() + "-预览", 'height=746,innerHeight=746,width=1040,innerWidth=1040,top=' + (window.screen.availHeight - 30 - 746) / 2 + ',left=' + (window.screen.availWidth - 10 - 1040) / 2 + ',status=no,toolbar=no,menubar=no,location=no,resizable=no,scrollbars=0,titlebar=no');
                            window.open("/manager/NSWUEditor/dialogs/nswtemplate/pageview.htm?id=" + $(this).parents("dl").attr("data-id"), "预览", '');
                        });
                    }
                }
            });
        });
        //模板替换标签
        var myTpl = {
            my: '<dl data-id="{id}"><dd class="dd1"><input type="checkbox"/></dd><dd>{title}</dd><dd>{time}</dd><dd class="op"><a class="dpl-btn btn-view" href="javascript:;" >预览</a><a class="dpl-btn btn-detail" href="javascript:;" >使用</a><span class="tips-box"></span></dd></dl>',
            market: '<li><dl><dt>{title}</dt><dd class="pic"><img src="{smallpic}" /></dd><dd><a class="dpl-btn btn-view" href="javascript:;"  data-bgpic="{bigpic}">预览</a><a data-content="{content}" class="dpl-btn btn-detail" href="javascript:;"  data-id="{id}">使用</a></dd></dl></li>',
            select: '<option value="{id}" sid="{sid}">{title}</option>',
            clear: '<div class="clear"></div>'
        };
        //本地模板标签替换
        function initMyTpl(data, tpl,appendid) {
            if (data) {
                var t = "";
                for (var i = 0; i < data.length; i++) {
                    var tmp = data[i];
                    t +=tpl.replace("{id}", tmp.id).replace("{title}", tmp.title).replace("{time}", tmp.inputtime.replace("T"," ")).replace("{asdf}", tmp.isdefault ? "" : "");
                }
                appendid.append(t + myTpl.clear);
            }
        }
        //模板市场分类标签替换
        function initSelect(data, tpl, appendid) {
            if (data) {
                var t = "";
                for (var i = 0; i < data.length; i++) {
                    var tmp = data[i];
                    t += tpl.replace("{id}", tmp.ID).replace("{sid}", tmp.sid).replace("{title}", tmp.Title);
                }
                appendid.append(t + myTpl.clear);
            }
        }
        //模板市场模板标签替换
        function initMarketTpl(data, tpl, appendid) {//模板市场
            if (data) {
                var t = "";
                for (var i = 0; i < data.length; i++) {
                    var tmp = data[i];
                    t += tpl.replace("{id}", tmp.ID).replace("{title}", tmp.Title).replace("{bigpic}", tmp.PhotoName).replace("{smallpic}", tmp.PhotoPath).replace("{asdf}", tmp.isdefault ? "" : "");
                }
                appendid.append(t + myTpl.clear).find("a.btn-detail").click(function () {//使用
                    var data = { domain: "nsw88.com", userName: "admin", password: "admin", id: $(this).attr("data-id") };
                    getTemplateModel("http://mb.nsw88.net.cn/WebService.asmx/GetTemplatesByID?jsoncallback=?", data, function (rsp) {
                        if (rsp.Status == 1) {
                            if (rsp.Data && rsp.Data.length > 0) {
                                dialog.onok(rsp.Data[0].Content);
                            } else { alert("使用失败！"); }
                        } else { alert("使用失败！"); }
                    });
                }).prev().click(function () {//预览
                    var em = showSBLWrapper();
                    showSBLWrapperImg(em, $(this).attr("data-bgpic"));
                });
            }
        }

        function gav(xMsg, key) {
            var jMsg = $(xMsg);
            var s = $(jMsg.find("node[key=" + key + "]")).text();
            return s;
        }
        //模板市场分类改变事件
        function initSelectChange(cid, oid, sid) {
            var data = { domain: "nsw88.com", userName: "admin", password: "admin", ParentId: oid };
            //获取模板市场分类
            getTemplateModel("http://mb.nsw88.net.cn/WebService.asmx/GetTemplateColumn?jsoncallback=?", data, function (rsp) {
                var next = $("#" + cid).next();
                next.html("<option value='-1' sid='-1'>--请选择--</option>");
                if (rsp.Status == 1) {
                    if (rsp.Data && rsp.Data.length > 0) {
                        initSelect(rsp.Data, myTpl.select, $("#" + cid).next().show());
                    } else {
                        next.hide();
                    }
                } else {
                    next.hide();
                }
            });
            //获取模板市场模板 GetTemplatesBySid  string sid, string userName, string password, string domain
            //GetTemplatesByID  string id,string userName, string password, string domain
            data = { domain: "nsw88.com", userName: "admin", password: "admin", sid: sid };
            getTemplateModel("http://mb.nsw88.net.cn/WebService.asmx/GetTemplatesBySid?jsoncallback=?", data, function (rsp) {
                var mlist = $("#marketList").html('');
                if (rsp.Status == 1) {
                    if (rsp.Data && rsp.Data.length > 0) {
                        initMarketTpl(rsp.Data, myTpl.market, mlist);
                    } else { oopstpl(); }
                } else { oopstpl(); }
            });

        }
        function oopstpl() {
            $("#marketList").append("<li class='nodata'>暂无模板！</li>");
        }
    </script>
</body>
</html>