(function(A){A(function(){var U=A("#uploader"),b=A(".filelist,.filelist01"),X=U.find(".statusBar"),L=X.find(".info"),C=U.find(".uploadBtn"),O=U.find(".placeholder"),W=X.find(".progress").hide(),S=0,B=0,H=window.devicePixelRatio||1,R=102*H,T=102*H,F="pedding",J={},M=(function(){var g=new Image();var f=true;g.onload=g.onerror=function(){if(this.width!=1||this.height!=1){f=false}};g.src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==";return f})(),e=(function(){var g;try{g=navigator.plugins["Shockwave Flash"];g=g.description}catch(h){try{g=new ActiveXObject("ShockwaveFlash.ShockwaveFlash").GetVariable("$version")}catch(f){g="0.0"}}g=g.match(/\d+/g);return parseFloat(g[0]+"."+g[1],10)})(),I=(function(){var g=document.createElement("p").style,f="transition" in g||"WebkitTransition" in g||"MozTransition" in g||"msTransition" in g||"OTransition" in g;g=null;return f})(),V,d=WebUploader.Base.guid();if(!WebUploader.Uploader.support("flash")&&WebUploader.browser.ie){if(e){(function(f){window["expressinstallcallback"]=function(i){switch(i){case"Download.Cancelled":alert("您取消了更新！");break;case"Download.Failed":alert("安装失败");break;default:alert("安装已成功，请刷新！");break}delete window["expressinstallcallback"]};var g="./expressInstall.swf";var h='<object type="application/x-shockwave-flash" data="'+g+'" ';if(WebUploader.browser.ie){h+='classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000" '}h+='width="100%" height="100%" style="outline:0"><param name="movie" value="'+g+'" /><param name="wmode" value="transparent" /><param name="allowscriptaccess" value="always" /></object>';f.html(h)})(U)}else{U.html('<a href="http://www.adobe.com/go/getflashplayer" target="_blank" border="0"><img alt="get flash player" src="http://www.adobe.com/macromedia/style_guide/images/160x41_Get_Flash_Player.jpg" /></a>')}return}else{if(!WebUploader.Uploader.support()){alert("Web Uploader 不支持您的浏览器！");return}}var N={pick:{id:"#filePicker",label:"点击选择图片"},formData:{},dnd:"#dndArea",paste:"#uploader",swf:"js/other/webuploader/dist/Uploader.swf",chunked:false,chunkSize:2*1024*1024,threads:1,server:U.attr("action"),disableGlobalDnd:true,fileNumLimit:300,compress:false,fileSizeLimit:20000*1024*1024,fileSingleSizeLimit:100*1024*1024,multiple:true,thumb:{quality:70,allowMagnify:false,crop:false}};N=jQuery.extend({},N,window["WebUploader_Options"]||{});if(N.fileNumLimit==1){N.multiple=false}V=WebUploader.create(N);V.on("dndAccept",function(j){var f=false,k=j.length,h=0,g="text/plain;application/javascript ";for(;h<k;h++){if(~g.indexOf(j[h].type)){f=true;break}}return !f});function K(h,g){var f=h.file?A("#"+h.file.id):A("#"+h.id);f.data("data",g);f.find("img").attr("url",g.url).attr("alt",g.title)}V.on("uploadAccept",function(i,h){var f=h.error=="0";if(f){K(i,h)}var g=typeof(h.hasError);if(g!=="undefined"){f=h.hasError==false;if(!f&&g==="string"){_alert(h.hasError)}}return f});V.on("uploadBeforeSend",function(i,g,h){var f=A("#"+(i.id?i.id:i.file.id));g.Title=f.find(".txt").val();g.ColumnID=A("#ddlColumns").val();g.Watermark=A("em.e_word.z_select").length>0;if(N.chunked){g.guid=d;g.total=i.total||"-1";g.ext=i.file.ext||"---"}});V.on("ready",function(){window.uploader=V;window.uploader.reset_=function(){var g=V.getFiles();for(var h=0;h<g.length;h++){var j=g[h];V.removeFile(j);var f=A("#"+j.id);f.off().remove()}Z("pedding");S=0;B=0;V.reset();E();d=WebUploader.Base.guid()}});function Y(f){if(!J[f.id]){J[f.id]=[f.size,0];f.rotation=0}}function G(g,f){f.text("预览中");V.makeThumb(g,function(j,i){var h;if(j){f.text("不能预览");return}if(M){h=A('<img src="'+i+'">');f.empty().append(h)}},R,1)}function Q(g,f){if(f===false){console.log(g.getSource())}if(f){if(!window.top.meitu){window.top.meitu=window.open("meitu.html","newindow","height=600,width=900,top=0,left=0,toolbar=no,menubar=no,scrollbars=no,resizable=no,location=no,status=no")}if(window.top.meitu){window.top.meitu.postMessage(f,window.location.origin)}}}function c(h){var f=N.addFile?N.addFile.apply(V,[h,J,b,Y]):null;if(f==null){f=A('<li id="'+h.id+'" class="state-start"><p class="imgWrap"></p><p class="input"><textarea class="txt"></textarea></p><p class="progress"><span></span></p></li>'),$btns=A(['<div class="file-panel">','<i class="cancel">删除</i>',"</div>"].join("")).appendTo(f),$prgress=f.find("p.progress span"),U=f.find("p.imgWrap"),$err=A('<p class="error"></p>'),$txt=f.find(".txt"),showError=function(i){switch(i){case"exceed_size":text="文件大小超出";break;case"interrupt":text="上传暂停";break;default:text="上传失败，请重试："+i;break}$err.text(text).appendTo(f)};var g=h.name.lastIndexOf(".");$txt.val(g>0?h.name.substr(0,g):h.name);if(h.getStatus()==="invalid"){showError(h.statusText)}else{G(h,U);Y(h)}h.on("statuschange",function(j,i){if(i==="progress"){$prgress.hide().width(0)}else{if(i==="queued"){}}if(j==="error"||j==="invalid"){showError(h.statusText);J[h.id][1]=1}else{if(j==="interrupt"){showError("interrupt")}else{if(j==="queued"){J[h.id][1]=0}else{if(j==="progress"){$err.remove();$prgress.css("display","block")}else{if(j==="complete"){f.append('<span class="success"></span>')}}}}}f.removeClass("state-start").removeClass("state-"+i).addClass("state-"+j)});f.on("mouseenter",function(){A(this).find(".file-panel").stop().animate({height:30})});f.on("mouseleave",function(){A(this).find(".file-panel").stop().animate({height:0})});$btns.on("click","i",function(){var j=A(this);var k=j.index(),l,i=-1;if(j.hasClass("cancel")){V.removeFile(h)}if(j.hasClass("rotateRight01")){Q(h,false)}if(i!==-1){h.rotation+=i;if(I){l="rotate("+h.rotation+"deg)";U.css({"-webkit-transform":l,"-mos-transform":l,"-o-transform":l,"transform":l})}else{U.css("filter","progid:DXImageTransform.Microsoft.BasicImage(rotation="+(~~((h.rotation/90)%4+4)%4)+")")}}});f.appendTo(b);b.trigger("_change_");if(N.multiple&&window["SetDraggableLi"]){SetDraggableLi(f,"h","file-panel")}}Y(h)}function P(g){var f=A("#"+g.id);delete J[g.id];a();f.off().find(".file-panel").off().end().remove()}function a(){var i=0,f=0,g=W.children(),h;A.each(J,function(l,j){if(j!==false){f+=j[0];i+=j[0]*j[1]}});h=f?i/f:0;g.eq(0).text(Math.round(h*100)+"%");g.eq(1).css("width",Math.round(h*100)+"%");E()}V.onUploadProgress=function(j,i){var f=A("#"+j.id),h=f.find(".progress span"),g="width";if(h.length==0){h=f.removeClass("file_queued_handler").find(".progress_").show()}g=h.attr("op")||g;h.css(g,i*100+"%");J[j.id][1]=i;a()};V.onFileQueued=function(f){S++;B+=f.size;if(S===1){O.addClass("element-invisible");X.show()}c(f);Z("ready");a()};V.onFileDequeued=function(f){S--;B-=f.size;if(!S){Z("pedding")}P(f);a()};function E(){var g="",f;if(F==="ready"){g="选中"+S+"个文件，共"+WebUploader.formatSize(B)+"。"}else{if(F==="confirm"){f=V.getStats();if(f.uploadFailNum){g="已成功上传"+f.successNum+"个文件，"+f.uploadFailNum+'个文件上传失败，<a class="retry" href="#">重新上传</a>失败文件或<a class="ignore" href="#">忽略</a>'}}else{f=V.getStats();g="共"+S+"个（"+WebUploader.formatSize(B)+"），已上传"+f.successNum+"个";if(f.uploadFailNum){g+="，失败"+f.uploadFailNum+"个"}}}L.html(g)}function Z(g){var h,f;if(g===F){return}C.removeClass("state-"+F);C.addClass("state-"+g);F=g;J.finish=false;switch(F){case"pedding":O.removeClass("element-invisible");b.hide();X.addClass("element-invisible");V.refresh();break;case"ready":O.addClass("element-invisible");b.show();X.removeClass("element-invisible");V.refresh();break;case"uploading":W.show();break;case"paused":W.show();break;case"confirm":W.hide();f=V.getStats();if(f.successNum&&!f.uploadFailNum){Z("finish");return}break;case"finish":f=V.getStats();if(f.successNum){if(!N.chunked){C.trigger("callback")}J.finish=true}else{F="done";location.reload()}break}E()}function D(f){var j=V.getFiles();var g=true;for(var k=0;k<j.length;k++){var h=A("#"+j[k].id);if(h.attr("merge")==="false"||!J.finish){g=false;break}}if(g&&f){f()}}V.on("uploadSuccess",function(h,g){var f=A("#"+h.id);if(g.chunked){f.attr("merge","false");A.post("Handler/upload.ashx?action=MergeChunkedFiles",{guid:d,ext:g.f_ext,name:h.name,title:f.find(".txt").val()||""},function(i){i=A.parseJSON(i);if(i.hasError){alert("文件合并失败："+i.hasError)}else{i.url=decodeURIComponent(i.url);i.name=decodeURIComponent(i.name);K(h,i)}f.attr("merge","true");D(function(){C.trigger("callback")})})}});V.on("all",function(h,i,g){var f;switch(h){case"uploadFinished":Z("confirm");break;case"startUpload":Z("uploading");break;case"stopUpload":Z("paused");break}});V.onError=function(f){switch(f){case"Q_EXCEED_NUM_LIMIT":_alert("上传数量不能超过“"+N.fileNumLimit+"”");break;case"F_DUPLICATE":_alert("请不要重复选择文件！");break;case"Q_TYPE_DENIED":_alert("不支持该类型文件，如需添加请联系客服设置！");break;case"F_EXCEED_SIZE":_alert("文件超过大小限制！");break;case"Q_EXCEED_SIZE_LIMIT":_alert("所选附件总大小不可超过"+(N.fileSizeLimit/1024/1024)+"M");break;default:_alert("错误代码："+f)}};C.on("click",function(){if(A(this).hasClass("disabled")){return false}A(this).trigger("click_",function(){if(F==="ready"){V.upload()}else{if(F==="paused"){V.upload()}else{if(F==="uploading"){V.stop()}}}})});L.on("click",".retry",function(){V.retry()});L.on("click",".ignore",function(){C.trigger("callback")});C.addClass("state-"+F);a()})})(jQuery);