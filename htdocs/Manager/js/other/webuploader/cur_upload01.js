(function(A){A(function(){var V=A("#uploader"),c=A(".filelist,.filelist01"),Y=V.find(".statusBar"),L=Y.find(".info"),C=V.find(".uploadBtn"),P=V.find(".placeholder"),X=Y.find(".progress").hide(),T=0,B=0,H=window.devicePixelRatio||1,S=102*H,U=102*H,F="pedding",N=true,J={},M=(function(){var h=new Image();var g=true;h.onload=h.onerror=function(){if(this.width!=1||this.height!=1){g=false}};h.src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==";return g})(),f=(function(){var h;try{h=navigator.plugins["Shockwave Flash"];h=h.description}catch(i){try{h=new ActiveXObject("ShockwaveFlash.ShockwaveFlash").GetVariable("$version")}catch(g){h="0.0"}}h=h.match(/\d+/g);return parseFloat(h[0]+"."+h[1],10)})(),I=(function(){var h=document.createElement("p").style,g="transition" in h||"WebkitTransition" in h||"MozTransition" in h||"msTransition" in h||"OTransition" in h;h=null;return g})(),W,e=WebUploader.Base.guid();if(!WebUploader.Uploader.support("flash")&&WebUploader.browser.ie){if(f){(function(g){window["expressinstallcallback"]=function(j){switch(j){case"Download.Cancelled":alert("您取消了更新！");break;case"Download.Failed":alert("安装失败");break;default:alert("安装已成功，请刷新！");break}delete window["expressinstallcallback"]};var h="./expressInstall.swf";var i='<object type="application/x-shockwave-flash" data="'+h+'" ';if(WebUploader.browser.ie){i+='classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000" '}i+='width="100%" height="100%" style="outline:0"><param name="movie" value="'+h+'" /><param name="wmode" value="transparent" /><param name="allowscriptaccess" value="always" /></object>';g.html(i)})(V)}else{V.html('<a href="http://www.adobe.com/go/getflashplayer" target="_blank" border="0"><img alt="get flash player" src="http://www.adobe.com/macromedia/style_guide/images/160x41_Get_Flash_Player.jpg" /></a>')}return}else{if(!WebUploader.Uploader.support()){alert("Web Uploader 不支持您的浏览器！");return}}var O={pick:{id:"#filePicker",label:"点击选择图片"},formData:{},dnd:"#dndArea",paste:"#uploader",swf:"js/other/webuploader/dist/Uploader.swf",chunked:false,chunkSize:2*1024*1024,threads:1,server:V.attr("action"),disableGlobalDnd:true,fileNumLimit:300,compress:false,fileSizeLimit:20000*1024*1024,fileSingleSizeLimit:100*1024*1024,multiple:true,thumb:{quality:70,allowMagnify:false,crop:false}};O=jQuery.extend({},O,window["WebUploader_Options"]||{});if(O.fileNumLimit==1){O.multiple=false}W=WebUploader.create(O);W.on("dndAccept",function(k){var g=false,l=k.length,j=0,h="text/plain;application/javascript ";for(;j<l;j++){if(~h.indexOf(k[j].type)){g=true;break}}return !g});function K(i,h){var g=i.file?A("#"+i.file.id):A("#"+i.id);g.data("data",h);g.find("img").attr("url",h.url).attr("alt",h.title)}W.on("uploadAccept",function(j,i){var g=i.error=="0";if(g){K(j,i)}var h=typeof(i.hasError);if(h!=="undefined"){g=i.hasError==false;if(!g&&h==="string"){_alert(i.hasError)}}return g});W.on("uploadBeforeSend",function(j,h,i){var g=A("#"+(j.id?j.id:j.file.id));h.Title=g.find(".txt").val();h.ColumnID=A("#ddlColumns").val();h.Watermark=A("em.e_word.z_select").length>0;if(O.chunked){h.guid=e;h.total=j.total||"-1";h.ext=j.file.ext||"---"}});W.on("ready",function(){window.uploader=W;window.uploader.reset_=function(){var h=W.getFiles();for(var j=0;j<h.length;j++){var k=h[j];W.removeFile(k);var g=A("#"+k.id);g.off().remove()}a("pedding");T=0;B=0;W.reset();E();e=WebUploader.Base.guid()}});function Z(g){if(!J[g.id]){J[g.id]=[g.size,0];g.rotation=0}}function G(h,g){g.text("预览中");W.makeThumb(h,function(k,j){var i;if(k){g.text("不能预览");return}if(M){i=A('<img src="'+j+'">');g.empty().append(i)}},S,1)}function R(h,g){window.top.meitu=window.top.meitu||{};W.makeThumb(h,function(k,j){if(k){return}window.top.meitu.loadPhoto=function(l){l.xiuxiu.loadPhoto(j,true)};var i=0;if(!window.top.meitu.layero){window.top.meitu.w=(window.top.document.documentElement.clientWidth*0.85)+"px";window.top.meitu.h=(window.top.document.documentElement.clientHeight*0.85)+"px";window.top.meitu.layero=true;loadJs("js/other/layer/layer.js",function(){if(typeof(MeiTuPop)=="undefined"){layer.open({type:2,title:false,shade:[0],area:[window.top.meitu.w,window.top.meitu.h],content:"meitu.html",success:function(l,m){l.find(".layui-layer-close").unbind("click").bind("click",function(){i=window.top.meitu.layero.css("left");window.top.meitu.layero.css("left","-10000px")});window.top.meitu.layero=l}})}},window.top.document)}else{if(window.top.meitu.layero){window.top.meitu.layero.css("left",i)}}})}function d(i){var g=O.addFile?O.addFile.apply(W,[i,J,c,Z]):null;if(g==null){g=A('<li id="'+i.id+'" class="state-start"><p class="imgWrap"></p><p class="input"><textarea class="txt"></textarea></p><p class="progress"><span></span></p></li>'),$btns=A(['<div class="file-panel">','<i class="cancel">删除</i>',N?'<i class="rotateRight rotateRight01">处理</i>':"","</div>"].join("")).appendTo(g),$prgress=g.find("p.progress span"),V=g.find("p.imgWrap"),L=A('<p class="error"></p>'),$txt=g.find(".txt"),showError=function(j){switch(j){case"exceed_size":text="文件大小超出";break;case"interrupt":text="上传暂停";break;default:text="上传失败，请重试："+j;break}L.text(text).appendTo(g)};var h=i.name.lastIndexOf(".");$txt.val(h>0?i.name.substr(0,h):i.name);if(i.getStatus()==="invalid"){showError(i.statusText)}else{G(i,V);Z(i)}i.on("statuschange",function(k,j){if(j==="progress"){$prgress.hide().width(0)}else{if(j==="queued"){g.off("mouseenter mouseleave");$btns.remove()}}if(k==="error"||k==="invalid"){showError(i.statusText);J[i.id][1]=1}else{if(k==="interrupt"){showError("interrupt")}else{if(k==="queued"){J[i.id][1]=0}else{if(k==="progress"){L.remove();$prgress.css("display","block")}else{if(k==="complete"){g.append('<span class="success"></span>')}}}}}g.removeClass("state-start").removeClass("state-"+j).addClass("state-"+k)});g.on("mouseenter",function(){A(this).find(".file-panel").stop().animate({height:30})});g.on("mouseleave",function(){A(this).find(".file-panel").stop().animate({height:0})});$btns.on("click","i",function(){var k=A(this);var l=k.index(),m,j=-1;if(k.hasClass("cancel")){W.removeFile(i)}if(k.hasClass("rotateRight01")){R(i,false)}if(j!==-1){i.rotation+=j;if(I){m="rotate("+i.rotation+"deg)";V.css({"-webkit-transform":m,"-mos-transform":m,"-o-transform":m,"transform":m})}else{V.css("filter","progid:DXImageTransform.Microsoft.BasicImage(rotation="+(~~((i.rotation/90)%4+4)%4)+")")}}});g.appendTo(c);c.trigger("_change_");if(O.multiple&&window["SetDraggableLi"]){SetDraggableLi(g,"h","file-panel")}}Z(i)}function Q(h){var g=A("#"+h.id);delete J[h.id];b();g.off().find(".file-panel").off().end().remove()}function b(){var j=0,g=0,h=X.children(),i;A.each(J,function(m,l){if(l!==false){g+=l[0];j+=l[0]*l[1]}});i=g?j/g:0;h.eq(0).text(Math.round(i*100)+"%");h.eq(1).css("width",Math.round(i*100)+"%");E()}W.onUploadProgress=function(k,j){var g=A("#"+k.id),i=g.find(".progress span"),h="width";if(i.length==0){i=g.removeClass("file_queued_handler").find(".progress_").show()}h=i.attr("op")||h;i.css(h,j*100+"%");J[k.id][1]=j;b()};W.onFileQueued=function(g){T++;B+=g.size;if(T===1){P.addClass("element-invisible");Y.show()}d(g);a("ready");b()};W.onFileDequeued=function(g){T--;B-=g.size;if(!T){a("pedding")}Q(g);b()};function E(){var h="",g;if(F==="ready"){h="选中"+T+"个文件，共"+WebUploader.formatSize(B)+"。"}else{if(F==="confirm"){g=W.getStats();if(g.uploadFailNum){h="已成功上传"+g.successNum+"个文件至“"+A("#ddlColumns option:selected").text().replace("├-","").replace("└-","")+"”相册，"+g.uploadFailNum+'个文件上传失败，<a class="retry" href="#">重新上传</a>失败文件或<a class="ignore" href="#">忽略</a>'}}else{g=W.getStats();h="共"+T+"个（"+WebUploader.formatSize(B)+"），已上传"+g.successNum+"个";if(g.uploadFailNum){h+="，失败"+g.uploadFailNum+"个"}}}L.html(h)}function a(h){var i,g;if(h===F){return}C.removeClass("state-"+F);C.addClass("state-"+h);F=h;J.finish=false;switch(F){case"pedding":P.removeClass("element-invisible");c.hide();Y.addClass("element-invisible");W.refresh();break;case"ready":P.addClass("element-invisible");c.show();Y.removeClass("element-invisible");W.refresh();break;case"uploading":X.show();break;case"paused":X.show();break;case"confirm":X.hide();g=W.getStats();if(g.successNum&&!g.uploadFailNum){a("finish");return}break;case"finish":g=W.getStats();if(g.successNum){if(!O.chunked){C.trigger("callback")}J.finish=true}else{F="done";location.reload()}break}E()}function D(g){var k=W.getFiles();var h=true;for(var l=0;l<k.length;l++){var j=A("#"+k[l].id);if(j.attr("merge")==="false"||!J.finish){h=false;break}}if(h&&g){g()}}W.on("uploadSuccess",function(i,h){var g=A("#"+i.id);if(h.chunked){g.attr("merge","false");A.post("Handler/upload.ashx?action=MergeChunkedFiles",{guid:e,ext:h.f_ext,name:i.name,title:g.find(".txt").val()||""},function(j){j=A.parseJSON(j);if(j.hasError){alert("文件合并失败："+j.hasError)}else{j.url=decodeURIComponent(j.url);j.name=decodeURIComponent(j.name);K(i,j)}g.attr("merge","true");D(function(){C.trigger("callback")})})}});W.on("all",function(i,j,h){var g;switch(i){case"uploadFinished":a("confirm");break;case"startUpload":a("uploading");break;case"stopUpload":a("paused");break}});W.onError=function(g){switch(g){case"Q_EXCEED_NUM_LIMIT":_alert("上传数量不能超过“"+O.fileNumLimit+"”");break;case"F_DUPLICATE":_alert("请不要重复选择文件！");break;case"Q_TYPE_DENIED":_alert("不支持该类型文件，如需添加请联系客服设置！");break;case"F_EXCEED_SIZE":_alert("文件超过大小限制！");break;case"Q_EXCEED_SIZE_LIMIT":_alert("所选附件总大小不可超过"+(O.fileSizeLimit/1024/1024)+"M");break;default:_alert("错误代码："+g)}};C.on("click",function(){if(A(this).hasClass("disabled")){return false}A(this).trigger("click_",function(){if(F==="ready"){W.upload()}else{if(F==="paused"){W.upload()}else{if(F==="uploading"){W.stop()}}}})});L.on("click",".retry",function(){W.retry()});L.on("click",".ignore",function(){C.trigger("callback")});C.addClass("state-"+F);b()})})(jQuery);