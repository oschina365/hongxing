<%@ WebHandler Language="C#" Class="NSW.Web.Manager.Handler.Ajax" %>

#region namspace
using System;
using System.Collections.Generic;
using System.Web;
using System.Web.UI;
using System.Web.UI.WebControls;
using System.Text;
using NSW.Entities;
using System.Data;
using BlueCrystal.Data;
using System.Xml;
using NSW.Utls;
using System.Collections;
using System.Text.RegularExpressions;
using LitJson;
using NSW.Admin.Tools;
#endregion

#region 程序著作权以及用途
/**********************************************************************
 * 程序作者：牛商网程序部，李施霖，张鸿飞，杨军
 * 电子邮件：masterlijf@hotmail.com, likecode#qq.com
 * 公司名称：深圳市牛商网络有限公司
 * 程序书写时间：2009-2-21
 * 程序实现目的：
 * 1. 后台程序AJAX服务端代码
 **********************************************************************/
#endregion;


namespace NSW.Web.Manager.Handler
{
    public class Ajax : IHttpHandler, System.Web.SessionState.IRequiresSessionState
    {

        public void ProcessRequest(HttpContext context)
        {

            //检查来源
            if (!ComUtls.CheckPostSource())
            {
                WriteJson(false,ORes.Error.SuspiciousOfPostingSourceAndBeIgnored);
                return; 
            }
            //延时，用于客户端测试
            //System.Threading.Thread.Sleep(2000);
            if (!NSW.BLL.Admin.CheckPassport())
            {
                context.Response.Write("您尚未登录，不能操作！");
                return;
            }
            /****************************************
             * 加快方法调用响应速度，所有方法和属性尽量以静态的形式实现
             ***************************************/
            //操作
            string action = context.Request.QueryString["action"];
            switch (action)
            {
                    //获取分类图片大小
                case "getpicsize": GetColumnPicSize(); break;

                case "SendOrderDeliveriedMailNotyfi":
                    SendOrderDeliveriedMailNotyfi();
                    break;
                //发送订单已付款邮件通知
                case "SendOrderPaidMailNotyfi":
                    SendOrderPaidMailNotyfi();
                    break;
                //发送订单已取消邮件通知
                case "SendOrderCanceledMailNotyfi":
                    SendOrderCanceledMailNotyfi();
                    break;
                //发送获取产品列表通知
                case "SendGetProductByColumn":
                    SendGetProductByColumn();
                    break;
                //发送获取资讯列表通知
                case "SendGetNewsByColumn":
                    SendGetNewsByColumn();
                    break;
                //发送获取广告列表通知
                case "SendGetAdByColumn":
                    SendGetADByColumn();
                    break;
                //发送获取帮助列表通知
                case "SendGetHelpByColumn":
                    SendGetHelpByColumn();
                    break;   
                //发送获取代理商文案列表通知
                case "SendGetAgentByColumn":
                    SendGetAgentByColumn();
                    break;                                      
                //获取产品分类
                case "GetProductColumns":
                    GetProductColumns();
                    break;                    
                //获取文件内容
                case "sendGetHtmlFileNotify":
                    GetHTMLFileContent();
                    break;
                //获得定单状态的EC短信话语
                case "getOrderContent":
                    GetOrderContent();
                    break;
                //获得会员列表的EC短信话语
                case "getUserContent":
                    GetUserContent();
                    break;
                //获得EC短信会员区电话的cookies值
                case "getPhonesCookies":
                    GetPhonesCookies();
                    break;
                //设置EC短信会员区电话的cookies值
                case "setPhonesCookies":
                    SetPhonesCookies();
                    break;
                //生成会员的关键词（八爪图）
                case "SearchKeyWords": SearchKeyWords(); break;

                case "BatchAddColumn": BatchAddColumn(); break;//批量添加分类
                case "BatchTransferColumn": BatchTransferColumn(); break;//分类批量转移
                case "extensionClassification": ExtensionClassification(); break;//详细添加扩展分类
                case "cancelExtensionClassification": CancelExtensionClassification(); break;//详细取消扩展分类
                case "MassTransfer": MassTransfer(); break;
                    
                case "delete": Delete(); break;//删除
                case "getPingYing": GetPingYing(); break;//获取拼音
                case "checkFile": _CheckFile(); break;//检查是否可用
                //修改置顶字段
                case "ajaxbit": ajaxbit(); break;
                //修改排序
                case "alertOrder": alertOrder(); break;
                case "alertTitle": alertTitle(); break;
                //修改直属分类
                case "alertColumn": alertColumn(); break;
                case "updateColumn": updateColumn(); break;
                case "init_imgsize": initimgsize(); break;
                    
                /*日志 Start*/
                case "dellog": dellog(); break;//删除日志
                case "emptylog": emptylog(); break;//清空日志
                /*日志 End*/
                /*回收站操作*/
                case "recyclebin": recyclebin(); break;//还原
                //删除管理员
                case "deladmin": deladmin(); break;
                case "checkTemp": CheckTemp(); break;
                case "templateDownload": TemplateDownload(); break;
                case "delTemp": DelTemp(); break;
                case "BatchAddAdminUser": BatchAddAdminUser(); break;//添加后台管理员
                case "RightColumn": RightColumn(); break;//右边栏目操作
                case "SetTemp": SetTemp(); break;//设置默认模板
                default:
                    //WriteString("无效请求。");
                    WriteJson(false, "无效请求！");
                    break;
            }
        }
        private void SetTemp()
        {
            string type = GF("type");
            string page = GF("page");
            string diretorie = GF("diretorie");
            string operation = GF("operation");
            string types = "|product|project|agent|help|news|download|";
            string operations = "|setDefault|setTemp|";
            bool isTrue = false;
            int r = -1;
            if (!string.IsNullOrEmpty(type) && !string.IsNullOrEmpty(page) && !string.IsNullOrEmpty(diretorie) && !string.IsNullOrEmpty(operation) && types.Contains("|" + type + "|") && operations.Contains("|" + operation + "|"))
            {
                string title = "";
                bool isMobile = false;
                bool isColumn = false;
                switch (page)
                {
                    case "nvtemps":
                        title = "分类";
                        isColumn = true;
                        break;
                    case "detailedpagetemps":
                        title = "详细页";
                        break;
                    case "mobilenvtemps":
                        title = "手机分类";
                        isMobile = true;
                        isColumn = true;
                        break;
                    case "mobiledetailedpagetemps":
                        title = "手机详细页";
                        isMobile = true;
                        break;
                }
                if (!string.IsNullOrEmpty(title))
                {
                    try
                    {
                        //设置默认
                        if (operation.Equals("setDefault"))
                        {
                            if (isColumn)
                            {
                                if (isMobile)
                                {
                                    NVEngine.Tools.NewTools.SaveMobileGlobal(type + "diretorie", diretorie);
                                    isTrue = true;
                                }
                                else
                                {
                                    NVEngine.Tools.NewTools.SetAppWebConfig(type + "diretorie", diretorie);
                                    isTrue = true;
                                }
                            }
                            else
                            {
                                NSW.Web.API.ColumnType columnType = NVTools.Tools.GetColumnType(type);
                                if (isMobile)
                                {
                                    NVEngine.Tools.NewTools.SaveMobileGlobal(columnType + "TemplatePath", diretorie);
                                    isTrue = true;
                                }
                                else
                                {
                                    NVEngine.Tools.NewTools.SetAppWebConfig(columnType + "TemplatePath", diretorie);
                                    isTrue = true;
                                }
                            }
                        }
                        else {
                            //统一更新为该模板
                            int columnid = NSW.ComUtls.ParseInt(GF("columnid"), -1);
                            NSW.Web.API.ColumnType columnType = NVTools.Tools.GetColumnType(type);
                            string sp = "#$$#";
                            if (columnid > 0)
                            {
                                DataTable dt = DbSession.Default.FromSql(string.Format("select DetaiPageURL as TempPath from tb{0} where DetaiPageURL Not Like'{1}' and ColumnID={2} Group By DetaiPageURL", columnType, isMobile ? "%" + sp + diretorie : diretorie + "%", columnid)).ToDataTable();
                                if (dt.Rows.Count > 0) {
                                    List<string[]> List = new List<string[]>();
                                    foreach (DataRow row in dt.Rows)
                                    {
                                        string TempPath = row["TempPath"].ToString();
                                        string[] arr = new string[3] { TempPath, "", "" };
                                        string[] temps = null;
                                        if (!string.IsNullOrEmpty(TempPath) && (temps = NSW.Utls.StringUtls.Split(TempPath, sp)) != null && TempPath.Length > 0)
                                        {
                                            arr[1] = temps[0];
                                            if (temps.Length > 1)
                                            {
                                                arr[2] = temps[1];
                                            }
                                        }
                                        if (isMobile)
                                        {
                                            arr[2] = diretorie;
                                        }
                                        else
                                        {
                                            arr[1] = diretorie;
                                        }
                                        List.Add(arr);
                                    }
                                    
                                    StringBuilder sb = new StringBuilder();
                                    string update = string.Format("update tb{0} set DetaiPageURL='#UpdateTemp#' where DetaiPageURL='#CurTemp#' and ColumnID={1}\r\n", columnType, columnid);
                                    foreach (string[] temps in List)
                                    {
                                        sb.Append(update.Replace("#UpdateTemp#", temps[1] + sp + temps[2]).Replace("#CurTemp#", temps[0]));
                                    }
                                    if (sb.Length > 0)
                                    {
                                        r = DbSession.Default.Excute(sb.ToString());
                                    }
                                }
                                isTrue = true;
                            }
                            else
                            {
                                DataTable dt = DbSession.Default.FromSql(string.Format("select {3} as TempPath from tb{0}{1} where {3} Not Like'{2}' Group By {3}", columnType, isColumn ? "Column" : "", isMobile ? "%" + sp + diretorie : diretorie + "%", isColumn ? "TempPath" : "DetaiPageURL")).ToDataTable();
                                if (dt.Rows.Count > 0)
                                {
                                    List<string[]> List = new List<string[]>();
                                    foreach (DataRow row in dt.Rows)
                                    {
                                        string TempPath = row["TempPath"].ToString();
                                        string[] arr = new string[3] { TempPath, "", "" };
                                        string[] temps = null;
                                        if (!string.IsNullOrEmpty(TempPath) && (temps = NSW.Utls.StringUtls.Split(TempPath, sp)) != null && TempPath.Length > 0)
                                        {
                                            arr[1] = temps[0];
                                            if (temps.Length > 1)
                                            {
                                                arr[2] = temps[1];
                                            }
                                        }
                                        if (isMobile)
                                        {
                                            arr[2] = diretorie;
                                        }
                                        else
                                        {
                                            arr[1] = diretorie;
                                        }
                                        List.Add(arr);
                                    }
                                    StringBuilder sb = new StringBuilder();
                                    string update = string.Format("update tb{0}{1} set {2}='#UpdateTemp#' where {2}='#CurTemp#'\r\n", columnType, isColumn ? "Column" : "", isColumn ? "TempPath" : "DetaiPageURL");
                                    foreach (string[] temps in List)
                                    {
                                        sb.Append(update.Replace("#UpdateTemp#", temps[1] + sp + temps[2]).Replace("#CurTemp#", temps[0]));
                                    }
                                    if (sb.Length > 0)
                                    {
                                        r = DbSession.Default.Excute(sb.ToString());
                                    }
                                }
                                isTrue = true;
                            }
                        }  
                    }
                    catch (Exception ex) {
                        WriteJson(false,ex.Message);
                        return;
                    }
                }
            }
            if (isTrue)
            {
                WriteJson(isTrue, r > -1 ? "设置成功，" + r + "条数据更新成功！" : "设置成功！");
            }
            else {
                WriteJson(false, "更新失败！");
            }
        }
        private static Hashtable _ColumnListKetValueHashtable = null;
        /// <summary>
        /// 一些特殊的界面拼接分类链接的时候有问题，需要特殊处理下
        /// </summary>
        public static Hashtable ColumnListKetValueHashtable
        {
            get
            {
                if (_ColumnListKetValueHashtable == null)
                {
                    _ColumnListKetValueHashtable = new Hashtable();
                    _ColumnListKetValueHashtable.Add("new_column.aspx", "news_column.aspx");
                }
                return _ColumnListKetValueHashtable;
            }
        }
        /// <summary>
        /// 根据URL，获取分类的URL
        /// </summary>
        /// <returns></returns>
        private string GeColumnListPage()
        {
            if (HttpContext.Current.Request.UrlReferrer != null)
            {
                string url = HttpContext.Current.Request.UrlReferrer.AbsolutePath.ToLower();
                url = url.Substring(url.LastIndexOf('/') + 1);
                if (url.Contains("_column")) {
                    return url;
                }
                url = url.Replace(".aspx", string.Empty).TrimEnd('s') + "_column.aspx";
                if (ColumnListKetValueHashtable.ContainsKey(url)) {
                    return ColumnListKetValueHashtable[url] as string;
                }
                return url;
            }
            return string.Empty;
        }
        
        private void updateColumn()
        {
            int oid = ComUtls.ParseInt(GF("oid"), 0);//当前ID
            int pid = ComUtls.ParseInt(GF("pid"), 0);//其他数值
            int result = 0;
            string error = "修改失败，请稍后重试！";
            string typename = GF("typename");//类型
            string op = GF("op", "showtype");//操作

            string updateTemp = "update tb{0} set {3}={1} where id={2}";
            if (pid > 0 && oid > 0)
            {
                string url = string.Empty;
                if (!string.IsNullOrEmpty(typename))
                {
                    if (!CheckPermission(typename, BLL.Admin.AdminPermission.UpdatePermission))
                    {
                        WriteJson(false, "您没有权限！");
                        return;
                    }
                }
                else if (HttpContext.Current.Request.UrlReferrer != null)
                {
                    url = HttpContext.Current.Request.UrlReferrer.AbsolutePath;
                    url = url.Substring(url.LastIndexOf('/') + 1);
                    if (!CheckPermission(url, NSW.BLL.Admin.AdminPermission.UpdatePermission))
                    {
                        WriteJson(false, "您没有权限！");
                        return;
                    }
                }
                try
                {
                    string tips = GetTypeTitle(typename);
                    if (!string.IsNullOrEmpty(op) && !string.IsNullOrEmpty(typename))
                    {
                        switch (op) {
                            case "showtype":
                                result = DbSession.Default.Excute(string.Format(updateTemp, typename, pid, oid, op));
                                break;
                        }
                    }
                    if (result > 0)
                    {
                        AdminTools.InsertLog("修改" + tips, "ID：" + oid, true, result, UI.BasePage.RequestActions.Update, oid);
                        NVEngine.Tools.NewTools.ClearCache(typename);
                        error = "修改成功！";
                    }
                }
                catch (Exception e)
                {
                    error = e.Message;
                }
                WriteJson(result > 0, error);
            }
            else
            {
                WriteJson(false, "拉取记录出错！此记录是否已经被删除!");
            }
        }
        /// <summary>
        /// RightColumn控件
        /// </summary>
        private void RightColumn() {

            string url = GeColumnListPage();
            int oid = NSW.ComUtls.ParseInt(ClearGF("oid"), -1);
            string title = ClearGF("title").Replace("'", "''").Replace("└", "").Replace("├", "");
            string pageTitle = GetTypeTitle("") + "栏目";
            if (oid == 1) {
                WriteJson(false, "根目录无法删除！");
                return;
            }
            
            bool isAdd = oid < 1;
            string tabName = string.Empty;
            if(string.IsNullOrEmpty(url)||!CheckPermission(url, isAdd ? NSW.BLL.Admin.AdminPermission.InsertPermission : NSW.BLL.Admin.AdminPermission.UpdatePermission)){
                WriteJson(false, "您没有权限！");
                return;
            }
            if (!string.IsNullOrEmpty(tabName = GetTableName(url)))
            {
                if (isAdd)
                {
                    if (InsertHashtable.ContainsKey(tabName)) {
                        try
                        {
                            int rowsAffected = DbSession.Default.FromSql(string.Format(InsertHashtable[tabName].ToString() + ";select @@IDENTITY", title)).ToScalar<int>();
                            if (rowsAffected > 0)
                            {
                                AdminTools.InsertLog("添加" + pageTitle, title, true, rowsAffected, UI.BasePage.RequestActions.Insert, -1);
                                NVEngine.Tools.NewTools.ClearCache(tabName);
                                
                                Hashtable hash = new Hashtable();
                                hash["error"] = 1;
                                hash["oid"] = rowsAffected;
                                hash["msg"] = "添加" + pageTitle + "成功！";
                                
                                HttpContext.Current.Response.AddHeader("Content-Type", "text/html; charset=UTF-8");
                                HttpContext.Current.Response.Write(JsonMapper.ToJson(hash));
                                HttpContext.Current.Response.Flush();
                                HttpContext.Current.Response.End();
                                return;
                            }
                            else {
                                WriteJson(false, "添加" + pageTitle + "失败！");
                                return;
                            }
                        }
                        catch (Exception ex) {
                            WriteJson(false, ex.Message);
                            return;
                        }
                    }
                }
                else
                {
                    if (NSW.ComUtls.ParseBool(ClearGF("isdelete"), false))
                    {
                        if (!isAdd)
                        {
                            string delTemp = "delete {0} Where ID={1}";
                            try
                            {
                                int rowsAffected = DbSession.Default.Excute(string.Format(delTemp, tabName, oid));
                                if (rowsAffected > 0)
                                {
                                    AdminTools.InsertLog("删除" + pageTitle, title, true, rowsAffected, UI.BasePage.RequestActions.Delete, oid);
                                    NVEngine.Tools.NewTools.ClearCache(tabName);
                                    
                                    WriteJson(true, "删除" + pageTitle + "成功！");
                                    return;
                                }
                                else
                                {
                                    WriteJson(false, "删除" + pageTitle + "失败！");
                                    return;
                                }
                            }
                            catch (Exception ex)
                            {
                                WriteJson(false, ex.Message);
                                return;
                            }
                        }
                    }
                    else
                    {
                        string updateTemp = "update {0} set Title='{1}' Where ID={2}";
                        switch (tabName)
                        {
                            default:
                                try
                                {
                                    int rowsAffected = DbSession.Default.Excute(string.Format(updateTemp, tabName, title, oid));
                                    if (rowsAffected > 0)
                                    {
                                        AdminTools.InsertLog("修改" + pageTitle, title, true, rowsAffected, UI.BasePage.RequestActions.Update, oid);
                                        WriteJson(true, "修改" + pageTitle + "成功！");
                                        return;
                                    }
                                    else
                                    {
                                        WriteJson(false, "修改" + pageTitle + "失败！");
                                        return;
                                    }
                                }
                                catch (Exception ex)
                                {
                                    WriteJson(false, ex.Message);
                                    return;
                                }
                        }
                    }
                }
            }
            WriteJson(false, "参数错误！");
        }
        
        /// <summary>
        /// 批量添加admin
        /// </summary>
        private void BatchAddAdminUser()
        {
            string username = GF("username").Trim();
            string password = GF("password").Trim();
             if (!CheckPermission("admin", BLL.Admin.AdminPermission.InsertPermission))
            {
                WriteJson(false, "您没有权限添加数据！");
                return;
            }else if (string.IsNullOrEmpty(username) || string.IsNullOrEmpty(password)) {
                WriteJson(false, "输入字符不能为空！");
                return;
            }
            if (DbSession.Default.Exists<tbAdmin>(tbAdmin._.UserName == username))
            {
                WriteJson(false, "用户名已存在，更新管理员失败。");
                return;
            }
            DateTime DateTimeNow = DateTime.Now;
            tbAdmin admin = new tbAdmin();
            admin.UserName = username;
            admin.UserPassword = StringUtls.MD5(password);
            admin.LastIP = IP;
            admin.isSystem = false;
            admin.InputTime = DateTimeNow;
            admin.LastLogin = DateTimeNow;
            admin.ModelAuth = "1";
            admin.MPhone = admin.Question = admin.Answer = admin.ChnName = admin.Department = admin.ShortDesc = admin.UserEmail = "";
            admin.Authority = "1-1";
            admin.CurrentAuth = 1;
            admin.Enable = true;
            admin.UserLogins = 0;
            int rowsAffected= DbSession.Default.Save<tbAdmin>(admin);
            if (rowsAffected > 0)
            { WriteJson(true, "管理员“" + username + "”添加成功！"); }
            else { WriteJson(false, "管理员“" + username + "”添加失败！"); }
        }
        
        /// <summary>
        /// 检查模版是否已经存在
        /// </summary>
        private void CheckTemp() {
            string type = ClearGF("type").ToLower();
            int tempID = NSW.ComUtls.ParseInt(ClearGF("tempid"), -1);
            string path = ClearGF("page").ToLower();
            if (string.IsNullOrEmpty(path))
            {
                path = "nvtemps";
            }
            if (tempID > 0&&!string.IsNullOrEmpty(type)&&"|project|product|news|agent|help|".Contains(type)) {
                string tabName = string.Empty;
                string _path = HttpContext.Current.Server.MapPath(NVTools.NTools.GetTemplateByPage(path, NVTools.Tools.GetColumnType(type), tempID, ref tabName));
                
                if (System.IO.Directory.Exists(_path))
                {
                    WriteJson(true, "文件夹已存在");
                    return;
                }
                WriteJson(false, "文件夹不存在");
                return;
            }
            WriteJson(false, "参数错误");
            return;
        }

        private static Regex NumberRegex = new Regex("[1-9][0-9]*");
        /// <summary>
        /// 删除模板
        /// </summary>
        private void DelTemp()
        {
            string type = ClearGF("type").ToLower();
            string path = ClearGF("page").ToLower();
            string diretorie = ClearGF("diretorie").ToLower();
            if (!string.IsNullOrEmpty(type) && !string.IsNullOrEmpty(diretorie) && diretorie[0].Equals('v') && "|project|product|news|agent|help|".Contains(type))
            {
                string tabName = string.Empty;
                Match mc = NumberRegex.Match(diretorie);
                if (mc.Success)
                {
                    int tempID = NSW.ComUtls.ParseInt(mc.Groups[0].Value, -1);
                    if (tempID > 0) {
                        string _path = HttpContext.Current.Server.MapPath(NVTools.NTools.GetTemplateByPage(path, NVTools.Tools.GetColumnType(type), tempID, ref tabName));
                        if (System.IO.Directory.Exists(_path))
                        {
                            try
                            {
                                System.IO.Directory.Delete(_path, true);
                                WriteJson(true, "删除成功！");
                            }
                            catch (Exception e) {
                                WriteJson(false, e.Message);
                            }
                        }
                    }
                }
            }
            WriteJson(false, "参数错误");
        }
        
        
        /// <summary>
        /// 下载模版
        /// </summary>
        private void TemplateDownload() {
            string type = ClearGF("type").ToLower();
            int tempID = NSW.ComUtls.ParseInt(ClearGF("tempid"), -1);
            string path = ClearGF("page").ToLower();
            if (string.IsNullOrEmpty(path)) {
                path = "nvtemps";
            }
            if (tempID > 0 && !string.IsNullOrEmpty(type) && "|project|product|news|agent|help|".Contains(type))
            {
                NVTools.NTools.TemplateDownload(path, NVTools.Tools.GetColumnType(type), tempID);
                return;
            }
            WriteJson(false, "参数错误");
        }
        
        //删除文件
        private void DeleteFile(string file) {
            string path = string.Empty;
            if (System.IO.File.Exists((path = HttpContext.Current.Server.MapPath(file))))
            {
                if (path.EndsWith(".html"))
                {
                    System.IO.File.Delete(path);
                }

                //file = file.ToLower();
                //if (!file.EndsWith(".html"))
                //{
                //    DbSession.Default.From<tbPicture>().Where(tbPicture._.Path == file);
                //}
            }
        }
        
        //删除回收站
        private void recyclebin()
        {
            string type = ClearGF("type").Trim().ToLower(),
               cmd = QS("cmd").Trim().ToLower();
            int oid = NSW.ComUtls.ParseInt(ClearGF("oid").Trim(), -1);
            if (string.IsNullOrEmpty(type) || string.IsNullOrEmpty(cmd) || oid < 1) {
                WriteJson(false, "无效参数！");
                return;
            }
            if (cmd.Equals("completelyDelete") && !CheckPermission(type, BLL.Admin.AdminPermission.DelPermission))
            {
                WriteJson(false, "您没有权限删除！");
                return;
            }
            if (cmd.Equals("reduction") && !CheckPermission(type, BLL.Admin.AdminPermission.UpdatePermission))
            {
                WriteJson(false, "您没有权限修改！");
                return;
            }
            int rowsAffected = -1;
            string title = string.Empty;
            List<string> files = new List<string>();

            string tips = GetTypeTitle(type);
            if (cmd.Equals("completelydelete"))
            {
                switch (type)
                {
                    case "news":
                        tbNews news = DbSession.Default.Get<tbNews>(oid);
                        if (news!=null&&news.isDelete == true)
                        {
                            title = news.Title;
                            files.Add(news.PhotoPath);
                            files.Add(news.FirstPage);
                            rowsAffected = DbSession.Default.Delete(news);
                        }
                        break;
                    case "agent":
                        tbAgent agent = DbSession.Default.Get<tbAgent>(oid);
                        if (agent != null && agent.isDelete == true)
                        {
                            title = agent.Title;
                            files.Add(agent.PhotoPath);
                            files.Add(agent.FirstPage);
                            rowsAffected = DbSession.Default.Delete(agent);
                        }
                        break;
                    case "help":
                        tbHelp help = DbSession.Default.Get<tbHelp>();
                        if (help != null && help.isDelete == true)
                        {
                            title = help.Title;
                            files.Add(help.PhotoPath);
                            files.Add(help.FirstPage);
                            rowsAffected = DbSession.Default.Delete(help);
                        }
                        break;
                    case "product":
                        tbProduct product = DbSession.Default.Get<tbProduct>(oid);
                        if (product != null && product.isDelete == true)
                        {
                            title = product.Title;
                            files.Add(product.PhotoPath);
                            files.Add(product.FirstPage);
                            files.Add(product.OtherPhotos);
                            rowsAffected = DbSession.Default.Delete(product);
                        }
                        break;
                    case "project":
                        tbProject project = DbSession.Default.Get<tbProject>(oid);
                        if (project != null && project.isDelete == true)
                        {
                            title = project.Title;
                            files.Add(project.PhotoPath);
                            files.Add(project.FirstPage);
                            files.Add(project.OtherPhotos);
                            rowsAffected = DbSession.Default.Delete(project);
                        }
                        break;
                }
                if (rowsAffected > 0)
                {
                    AdminTools.InsertLog("删除" + tips, title, true, rowsAffected, UI.BasePage.RequestActions.Delete, oid);
                    string path = string.Empty;
                    foreach (string file in files) {
                        if (!string.IsNullOrEmpty(file)) {
                            //$#$/uploadfiles/pictures/product/20150514190226_6544.jpg||1罗建刚$#$/uploadfiles/pictures/product/20150515091555_2968.jpg||1罗建刚$#$/uploadfiles/pictures/product/20150515091609_1406.jpg||1罗建刚$#$/uploadfiles/pictures/product/20150515140714_2656.jpg||1罗建刚$#$
                            if (file.IndexOf("||") > 0)
                            {
                                string[] arr = NSW.Utls.StringUtls.Split(file, "$#$");
                                if (arr != null && arr.Length > 0)
                                {
                                    foreach(string str in arr){
                                        if (!string.IsNullOrEmpty(str)) {
                                            string[] values = NSW.Utls.StringUtls.Split(str, "||");
                                            if (values != null && values.Length > 0) {
                                                DeleteFile(values[0]);
                                            }
                                        }
                                    }
                                }
                            }
                            else {
                                DeleteFile(file);
                            }
                        }
                    }
                    WriteJson(true, "彻底删除" + tips + "成功！");
                    return;
                }
                else {
                    WriteJson(false, "彻底删除" + tips + "成功！");
                    return;
                }
            }
            if (cmd.Equals("reduction"))
            {
                switch (type)
                {
                    case "news":
                        tbNews news = DbSession.Default.Get<tbNews>(oid);
                        if (news != null && news.isDelete == true)
                        {
                            title = news.Title;
                            news.Attach();
                            news.isDelete = false;
                            rowsAffected = DbSession.Default.Save<tbNews>(news);
                        }
                        break;
                    case "agent":
                        tbAgent agent = DbSession.Default.Get<tbAgent>(oid);
                        if (agent != null && agent.isDelete == true)
                        {
                            title = agent.Title;
                            agent.Attach();
                            agent.isDelete = false;
                            rowsAffected = DbSession.Default.Save<tbAgent>(agent);
                        }
                        break;
                    case "help":
                        tbHelp help = DbSession.Default.Get<tbHelp>(oid);
                        if (help != null && help.isDelete == true)
                        {
                            title = help.Title;
                            help.Attach();
                            help.isDelete = false;
                            rowsAffected = DbSession.Default.Save<tbHelp>(help);
                        }
                        break;
                    case "product":
                        tbProduct product = DbSession.Default.Get<tbProduct>(oid);
                        if (product != null && product.isDelete == true)
                        {
                            title = product.Title;
                            product.Attach();
                            product.isDelete = false;
                            rowsAffected = DbSession.Default.Save<tbProduct>(product);
                        }
                        break;
                    case "project":
                        tbProject project = DbSession.Default.Get<tbProject>(oid);
                        if (project != null && project.isDelete == true)
                        {
                            title = project.Title;
                            project.Attach();
                            project.isDelete = false;
                            rowsAffected = DbSession.Default.Save<tbProject>(project);
                        }
                        break;
                }
                if (rowsAffected > 0)
                {
                    AdminTools.InsertLog("还原" + tips, title, true, rowsAffected, UI.BasePage.RequestActions.Update, oid);
                    NVEngine.Tools.NewTools.ClearCache(type);
                    
                    WriteJson(true, "还原" + tips + "成功！");
                    return;
                }
                else {
                    WriteJson(false, "还原" + tips + "失败！");
                }
            }
            WriteJson(false, "无效参数！");
        }
        
        /// <summary>
        /// 删除帐号
        /// </summary>
        private void deladmin()
        {
            string ids = ClearGF("ids").Trim();
            string type = ClearGF("type").Trim().ToLower();

            if (!ComUtls.CheckIDsFormat(ids))
            {
                WriteJson(false, "数据格式化错误，请刷新后重试！");
                return;
            }

            else if (!CheckPermission(type, BLL.Admin.AdminPermission.DelPermission))
            {
                WriteJson(false, "您没有权限删除！");
                return;
            }
            string sqlWhere = string.Format("{0} IN({1}) AND [isSystem] <> 1", "ID", ids);

            int rowsAffected = DbSession.Default.Excute(string.Format("DELETE FROM {0} WHERE {1}", "[tbAdmin]", sqlWhere));
            AdminTools.InsertLog("删除帐户", ids, false, rowsAffected, UI.BasePage.RequestActions.Delete, 0);
            //InsertLog(ItemName, "<i>null</i>", false, rowsAffected, RequestActions.Delete);
            WriteJson(true, "删除成功！");
            
        }
        
        /// <summary>
        /// 检查是否已有相似的
        /// </summary>
        /// <param name="hidfile">已存在的</param>
        /// <param name="sou">新的</param>
        /// <param name="type">product,productcolumn等等...</param>
        /// <returns></returns>
        private bool __CheckFile(string hidfile, string py, string type)
        {
            if (TypeTitle.ContainsKey(type) && !string.IsNullOrEmpty(py))
            {
                if (hidfile.Equals(py))
                {
                    return true;
                }
                if (type.EndsWith("column"))
                {
                    //分类
                    int i = DbSession.Default.Count<tbExpandURL>(tbExpandURL._.ExpandURL == py);
                    if (i == 0)
                    {
                        return true;
                    }
                }
                else {
                    //详细页
                    string path = "/" + (type.Equals("news") ? "article" : type + "s") + "/" + py + ".html";
                    if (!System.IO.File.Exists(HttpContext.Current.Server.MapPath(path))) {
                        return true;
                    }
                }
            }
            return false;
        }
        /*检查并且加_1*/
        /// <summary>
        /// 检查静态文件是否已经存在
        /// </summary>
        private void _CheckFile()
        {
            string hidfile = HttpUtility.UrlDecode(GetUrlParams("hidfile", ""));
            string py = HttpUtility.UrlDecode(GetUrlParams("py", ""));
            string type = GF("type").ToLower().Trim();
            WriteJson(true, __CheckFile(hidfile, py, type).ToString().ToLower());
        }

        private static Regex Page = new Regex(@"^\S*(_(\d*))$");
        /// <summary>
        /// 检查静态文件是否已经存在,如果存在就+_1
        /// </summary>
        /// <param name="hidfile">原来的</param>
        /// <param name="py">新的</param>
        /// <param name="type">product,productcolumn等等...</param>
        /// <returns></returns>
        private string RecursiveFileName(string hidfile, string py, string type,string allpy)
        {
            if (__CheckFile(hidfile, py, type)) {
                return py;
            }
            if (allpy.Length > py.Length)
            {
                py = allpy.Substring(0, py.Length + 1);
            }
            else {
                Match mc = Page.Match(py);
                int count = -1;
                if (mc.Success && mc.Groups.Count > 2 && (count = NSW.ComUtls.ParseInt(mc.Groups[2].Value.TrimStart('0'), count)) > 0)
                {
                    py = py.Replace(mc.Groups[1].Value, "_" + (count + 1).ToString().PadLeft(2, '0'));
                }
                else
                {
                    py += "_1";
                }
            }
            return RecursiveFileName(hidfile, py, type, allpy);
        }
        
        /// <summary>
        /// 获取拼音
        /// </summary>
        private void GetPingYing()
        {
            string title = HttpUtility.UrlDecode(GetUrlParams("title", ""));
            string hidfile = HttpUtility.UrlDecode(GetUrlParams("hidfile", ""));
            string type = GF("type").ToLower().Trim();
            int pylength = NSW.ComUtls.ParseInt(GF("pylength"), 10);
            if (TypeTitle.ContainsKey(type) && !string.IsNullOrEmpty(title))
            {
                string py = NSW.Admin.Tools.StrToPinyin.GetChineseSpell(title).Trim();
                string allpy = py;
                if (py.Length > pylength){
                    py = py.Substring(0, pylength);
                }
                WriteJson(true, RecursiveFileName(hidfile, py, type, allpy));
            }
            WriteJson(false, "无效参数！");
        }

        /// <summary>
        /// 清空日志
        /// </summary>
        private void emptylog()
        {
            string type = ClearGF("type").Trim().ToLower(),
                isbak = ClearGF("cmd").Trim().ToLower(),
                bakPath = "/UploadFiles/WebLog/" + DateTime.Now.ToString("yyyy-MM-dd") + ".csv";
            string AbsolutebakPath = IOUtls.GetMapPath(bakPath);
            if (isbak != "export" &&isbak != "del") //如果不是导出也不是删除
            {
                if (IOUtls.IsExist(AbsolutebakPath, IOUtls.FsoMethod.File))
                {
                    WriteJson(true, "");
                    return;
                }
                else
                {
                    WriteJson(false, "");
                    return;
                }
            }
            else if (isbak == "del")
            {
                //判断权限
                if (!CheckPermission(type, BLL.Admin.AdminPermission.DelPermission))
                {
                    WriteJson(false, "您没有权限删除！");
                    return;
                }
                //导出日志
                AbsolutebakPath = GetLogFile(bakPath);
                int rowsAffected = DbSession.Default.Delete<tbSystemLog>(new WhereClip(" 1=1 "));
                AdminTools.InsertLog("删除日志", "<i>清空表tbSystemLog</i>", false, rowsAffected, UI.BasePage.RequestActions.Delete,-1);
                WriteJson(true, bakPath);
                return;
            }
            else if (isbak == "export")
            {
                AbsolutebakPath = GetLogFile(bakPath);
                if (!string.IsNullOrEmpty(AbsolutebakPath))
                {
                    WriteJson(true, bakPath);
                    return;
                }      
            }
            WriteJson(false, "参数不正确或服务器内部错误！！");
        }
        
        /// <summary>
        /// 删除后并下载日志文件
        /// </summary>
        /// <param name="bakPath">路径</param>
        /// <returns></returns>
        private string GetLogFile(string bakPath)
        {
            bakPath = IOUtls.GetMapPath(bakPath);
            if (IOUtls.IsExist(bakPath, IOUtls.FsoMethod.File))//如果存在,可以删除,删除后并下载日志文件
            {
                return bakPath;
            }
            DataTable dt = DbSession.Default.From<tbSystemLog>().OrderBy(tbSystemLog._.ID.Desc).ToDataTable();
            string titlename = "序号,操作人,操作对象,具体操作,操作IP,操作时间";
            //string filedname = "ID,ColumnName,UserName,ShortDesc,LastIP,InputTime";
            StringBuilder sb = new StringBuilder();
            sb.AppendLine(titlename);
            if (dt != null && dt.Rows.Count > 0)
            {
                foreach (DataRow item in dt.Rows)
                {
                    sb.AppendLine(item["ID"].ToString() + "," +
                        item["UserName"].ToString() + "," +
                        item["ColumnName"].ToString() + "," +
                        //剔除换行,制表符,逗号
                        item["ShortDesc"].ToString().Replace("\r\n", "　　").Replace("\t\t", "　").Replace(",","，") + "," +
                        item["LastIP"].ToString() + "," +
                        item["InputTime"].ToString());
                }

                int pos = bakPath.LastIndexOf("\\");
                string file = bakPath.Substring(0, pos);
                if (!System.IO.Directory.Exists(file))
                {
                    System.IO.Directory.CreateDirectory(file);
                }

                System.IO.StreamWriter sw = new System.IO.StreamWriter(bakPath, true, Encoding.UTF8);
                sw.Write(sb.ToString());
                sw.Dispose();
                sw.Close();
                return bakPath;
            }
            return "";
        }
        
        /// <summary>
        /// 删除日志
        /// </summary>
        private void dellog()
        {
            string ids = ClearGF("ids").Trim();
            string type = ClearGF("type").Trim().ToLower();

            if (!ComUtls.CheckIDsFormat(ids))
            {
                WriteJson(false, "数据格式化错误，请刷新后重试！");
                return;
            }
            else if (!CheckPermission(type, BLL.Admin.AdminPermission.DelPermission))
            {
                WriteJson(false, "您没有权限删除！");
                return;
            }

            string sqlWhere = string.Format("{0} IN({1})", "ID", ids);

            int rowsAffected = DbSession.Default.Excute(string.Format("DELETE FROM {0} WHERE {1}", "[tbSystemLog]", sqlWhere));
            AdminTools.InsertLog("删除日志", ids, false, rowsAffected, UI.BasePage.RequestActions.Delete, 0);
            //InsertLog(ItemName, "<i>null</i>", false, rowsAffected, RequestActions.Delete);
            WriteJson(true, "删除成功！");
        }
        
        /// <summary>
        /// 删除
        /// </summary>
        private void Delete()
        {
            string type = GF("type").Trim().ToLower();
            int oid = NSW.ComUtls.ParseInt(GF("oid"), -1);
            if (oid < 1) {
                WriteJson(false, "无效参数！");
                return;
            }
            if (string.IsNullOrEmpty(type) || oid < 1)
            {
                WriteJson(false, "无效参数！");
                return;
            }
            List<string> imgs = new List<string>();

            if (type.EndsWith("column") && oid == 1) {
                WriteJson(false, "根目录无法删除！");
            }
            int rowsAffected = 0;
            string Title = string.Empty;
            string tips = GetTypeTitle(type);

            string url = string.Empty;
            string ExpandURL = string.Empty;
            if (!CheckPermission(type, BLL.Admin.AdminPermission.DelPermission))
            {
                WriteJson(false, "您没有权限删除！");
                return;
            }
            if (!string.IsNullOrEmpty(type))
            {
                switch (type)
                {
                    /*单篇*/
                    case "product":
                        tbProduct product = DbSession.Default.Get<tbProduct>(oid);
                        if (product == null)
                        {
                            WriteJson(false, tips + "不存在！");
                            return;
                        }
                        product.Attach();
                        product.DeleteTime = DateTime.Now;
                        product.isDelete = true;
                        Title = product.Title;
                        rowsAffected = DbSession.Default.Save<tbProduct>(product);
                        break;
                    case "project":
                        tbProject project = DbSession.Default.Get<tbProject>(oid);
                        if (project == null)
                        {
                            WriteJson(false, tips + "不存在！");
                            return;
                        }
                        project.Attach();
                        project.DeleteTime = DateTime.Now;
                        project.isDelete = true;
                        Title = project.Title;
                        rowsAffected = DbSession.Default.Save<tbProject>(project);
                        break;
                    case "news":
                        tbNews news = DbSession.Default.Get<tbNews>(oid);
                        if (news == null)
                        {
                            WriteJson(false, tips + "不存在！");
                            return;
                        }
                        news.Attach();
                        news.DeleteTime = DateTime.Now;
                        news.isDelete = true;
                        Title = news.Title;
                        rowsAffected = DbSession.Default.Save<tbNews>(news);
                        break;
                    case "agent":
                        tbAgent agent = DbSession.Default.Get<tbAgent>(oid);
                        if (agent == null)
                        {
                            WriteJson(false, tips + "不存在！");
                            return;
                        }
                        agent.Attach();
                        agent.DeleteTime = DateTime.Now;
                        agent.isDelete = true;
                        Title = agent.Title;
                        rowsAffected = DbSession.Default.Save<tbAgent>(agent);
                        break;
                    case "help":
                        tbHelp help = DbSession.Default.Get<tbHelp>(oid);
                        if (help == null)
                        {
                            WriteJson(false, tips + "不存在！");
                            return;
                        }
                        help.Attach();
                        help.DeleteTime = DateTime.Now;
                        help.isDelete = true;
                        Title = help.Title;
                        rowsAffected = DbSession.Default.Save<tbHelp>(help);
                        break;
                    case "download":
                        tbDownload download = DbSession.Default.Get<tbDownload>(oid);
                        if (download == null)
                        {
                            WriteJson(false, tips + "不存在！");
                            return;
                        }
                        download.Attach();
                        download.DeleteTime = DateTime.Now;
                        download.isDelete = true;
                        Title = download.Title;
                        rowsAffected = DbSession.Default.Save<tbDownload>(download);
                        break;

                    /*分类*/
                    case "productcolumn":
                        tbProductColumn productColumn = DbSession.Default.Get<tbProductColumn>(oid);
                        if (productColumn == null)
                        {
                            WriteJson(false, tips + "不存在！");
                            return;
                        }
                        ExpandURL = productColumn.ExpandURL;
                        Title = productColumn.Title;
                        rowsAffected = DbSession.Default.Delete<tbProductColumn>(productColumn);
                        DbSession.Default.Excute("update tbProduct set ColumnID=1 where ColumnID=" + productColumn.ID);
                        break;
                    case "projectcolumn":
                        tbProjectColumn projectcolumn = DbSession.Default.Get<tbProjectColumn>(oid);
                        if (projectcolumn == null)
                        {
                            WriteJson(false, tips + "不存在！");
                            return;
                        }
                        ExpandURL = projectcolumn.ExpandURL;
                        Title = projectcolumn.Title;
                        rowsAffected = DbSession.Default.Delete<tbProjectColumn>(projectcolumn);
                        DbSession.Default.Excute("update tbProject set ColumnID=1 where ColumnID=" + projectcolumn.ID);
                        break;
                    case "newscolumn":
                        tbNewsColumn newscolumn = DbSession.Default.Get<tbNewsColumn>(oid);
                        if (newscolumn == null)
                        {
                            WriteJson(false, tips + "不存在！");
                            return;
                        }
                        ExpandURL = newscolumn.ExpandURL;
                        Title = newscolumn.Title;
                        rowsAffected = DbSession.Default.Delete<tbNewsColumn>(newscolumn);
                        DbSession.Default.Excute("update tbNews set ColumnID=1 where ColumnID=" + newscolumn.ID);
                        break;
                    case "helpcolumn":
                        tbHelpColumn helpcolumn = DbSession.Default.Get<tbHelpColumn>(oid);
                        if (helpcolumn == null)
                        {
                            WriteJson(false, tips + "不存在！");
                            return;
                        }
                        ExpandURL = helpcolumn.ExpandURL;
                        Title = helpcolumn.Title;
                        rowsAffected = DbSession.Default.Delete<tbHelpColumn>(helpcolumn);
                        DbSession.Default.Excute("update tbHelp set ColumnID=1 where ColumnID=" + helpcolumn.ID);
                        break;
                    case "agentcolumn":
                        tbAgentColumn agentcolumn = DbSession.Default.Get<tbAgentColumn>(oid);
                        if (agentcolumn == null)
                        {
                            WriteJson(false, tips + "不存在！");
                            return;
                        }
                        ExpandURL = agentcolumn.ExpandURL;
                        Title = agentcolumn.Title;
                        rowsAffected = DbSession.Default.Delete<tbAgentColumn>(agentcolumn);
                        DbSession.Default.Excute("update tbAgent set ColumnID=1 where ColumnID=" + agentcolumn.ID);
                        break;
                    case "downloadcolumn":
                        tbDownloadColumn downloadcolumn = DbSession.Default.Get<tbDownloadColumn>(oid);
                        if (downloadcolumn == null)
                        {
                            WriteJson(false, tips + "不存在！");
                            return;
                        }
                        ExpandURL = downloadcolumn.ExpandURL;
                        Title = downloadcolumn.Title;
                        rowsAffected = DbSession.Default.Delete<tbDownloadColumn>(downloadcolumn);
                        DbSession.Default.Excute("update tbDownload set ColumnID=1 where ColumnID=" + downloadcolumn.ID);
                        break;
                    case "productattributecolumn":
                        tbProductAttributeColumn productattributecolumn = DbSession.Default.Get<tbProductAttributeColumn>(oid);
                        if (productattributecolumn == null)
                        {
                            WriteJson(false, tips + "不存在！");
                            return;
                        }
                        Title = productattributecolumn.Title;
                        rowsAffected = DbSession.Default.Delete<tbProductAttributeColumn>(productattributecolumn);
                        break;
                    case "projectattributecolumn":
                        tbProjectAttributeColumn projectattributecolumn = DbSession.Default.Get<tbProjectAttributeColumn>(oid);
                        if (projectattributecolumn == null)
                        {
                            WriteJson(false, tips + "不存在！");
                            return;
                        }
                        Title = projectattributecolumn.Title;
                        rowsAffected = DbSession.Default.Delete<tbProjectAttributeColumn>(projectattributecolumn);
                        break;
                    case "admin_systemmenu":
                        if (oid == 1) {
                            WriteJson(false, tips + "根目录不能删！");
                            return;
                        }
                        tbSystemMenu men = DbSession.Default.Get<tbSystemMenu>(oid);
                        if (men == null)
                        {
                            WriteJson(false, tips + "不存在！");
                            return;
                        }
                        Title = men.Title;
                        rowsAffected = DbSession.Default.Delete<tbSystemMenu>(men);
                        break;
                }
            }
            else {
                if (!string.IsNullOrEmpty(url) && !string.IsNullOrEmpty(type = GetTableName(url)))
                {
                    rowsAffected = DbSession.Default.Excute(string.Format("delete {0} where id={1}", type, oid));
                }
            }
            if (rowsAffected > 0)
            {
                if (!string.IsNullOrEmpty(ExpandURL))
                {
                    DbSession.Default.Delete<tbExpandURL>(tbExpandURL._.ExpandURL == ExpandURL);
                }
                AdminTools.InsertLog("删除" + tips, Title, true, rowsAffected, UI.BasePage.RequestActions.Delete, oid);
                NVEngine.Tools.NewTools.ClearCache(type);
                WriteJson(true, "删除" + tips + "成功！");
            }
            else {
                WriteJson(false, "删除" + tips + "失败，请稍后重试！");
            }
            WriteJson(false, "参数错误！");
        }
        
        /// <summary>
        /// 详细批量添加扩展分类
        /// </summary>
        private void ExtensionClassification()
        {
            string ids = GF("ids").TrimEnd(',');
            string type = GF("typename").ToLower();
            string cid = GF("cid");
            int ColumnID = 0;
            if (AdminTools.CheckSIDFormat(cid))
            {
                ColumnID = AdminTools.GetColumnIDBySID(cid);
            }
            else
            {
                ColumnID = NSW.ComUtls.ParseInt(cid, -1);
            }
            if (string.IsNullOrEmpty(type) || string.IsNullOrEmpty(ids) || ColumnID < 1) {
                WriteJson(false, "参数错误！");
                return;
            }
            int max = 0;
            if (!CheckPermission(type, BLL.Admin.AdminPermission.UpdatePermission))
            {
                WriteJson(false, "您没有修改权限！");
                return;
            }
            
            string tips = GetTypeTitle(type);
            switch (type) {
                case "product": max = DbSession.Default.Excute(string.Format("update tbProduct set OtherColumns=Replace(OtherColumns+'{0}'+'$$','$$$$','$$') where OtherColumns not like'%$${0}$$%' and id in({1})", ColumnID, ids)); break;
                case "project": max = DbSession.Default.Excute(string.Format("update tbProject set OtherColumns=Replace(OtherColumns+'{0}'+'$$','$$$$','$$') where OtherColumns not like'%$${0}$$%' and id in({1})", ColumnID, ids)); break;
            }
            if (max > 0)
            {
                AdminTools.InsertLog("批量添加" + tips + "扩展分类", ids, false, max, UI.BasePage.RequestActions.Update, -1);
                NVEngine.Tools.NewTools.ClearCache(type);
                
                WriteJson(true, max + "条产品更新了扩展分类！");
            }
            else {
                WriteJson(false, "无可更新产品！");
            }
        }
        private void MassTransfer() {
            string ids = GF("ids").TrimEnd(',').Replace(";", "").Replace("'", "").Replace("\r\n", "").Replace("go", "");
            string cid = GF("cid");
            int ColumnID = 0;
            if (AdminTools.CheckSIDFormat(cid))
            {
                ColumnID = AdminTools.GetColumnIDBySID(cid);
            }
            else
            {
                ColumnID = NSW.ComUtls.ParseInt(cid, -1);
            }
            if (string.IsNullOrEmpty(ids) || ColumnID < 1)
            {
                WriteJson(false, "参数错误！");
                return;
            }

            int max = 0;
            string url = HttpContext.Current.Request.UrlReferrer.AbsolutePath;
            url = url.Substring(url.LastIndexOf('/') + 1);
            if (!CheckPermission(url, NSW.BLL.Admin.AdminPermission.UpdatePermission))
            {
                WriteJson(false, "您没有权限！");
                return;
            }
            string tabName = GetTableName(url);
            if (!string.IsNullOrEmpty(tabName)) {
                object s = DbSession.Default.FromSql(string.Format("select top 1 ID from {0}Column where ID={1}", tabName, ColumnID)).ToScalar();
                if (s != null)
                {
                    max = DbSession.Default.Excute(string.Format("update {0} set ColumnID={1} where ID in({2})", tabName, s, ids));
                }
            }
            if (max > 0) {
                AdminTools.InsertLog("批量转移" + tabName + "分类", ids, false, max, UI.BasePage.RequestActions.Update, ColumnID);
                NVEngine.Tools.NewTools.ClearCache(tabName);
                WriteJson(true, max + "条记录更新成功！");
                return;
            }
            WriteJson(false, "参数错误！");
        }
        /// <summary>
        /// 详细批量取消扩展分类
        /// </summary>
        private void CancelExtensionClassification()
        {
            string ids = GF("ids").TrimEnd(',');
            string type = GF("typename").ToLower();
            string cid = GF("cid");
            int ColumnID = 0;
            if (AdminTools.CheckSIDFormat(cid))
            {
                ColumnID = AdminTools.GetColumnIDBySID(cid);
            }
            else
            {
                ColumnID = NSW.ComUtls.ParseInt(cid, -1);
            }
            if (string.IsNullOrEmpty(type) || string.IsNullOrEmpty(ids) || ColumnID < 1)
            {
                WriteJson(false, "参数错误！");
                return;
            }
            int max = 0;
            if (!CheckPermission(type, BLL.Admin.AdminPermission.UpdatePermission))
            {
                WriteJson(false, "您没有权限修改！");
                return;
            }

            string tips = GetTypeTitle(type);
            switch (type)
            {
                case "product": max = DbSession.Default.Excute(string.Format("update tbProduct set OtherColumns=Replace(OtherColumns,'$${0}$$','$$')  where OtherColumns like'%$${0}$$%' and id in({1})", ColumnID, ids)); break;
                case "project": max = DbSession.Default.Excute(string.Format("update tbProject set OtherColumns=Replace(OtherColumns,'$${0}$$','$$') where OtherColumns like'%$${0}$$%' and id in({1})", ColumnID, ids)); break;
            }
            if (max > 0)
            {
                AdminTools.InsertLog("批量取消" + tips + "扩展分类", ids, false, max, UI.BasePage.RequestActions.Update, -1);
                NVEngine.Tools.NewTools.ClearCache(type);
                
                WriteJson(true, max + "条产品取消了扩展分类！");
            }
            else
            {
                WriteJson(false, "无可更新产品！");
            }
        }
        
        /// <summary>
        /// 分类批量转移分类
        /// </summary>
        private void BatchTransferColumn()
        {
            string type = GF("typename").ToLower();
            string cid = GF("cid");
            string columns = GF("columns").Replace("'", "”");
            
            int ColumnID = -1;
            string[] arr = null;
            if (AdminTools.CheckSIDFormat(cid))
            {
                ColumnID = AdminTools.GetColumnIDBySID(cid);
            }
            else
            {
                ColumnID = NSW.ComUtls.ParseInt(cid, -1);
            }
            if (ColumnID > 0 && !string.IsNullOrEmpty(columns) && (arr = ComUtls.SplitByEnter(columns)) != null && arr.Length > 0)
            {
                if (!CheckPermission(type, BLL.Admin.AdminPermission.UpdatePermission))
                {
                    WriteJson(false, "您没有权限修改！");
                    return;
                }
                string sql = string.Empty;
                int max = 0;
                string sid = string.Empty;
                string ids = string.Empty;
                string tips = GetTypeTitle(type);
                try
                {
                    switch (type)
                    {
                        /*分类处理*/
                        case "productcolumn":
                            VW_ProductColumn productColumn = DbSession.Default.From<VW_ProductColumn>().Where(VW_ProductColumn._.ID == ColumnID).Select(VW_ProductColumn._.sid, VW_ProductColumn._.ID).ToFirst();
                            if (productColumn == null)
                            {
                                throw new Exception("分类不存在！");
                            }
                            List<tbProductColumn> tbProductColumns = DbSession.Default.From<tbProductColumn>().Where(tbProductColumn._.Enable == true && tbProductColumn._.Title.In(arr)).ToList<tbProductColumn>() as List<tbProductColumn>;
                            sid = "," + productColumn.sid + ",";
                            ids = "";
                            foreach (tbProductColumn pColumn in tbProductColumns)
                            {
                                if (!sid.Contains("," + pColumn.ID.ToString().PadLeft(4, '0') + ",")) {
                                    ids += pColumn.ID + ",";
                                }
                            }
                            ids = ids.Trim(',');
                            if (!string.IsNullOrEmpty(ids)) {
                                max = DbSession.Default.Excute(string.Format("updata tbProductColumn set ParentID={0} where ID in({1})", productColumn.ID, ids));
                            }
                            break;
                        case "projectcolumn":
                            VW_ProjectColumn projectColumn = DbSession.Default.From<VW_ProjectColumn>().Where(VW_ProjectColumn._.ID == ColumnID).Select(VW_ProjectColumn._.sid, VW_ProjectColumn._.ID).ToFirst();
                            if (projectColumn == null)
                            {
                                throw new Exception("分类不存在！");
                            }
                            List<tbProjectColumn> tbProjectColumns = DbSession.Default.From<tbProjectColumn>().Where(tbProjectColumn._.Enable == true && tbProjectColumn._.Title.In(arr)).ToList<tbProjectColumn>() as List<tbProjectColumn>;
                            sid = "," + projectColumn.sid + ",";
                            ids = "";
                            foreach (tbProjectColumn pColumn in tbProjectColumns)
                            {
                                if (!sid.Contains("," + pColumn.ID.ToString().PadLeft(4, '0') + ",")) {
                                    ids += pColumn.ID + ",";
                                }
                            }
                            ids = ids.Trim(',');
                            if (!string.IsNullOrEmpty(ids)) {
                                max = DbSession.Default.Excute(string.Format("updata tbProjectColumn set ParentID={0} where ID in({1})", projectColumn.ID, ids));
                            }
                            break;
                        case "newscolumn":
                            VW_NewsColumn newscolumn = DbSession.Default.From<VW_NewsColumn>().Where(VW_NewsColumn._.ID == ColumnID).Select(VW_NewsColumn._.sid, VW_NewsColumn._.ID).ToFirst();
                            if (newscolumn == null)
                            {
                                throw new Exception("分类不存在！");
                            }
                            List<tbNewsColumn> newscolumns = DbSession.Default.From<tbNewsColumn>().Where(tbNewsColumn._.Enable == true && tbNewsColumn._.Title.In(arr)).ToList<tbNewsColumn>() as List<tbNewsColumn>;
                            sid = "," + newscolumn.sid + ",";
                            ids = "";
                            foreach (tbNewsColumn pColumn in newscolumns)
                            {
                                if (!sid.Contains("," + pColumn.ID.ToString().PadLeft(4, '0') + ","))
                                {
                                    ids += pColumn.ID + ",";
                                }
                            }
                            ids = ids.Trim(',');
                            if (!string.IsNullOrEmpty(ids))
                            {
                                max = DbSession.Default.Excute(string.Format("updata tbNewsColumn set ParentID={0} where ID in({1})", newscolumn.ID, ids));
                            }
                            break;
                        case "helpcolumn":
                            VW_HelpColumn helpcolumn = DbSession.Default.From<VW_HelpColumn>().Where(VW_HelpColumn._.ID == ColumnID).Select(VW_HelpColumn._.sid, VW_HelpColumn._.ID).ToFirst();
                            if (helpcolumn == null)
                            {
                                throw new Exception("分类不存在！");
                            }
                            List<tbHelpColumn> helpcolumns = DbSession.Default.From<tbHelpColumn>().Where(tbHelpColumn._.Enable == true && tbHelpColumn._.Title.In(arr)).ToList<tbHelpColumn>() as List<tbHelpColumn>;
                            sid = "," + helpcolumn.sid + ",";
                            ids = "";
                            foreach (tbHelpColumn pColumn in helpcolumns)
                            {
                                if (!sid.Contains("," + pColumn.ID.ToString().PadLeft(4, '0') + ","))
                                {
                                    ids += pColumn.ID + ",";
                                }
                            }
                            ids = ids.Trim(',');
                            if (!string.IsNullOrEmpty(ids))
                            {
                                max = DbSession.Default.Excute(string.Format("updata tbHelpColumn set ParentID={0} where ID in({1})", helpcolumn.ID, ids));
                            }
                            break;
                        case "agentcolumn":
                            VW_AgentColumn agentcolumn = DbSession.Default.From<VW_AgentColumn>().Where(VW_AgentColumn._.ID == ColumnID).Select(VW_AgentColumn._.sid, VW_AgentColumn._.ID).ToFirst();
                            if (agentcolumn == null)
                            {
                                throw new Exception("分类不存在！");
                            }
                            List<tbAgentColumn> agentcolumns = DbSession.Default.From<tbAgentColumn>().Where(tbAgentColumn._.Enable == true && tbAgentColumn._.Title.In(arr)).ToList<tbAgentColumn>() as List<tbAgentColumn>;
                            sid = "," + agentcolumn.sid + ",";
                            ids = "";
                            foreach (tbAgentColumn pColumn in agentcolumns)
                            {
                                if (!sid.Contains("," + pColumn.ID.ToString().PadLeft(4, '0') + ","))
                                {
                                    ids += pColumn.ID + ",";
                                }
                            }
                            ids = ids.Trim(',');
                            if (!string.IsNullOrEmpty(ids))
                            {
                                max = DbSession.Default.Excute(string.Format("updata tbAgentColumn set ParentID={0} where ID in({1})", agentcolumn.ID, ids));
                            }
                            break;
                    }

                    if (max > 0)
                    {
                        columns = columns.Replace(",", "，").Replace("\r\n", ",").Replace("\n", ",").Replace(",,", ",");
                        AdminTools.RemoveCache<DataTable>("SelectRelevant" + type.Replace("column", "").Replace("tb", ""));
                        AdminTools.InsertLog("批量转移" + tips, columns, false, max, UI.BasePage.RequestActions.Update, -1);
                        NVEngine.Tools.NewTools.ClearCache(type);
                        
                        WriteJson(true, "批量转移了" + max + "个" + tips);
                    }
                    else {
                        WriteJson(false, "没有可更新数据...");
                    }
                }
                catch (Exception ex)
                {
                    WriteJson(false, ex.Message);
                }
            }
            WriteJson(false, "参数错误！");
        }

        public static Regex IllegalRegex = new Regex("[^a-z0-9\u4e00-\u9fa5]");
        /// <summary>
        /// 批量添加分类
        /// </summary>
        private void BatchAddColumn()
        {
            string type = GF("typename").ToLower();
            string cid = GF("cid");
            string columns = GF("columns").Replace("'", "“");
            string mode = GF("mode");//单行模式、多行模式
            
            int ColumnID = -1;
            string[] arr = null;
            
            if (AdminTools.CheckSIDFormat(cid))
            {
                ColumnID = AdminTools.GetColumnIDBySID(cid);
            }
            else {
                ColumnID = NSW.ComUtls.ParseInt(cid, -1);
            }
            
            if (ColumnID>0 && !string.IsNullOrEmpty(columns) && (arr = ComUtls.SplitByEnter(columns))!=null&&arr.Length>0)
            {
                if (!CheckPermission(type, BLL.Admin.AdminPermission.InsertPermission))
                {
                    WriteJson(false, "您没有权限添加！");
                    return;
                }
                int max = 0;
                string temp = string.Empty;

                string tips = GetTypeTitle(type);
                try
                {
                    switch (type)
                    {
                        case "productcolumn":
                            tbProductColumn productColumn = DbSession.Default.Get<tbProductColumn>(ColumnID);
                            if (productColumn == null)
                            {
                                throw new Exception(tips + "不存在！");
                            }
                            temp = OConfig.Common.ProductHtmlTargetPath;
                            break;
                        case "projectcolumn":
                            tbProjectColumn projectcolumn = DbSession.Default.Get<tbProjectColumn>(ColumnID);
                            if (projectcolumn == null)
                            {
                                throw new Exception(tips + "不存在！");
                            }
                            temp = OConfig.Common.ProjectHtmlTargetPath;
                            break;
                        case "newscolumn":
                            tbNewsColumn newscolumn = DbSession.Default.Get<tbNewsColumn>(ColumnID);
                            if (newscolumn == null)
                            {
                                throw new Exception(tips + "不存在！");
                            }
                            temp = OConfig.Common.NewsHtmlTargetPath;
                            break;
                        case "helpcolumn":
                            tbHelpColumn helpcolumn = DbSession.Default.Get<tbHelpColumn>(ColumnID);
                            if (helpcolumn == null)
                            {
                                throw new Exception(tips + "不存在！");
                            }
                            temp = OConfig.Common.HelpHtmlTargetPath;
                            break;
                        case "agentcolumn":
                            tbAgentColumn agentcolumn = DbSession.Default.Get<tbAgentColumn>(ColumnID);
                            if (agentcolumn == null)
                            {
                                throw new Exception(tips + "不存在！");
                            }
                            temp = OConfig.Common.AgentHtmlTargetPath;
                            break;
                    }

                    string InsertTemp = ColumnSqlTemp[type] as string;
                    if (!string.IsNullOrEmpty(InsertTemp))
                    {
                        StringBuilder sb = new StringBuilder();

                        bool isColumn = type.EndsWith("column");
                        bool isTrue = true;
                        foreach (string title in arr)
                        {
                            if (!string.IsNullOrEmpty(title))
                            {
                                if (isColumn)
                                {
                                    if (isTrue) {
                                        sb.AppendLine("declare @id int");
                                        isTrue = false;
                                    }
                                    string dic = type.Replace("column",string.Empty);
                                    bool isSpelling = NVEngine.Tools.NewTools.GetAppWebConfig("Spelling").Equals("true");
                                    if (isSpelling) {
                                        InsertTemp = InsertTemp.Replace("dbo.procGetPY('{0}',10)", "dbo.procGetPinYin('{0}')");
                                    }
                                    string def = NVEngine.Tools.NewTools.GetAppWebConfig(dic + "diretorie");
                                    if (string.IsNullOrEmpty(def)) {
                                        def = dic + "01";
                                    }
                                    sb.AppendFormat(InsertTemp + "\r\n", IllegalRegex.Replace(title, string.Empty), AdminTools.GetColumnIDBySID(cid), dic, temp, def);
                                    sb.AppendLine("select @id = @@IDENTITY");
                                    sb.AppendFormat("INSERT INTO [dbo].[tbExpandURL](SID,ExpandURL,ColumnName,UrlType,InputTime,ColumnID,ParsePage,MParsePage) SELECT SID,ExpandURL,Title,'{0}',GETDATE(),ID,ParsePage,MParsePage FROM VW_{0}Column Where ID=@id\r\n", dic);
                                }
                            }
                        }
                        if (sb.Length > 0)
                        {
                            max = DbSession.Default.Excute(sb.ToString());
                            if (max > 0)
                            {
                                columns = columns.Replace(",", "，").Replace("\r\n", ",").Replace("\n", ",").Replace(",,", ",");
                                AdminTools.RemoveCache<DataTable>("SelectRelevant" + type.Replace("column", "").Replace("tb", ""));
                                NVEngine.Tools.NewTools.ClearCache(type);

                                max = max / 2;
                                AdminTools.InsertLog("批量添加" + tips, columns, false, max, UI.BasePage.RequestActions.Insert, -1);
                                WriteJson(true, "批量添加了" + max + "个" + tips);
                                return;
                            }
                            else
                            {
                                WriteJson(false, "没有可添加的记录！");
                                return;
                            }
                        }
                        else
                        {
                            WriteJson(false, "没有可添加的记录！");
                            return;
                        }
                    }
                }
                catch (Exception ex) {
                    WriteJson(false, ex.Message);
                    return;
                }
            }
            WriteJson(false, "参数错误！");
            return;
        }
        
        /// <summary>
        /// 获取栏目尺寸
        /// </summary>
        private void GetColumnPicSize()
        {
            int oid = ComUtls.ParseInt(QS("oid"),0);
            string type = QS("type", "");
            if (oid == 0)
            {
                WriteString("无");
            }
            ColumnExtend c = null;
            string info = "无";
            switch (type)
            {
                case "agent":
                    c = ColumnExtendXMLTools.ReadInfo(oid, API.ColumnType.Agent);
                    break;
                case "news":
                    c = ColumnExtendXMLTools.ReadInfo(oid, API.ColumnType.News);
                    break;
                case "help":
                    c = ColumnExtendXMLTools.ReadInfo(oid, API.ColumnType.Help);
                    break;
                case "product":
                    if (NSW.OConfig2.SMTP.P_img_width != 0 || NSW.OConfig2.SMTP.P_img_height != 0)
                    {
                        info = NSW.OConfig2.SMTP.P_img_width + "*" + NSW.OConfig2.SMTP.P_img_height;
                    }
                    break;
                case "project":
                    if (NSW.OConfig2.SMTP.ProjectImgWidth != 0 || NSW.OConfig2.SMTP.ProjectImgHeight != 0)
                    {
                        info = NSW.OConfig2.SMTP.ProjectImgWidth + "*" + NSW.OConfig2.SMTP.ProjectImgHeight;
                    }
                    break;
                    
            }
            if (c != null && (c.Width != 0 || c.Height != 0))
            {
                WriteString(string.Format("{0}*{1}", c.Width, c.Height));
            }
            else if (info != "无")
            {
                WriteString(info);
            }
            else
            {
                WriteString("无");
            }
        }
        
        /// <summary>
        /// 点击操作，如精华什么的
        /// </summary>
        private void ajaxbit()
        {
            int oid = ComUtls.ParseInt(GF("OID"), 0);
            string fileColumn = GF("fileColumn").ToLower();
            int enable = ComUtls.ParseInt(GF("enable"), 0);
            string typename = GF("typename").ToLower();
            int result = 0;
            string error = "无效操作！";
            
            string url = string.Empty;
            if (!string.IsNullOrEmpty(typename))
            {
                if (!CheckPermission(typename, BLL.Admin.AdminPermission.UpdatePermission))
                {
                    WriteJson(false, "您没有权限！");
                    return;
                }

                if (oid == 1 && (typename.EndsWith("column") || "|systemmenu|".Contains(typename)))
                {
                    WriteJson(false, "根分类无法修改！");
                    return;
                }
            }
            else if (HttpContext.Current.Request.UrlReferrer != null)
            {
                url = HttpContext.Current.Request.UrlReferrer.AbsolutePath;
                url = url.Substring(url.LastIndexOf('/') + 1);
                if (!CheckPermission(url, NSW.BLL.Admin.AdminPermission.UpdatePermission))
                {
                    WriteJson(false, "您没有权限！");
                    return;
                }
            }
            
            if(typename.Equals("admin") && oid>0){//对是否为系统管理员的更新设置
                tbAdmin admin = DbSession.Default.Get<tbAdmin>(tbAdmin._.ID == oid);
                if (admin != null && admin.isSystem)
                {
                    WriteJson(false, "无法对系统管理员进行操作！");
                    return;
                }
            }
            if (oid > 0)
            {
                try
                {
                    //Field file = null;
                    switch (typename)
                    {
                        case "news":
                            switch (fileColumn)
                            {
                                case "iscommend":
                                    result = DbSession.Default.Update<tbNews>(tbNews._.isCommend, enable, tbNews._.ID == oid);
                                    break;
                                case "istop":
                                    result = DbSession.Default.Update<tbNews>(tbNews._.isTop, enable, tbNews._.ID == oid);
                                    break;
                                case "isbest":
                                    result = DbSession.Default.Update<tbNews>(tbNews._.isBest, enable, tbNews._.ID == oid);
                                    break;
                                case "enable":
                                    result = DbSession.Default.Update<tbNews>(tbNews._.Enable, enable, tbNews._.ID == oid);
                                    break;
                                case "delay":
                                case "isindex":
                                    result = DbSession.Default.Update<tbNews>(tbNews._.Delay, enable, tbNews._.ID == oid);
                                    break;
                            }
                            break;
                        case "newscolumn":
                            switch (fileColumn)
                            {
                                case "iscommend":
                                    result = DbSession.Default.Update<tbNewsColumn>(tbNewsColumn._.isCommend, enable, tbNewsColumn._.ID == oid);
                                    break;
                                case "istop":
                                    result = DbSession.Default.Update<tbNewsColumn>(tbNewsColumn._.isTop, enable, tbNewsColumn._.ID == oid);
                                    break;
                                case "isbest":
                                    result = DbSession.Default.Update<tbNewsColumn>(tbNewsColumn._.isBest, enable, tbNewsColumn._.ID == oid);
                                    break;
                                case "enable":
                                    result = DbSession.Default.Update<tbNewsColumn>(tbNewsColumn._.Enable, enable, tbNewsColumn._.ID == oid);
                                    break;
                            }
                            break;
                        case "agent":
                            switch (fileColumn)
                            {
                                case "delay":
                                case "isindex":
                                    result = DbSession.Default.Update<tbAgent>(tbAgent._.Delay, enable, tbAgent._.ID == oid);
                                    break;
                                case "iscommend":
                                    result = DbSession.Default.Update<tbAgent>(tbAgent._.isCommend, enable, tbAgent._.ID == oid);
                                    break;
                                case "istop":
                                    result = DbSession.Default.Update<tbAgent>(tbAgent._.isTop, enable, tbAgent._.ID == oid);
                                    break;
                                case "isbest":
                                    result = DbSession.Default.Update<tbAgent>(tbAgent._.isBest, enable, tbAgent._.ID == oid);
                                    break;
                                case "enable":
                                    result = DbSession.Default.Update<tbAgent>(tbAgent._.Enable, enable, tbAgent._.ID == oid);
                                    break;
                            }
                            break;
                        case "agentcolumn":
                            switch (fileColumn)
                            {
                                case "iscommend":
                                    result = DbSession.Default.Update<tbAgentColumn>(tbAgentColumn._.isCommend, enable, tbAgentColumn._.ID == oid);
                                    break;
                                case "istop":
                                    result = DbSession.Default.Update<tbAgentColumn>(tbAgentColumn._.isTop, enable, tbAgentColumn._.ID == oid);
                                    break;
                                case "isbest":
                                    result = DbSession.Default.Update<tbAgentColumn>(tbAgentColumn._.isBest, enable, tbAgentColumn._.ID == oid);
                                    break;
                                case "enable":
                                    result = DbSession.Default.Update<tbAgentColumn>(tbAgentColumn._.Enable, enable, tbAgentColumn._.ID == oid);
                                    break;
                            }
                            break;
                        case "help":
                            switch (fileColumn)
                            {
                                case "delay":
                                case "isindex":
                                    result = DbSession.Default.Update<tbHelp>(tbHelp._.Delay, enable, tbHelp._.ID == oid);
                                    break;
                                case "iscommend":
                                    result = DbSession.Default.Update<tbHelp>(tbHelp._.isCommend, enable, tbHelp._.ID == oid);
                                    break;
                                case "istop":
                                    result = DbSession.Default.Update<tbHelp>(tbHelp._.isTop, enable, tbHelp._.ID == oid);
                                    break;
                                case "isbest":
                                    result = DbSession.Default.Update<tbHelp>(tbHelp._.isBest, enable, tbHelp._.ID == oid);
                                    break;
                                case "enable":
                                    result = DbSession.Default.Update<tbHelp>(tbHelp._.Enable, enable, tbHelp._.ID == oid);
                                    break;
                            }
                            break;
                        case "helpcolumn":
                            switch (fileColumn)
                            {
                                case "iscommend":
                                    result = DbSession.Default.Update<tbHelpColumn>(tbHelpColumn._.isCommend, enable, tbHelpColumn._.ID == oid);
                                    break;
                                case "istop":
                                    result = DbSession.Default.Update<tbHelpColumn>(tbHelpColumn._.isTop, enable, tbHelpColumn._.ID == oid);
                                    break;
                                case "isbest":
                                    result = DbSession.Default.Update<tbHelpColumn>(tbHelpColumn._.isBest, enable, tbHelpColumn._.ID == oid);
                                    break;
                                case "enable":
                                    result = DbSession.Default.Update<tbHelpColumn>(tbHelpColumn._.Enable, enable, tbHelpColumn._.ID == oid);
                                    break;
                            }
                            break;
                        case "admin":
                            result = DbSession.Default.Update<tbAdmin>(tbAdmin._.Enable, enable, tbAdmin._.ID == oid);
                            break;
                        case "systemmenu":
                            if (enable == 1)
                            {
                                tbSystemMenu menu = DbSession.Default.Get<tbSystemMenu>(oid);
                                if (menu != null && !menu.Enable)
                                {
                                    tbPermission permission = DbSession.Default.Get<tbPermission>(menu.Permission);
                                    if (!permission.Enable)
                                    {
                                        permission.Attach();
                                        permission.Enable = true;
                                        DbSession.Default.Save<tbPermission>(permission);
                                    }
                                    menu.Attach();
                                    menu.Enable = enable == 1;
                                    result = DbSession.Default.Save<tbSystemMenu>(menu);
                                }
                            }
                            else {
                                result = DbSession.Default.Update<tbSystemMenu>(tbSystemMenu._.Enable, enable, tbSystemMenu._.ID == oid);
                            }
                            break;
                        case "productattributecolumn":
                            result = DbSession.Default.Update<tbProductAttributeColumn>(tbProductAttributeColumn._.Enable, enable, tbProductAttributeColumn._.ID == oid);
                            break;
                        case "projectattributecolumn":
                            result = DbSession.Default.Update<tbProjectAttributeColumn>(tbProjectAttributeColumn._.Enable, enable, tbProjectAttributeColumn._.ID == oid);
                            break;
                        case "product":
                            switch (fileColumn)
                            {
                                case "delay":
                                case "isindex":
                                    result = DbSession.Default.Update<tbProduct>(tbProduct._.Delay, enable, tbProduct._.ID == oid);
                                    break;
                                case "iscommend":
                                    result = DbSession.Default.Update<tbProduct>(tbProduct._.isCommend, enable, tbProduct._.ID == oid);
                                    break;
                                case "istop":
                                    result = DbSession.Default.Update<tbProduct>(tbProduct._.isTop, enable, tbProduct._.ID == oid);
                                    break;
                                case "isbest":
                                    result = DbSession.Default.Update<tbProduct>(tbProduct._.isBest, enable, tbProduct._.ID == oid);
                                    break;
                                case "enable":
                                    result = DbSession.Default.Update<tbProduct>(tbProduct._.Enable, enable, tbProduct._.ID == oid);
                                    break;
                            }
                            break;
                        case "productcolumn":
                            switch (fileColumn)
                            {
                                case "iscommend":
                                    result = DbSession.Default.Update<tbProductColumn>(tbProductColumn._.isCommend, enable, tbProductColumn._.ID == oid);
                                    break;
                                case "istop":
                                    result = DbSession.Default.Update<tbProductColumn>(tbProductColumn._.isTop, enable, tbProductColumn._.ID == oid);
                                    break;
                                case "isbest":
                                    result = DbSession.Default.Update<tbProductColumn>(tbProductColumn._.isBest, enable, tbProductColumn._.ID == oid);
                                    break;
                                case "enable":
                                    result = DbSession.Default.Update<tbProductColumn>(tbProductColumn._.Enable, enable, tbProductColumn._.ID == oid);
                                    break;
                            }
                            break;
                        case "project":
                            switch (fileColumn)
                            {
                                case "iscommend":
                                    result = DbSession.Default.Update<tbProject>(tbProject._.isCommend, enable, tbProject._.ID == oid);
                                    break;
                                case "istop":
                                    result = DbSession.Default.Update<tbProject>(tbProject._.isTop, enable, tbProject._.ID == oid);
                                    break;
                                case "isbest":
                                    result = DbSession.Default.Update<tbProject>(tbProject._.isBest, enable, tbProject._.ID == oid);
                                    break;
                                case "enable":
                                    result = DbSession.Default.Update<tbProject>(tbProject._.Enable, enable, tbProject._.ID == oid);
                                    break;
                                case "delay":
                                case "isindex":
                                    result = DbSession.Default.Update<tbProject>(tbProject._.Delay, enable, tbProject._.ID == oid);
                                    break;
                            }
                            break;
                        case "projectcolumn":
                            switch (fileColumn)
                            {
                                case "iscommend":
                                    result = DbSession.Default.Update<tbProjectColumn>(tbProjectColumn._.isCommend, enable, tbProjectColumn._.ID == oid);
                                    break;
                                case "istop":
                                    result = DbSession.Default.Update<tbProjectColumn>(tbProjectColumn._.isTop, enable, tbProjectColumn._.ID == oid);
                                    break;
                                case "isbest":
                                    result = DbSession.Default.Update<tbProjectColumn>(tbProjectColumn._.isBest, enable, tbProjectColumn._.ID == oid);
                                    break;
                                case "enable":
                                    result = DbSession.Default.Update<tbProjectColumn>(tbProjectColumn._.Enable, enable, tbProjectColumn._.ID == oid);
                                    break;
                            }
                            break;
                        case "menu":
                            List<MuneXML> listAll = XMLTool.Deserialize(HttpContext.Current.Server.MapPath("/") + "/Config/Mune.xml");
                            MuneXML m = new MuneXML();
                            typename = "mune";
                            switch (fileColumn)
                            {
                                case "enable":
                                    m = listAll.Find(delegate(MuneXML ml) { return ml.OID == oid.ToString(); });
                                    m.Enable = enable;
                                    XMLTool.SerObject(HttpContext.Current.Server.MapPath("/") + "/Config/Mune.xml", listAll);
                                    result = 1;
                                    break;
                                case "isrel":
                                    m = listAll.Find(delegate(MuneXML ml) { return ml.OID == oid.ToString(); });
                                    m.IsRel = enable;
                                    XMLTool.SerObject(HttpContext.Current.Server.MapPath("/") + "/Config/Mune.xml", listAll);
                                    result = 1;
                                    break;
                            }
                            break;
                        case "pdcomment":
                        case "pjcomment":
                        case "newscomment":
                        case "agentcomment":
                        case "helpcomment":
                            result = DbSession.Default.Update<tbComment>(tbComment._.Enable, enable, tbComment._.ID == oid);
                            break;
                        case "usergroup":
                            result = DbSession.Default.Update<tbUserGroup>(tbUserGroup._.Enable, enable, tbUserGroup._.ID == oid);
                            break;
                        case "users":
                            switch (fileColumn)
                            {
                                case "active":
                                    result = DbSession.Default.Update<tbUser>(tbUser._.Active, enable, tbUser._.ID == oid);
                                    break;
                                case "enable":
                                    result = DbSession.Default.Update<tbUser>(tbUser._.Enable, enable, tbUser._.ID == oid);
                                    break;
                            }
                            break;
                        case "firendlink":
                            result = DbSession.Default.Update<tbFriendLink>(tbFriendLink._.Enable, enable, tbFriendLink._.ID == oid);
                            break;
                        case "jobcolumns":
                            switch (fileColumn)
                            {
                                case "showdetail":
                                    result = DbSession.Default.Update<tbJobColumn>(tbJobColumn._.ShowDetail, enable, tbJobColumn._.ID == oid);
                                    break;
                                case "enable":
                                    result = DbSession.Default.Update<tbJobColumn>(tbJobColumn._.Enable, enable, tbJobColumn._.ID == oid);
                                    break;
                            }
                            break;
                        case "keywordcolumns":
                            result = DbSession.Default.Update<tbKeywordColumn>(tbKeywordColumn._.Enable, enable, tbKeywordColumn._.ID == oid);
                            break;
                        case "nvcontrols":
                            result = DbSession.Default.Update<tbNVControls>(tbNVControls._.Enable, enable, tbNVControls._.ID == oid);
                            break;
                        case "sitepagecolumn":
                            result = DbSession.Default.Update<tbSitePageColumns>(tbSitePageColumns._.Enable, enable, tbSitePageColumns._.ID == oid);
                            break;
                        case "tagcolumn":
                            result = DbSession.Default.Update<tbTagColumn>(tbTagColumn._.Enable, enable, tbTagColumn._.ID == oid);
                            break;
                        case "tbforms":
                            FormDB.Entity.tbForms forms = FormDB.Entity.tbForms.GetEntity(oid);
                            if (forms.ID > 0) {
                                forms.IsEnable = enable == 1;
                                result = forms.Save();
                            }
                            break;
                        case "tbleavemessage":
                            FormDB.Entity.tbLeaveMessage leaveMessage = FormDB.Entity.tbLeaveMessage.GetEntity(oid);
                            if (leaveMessage.ID > 0)
                            {
                                leaveMessage.IsEnable = enable == 1;
                                result = leaveMessage.Save();
                            }
                            break;
                        case "templatecolumn":
                            result = DbSession.Default.Excute(string.Format("update tbtemplatecolumn set {2}={0} where id={1}",enable, oid, fileColumn));
                            break;
                        case "video":
                            result = DbSession.Default.Excute(string.Format("update tbvideo set {2}={0} where id={1}", enable, oid, fileColumn));
                            break;
                        default:
                            if (!string.IsNullOrEmpty(url) && !string.IsNullOrEmpty(typename = GetTableName(url)))
                            {
                                result = DbSession.Default.Excute(string.Format("update {0} set {3}={1} where id={2}", typename, enable, oid, fileColumn));
                            }
                            break;
                    }
                }
                catch (Exception ex)
                {
                    error = ex.Message;
                }
                if (result > 0)
                {
                    NVEngine.Tools.NewTools.ClearCache(typename);
                    WriteJson(true, enable.Equals(0) ? "禁用" : "可用");
                    return;
                }
                else
                {
                    WriteJson(false, error);
                }
            }
            else {
                WriteJson(false, "拉取记录出错！此记录是否已经被删除!");
                return;
            }

            WriteJson(false, "无效操作！");
            return;
        }

        /// <summary>
        /// 直接修改分类
        /// </summary>
        private void alertColumn()
        {
            //当前分类
            int oid = ComUtls.ParseInt(GF("oid"), 0);
            //所属分类
            string _pid = GF("pid");
            if (AdminTools.CheckSIDFormat(_pid)) {
                _pid = AdminTools.GetColumnIDBySID(_pid).ToString();
            }
            int pid = ComUtls.ParseInt(_pid, 0);
            int result = 0;
            string error = "修改失败，请稍后重试！";
            string typename = GF("typename");
            
            if (pid > 0 && oid>0)
            {
                string url = string.Empty;
                if (!string.IsNullOrEmpty(typename))
                {
                    if (!CheckPermission(typename, BLL.Admin.AdminPermission.UpdatePermission))
                    {
                        WriteJson(false, "您没有权限！");
                        return;
                    }
                }
                else if (HttpContext.Current.Request.UrlReferrer != null)
                {
                    url = HttpContext.Current.Request.UrlReferrer.AbsolutePath;
                    url = url.Substring(url.LastIndexOf('/') + 1);
                    if (!CheckPermission(url, NSW.BLL.Admin.AdminPermission.UpdatePermission))
                    {
                        WriteJson(false, "您没有权限！");
                        return;
                    }
                }
                try
                {
                    string tips = GetTypeTitle(typename);
                    if (!string.IsNullOrEmpty(typename))
                    {
                        switch (typename)
                        {
                            case "product":
                                result = DbSession.Default.Update<tbProduct>(tbProduct._.ColumnID, pid, tbProduct._.ID == oid);
                                break;
                            case "project":
                                result = DbSession.Default.Update<tbProject>(tbProject._.ColumnID, pid, tbProject._.ID == oid);
                                break;
                            case "news":
                                result = DbSession.Default.Update<tbNews>(tbNews._.ColumnID, pid, tbNews._.ID == oid);
                                break;
                            case "help":
                                result = DbSession.Default.Update<tbHelp>(tbHelp._.ColumnID, pid, tbHelp._.ID == oid);
                                break;
                            case "agent":
                                result = DbSession.Default.Update<tbAgent>(tbAgent._.ColumnID, pid, tbAgent._.ID == oid);
                                break;
                            case "picture":
                                tbPicture Picture = DbSession.Default.Get<tbPicture>(oid);
                                if (Picture != null)
                                {
                                    Picture.Attach();
                                    Picture.ColumnID = pid;
                                    Picture.Revision = ++Picture.Revision;
                                    result = DbSession.Default.Save<tbPicture>(Picture);
                                }
                                break;
                        }
                    }
                    else {
                        if (!string.IsNullOrEmpty(url) && !string.IsNullOrEmpty(typename = GetTableName(url)))
                        {
                            string updateTemp = "update {0} set ColumnID={1} where id={2}";
                            result = DbSession.Default.Excute(string.Format(updateTemp, typename, pid, oid));
                        }
                    }
                    if (result > 0)
                    {
                        AdminTools.InsertLog("修改" + tips + "所属分类", "ColumnID:" + pid, true, result, UI.BasePage.RequestActions.Update, oid);
                        NVEngine.Tools.NewTools.ClearCache(typename);
                        error = "修改成功！";
                    }
                }
                catch (Exception e)
                {
                    error = e.Message;
                }
                WriteJson(result > 0, error);
                return;
            }
            else
            {
                WriteJson(false, "拉取记录出错！此记录是否已经被删除!");
                return;
            }
        }
        /// <summary>
        /// 修改标题
        /// </summary>
        private void alertTitle()
        {
            int oid = ComUtls.ParseInt(GF("OID"), 0);
            string title = GF("value").Replace("'", "''");
            int result = 0;
            string typename = GF("typename");
            string error = "修改失败，请稍后重试！";
            
            if (!string.IsNullOrEmpty(title)) {
                string url = string.Empty;
                if (!string.IsNullOrEmpty(typename))
                {
                    if (!CheckPermission(typename, BLL.Admin.AdminPermission.UpdatePermission))
                    {
                        WriteJson(false, "您没有权限！");
                        return;
                    }
                }
                else if (HttpContext.Current.Request.UrlReferrer != null)
                {
                    url = HttpContext.Current.Request.UrlReferrer.AbsolutePath;
                    url = url.Substring(url.LastIndexOf('/') + 1);
                    if (!CheckPermission(url, NSW.BLL.Admin.AdminPermission.UpdatePermission))
                    {
                        WriteJson(false, "您没有权限！");
                        return;
                    }
                }
                
                try
                {
                    string tips = GetTypeTitle(typename);
                    if (!string.IsNullOrEmpty(typename))
                    {
                        switch (typename)
                        {
                            case "picture":
                                tbPicture Picture = DbSession.Default.Get<tbPicture>(oid);
                                if (Picture != null)
                                {
                                    Picture.Attach();
                                    Picture.Title = title;
                                    Picture.Revision = ++Picture.Revision;
                                    result = DbSession.Default.Save<tbPicture>(Picture);
                                }
                                break;
                        }
                    }
                    else {
                        if (!string.IsNullOrEmpty(url) && !string.IsNullOrEmpty(typename = GetTableName(url)))
                        {
                            string updateTemp = "update {0} set Title='{1}' where id={2}";
                            result = DbSession.Default.Excute(string.Format(updateTemp, typename, title, oid));
                        }
                    }
                    if (result > 0)
                    {
                        AdminTools.InsertLog("修改" + tips + "标题", title, true, result, UI.BasePage.RequestActions.Update, oid);
                        NVEngine.Tools.NewTools.ClearCache(typename);
                        
                        error = "修改成功！";
                    }
                }
                catch (Exception e)
                {
                    error = e.Message;
                }
                WriteJson(result > 0, error);
                return;
            }
        }
        private static Hashtable _PageTableName = null;
        /// <summary>
        /// 一些特殊界面，没办法跟url拼接成表名的
        /// </summary>
        public static Hashtable PageTableName {
            get {
                if (_PageTableName == null) {
                    _PageTableName = new Hashtable();
                    _PageTableName.Add("im_service_groups.aspx", "tbIMGroup");
                    _PageTableName.Add("agent_applies.aspx", "tbAgentApply");
                    _PageTableName.Add("wxusers.aspx", "tbWeiXinUsers");
                    _PageTableName.Add("email.aspx", "tbUserEmail");
                    _PageTableName.Add("news.aspx", "tbNews");
                }
                return _PageTableName;
            }
        }
        /// <summary>
        /// 根据url，获取表名
        /// </summary>
        /// <param name="url">url</param>
        /// <returns>返回表名</returns>
        private static string GetTableName(string url) {
            url = url.ToLower();
            string tabName = PageTableName[url] as string;
            if (!string.IsNullOrEmpty(tabName))
            {
                return tabName;
            }
            bool isColumn = url.Contains("_column");
            
            url = Regex.Replace(url, @"(s?\.aspx|_column\.aspx)", "");
            url = url.Replace("_", string.Empty);
            tabName = "tb" + url + (isColumn ? "column" : string.Empty);

            return tabName.Replace("'", "").Replace(";", "").Replace("tbtb", "tb");
        }
        private void alertOrder() 
        {
            int oid = ComUtls.ParseInt(GF("OID"), 0);
            int Order = ComUtls.ParseInt(GF("value"), 0);
            int result = 0;
            string typename = GF("typename");
            string error = "修改失败，请稍后重试！";
            if (oid > 0)
            {
                string url = string.Empty;
                if (!string.IsNullOrEmpty(typename))
                {
                    if (!CheckPermission(typename, BLL.Admin.AdminPermission.UpdatePermission))
                    {
                        WriteJson(false, "您没有权限！");
                        return;
                    }
                }
                else if (HttpContext.Current.Request.UrlReferrer != null)
                {
                    url = HttpContext.Current.Request.UrlReferrer.AbsolutePath;
                    url = url.Substring(url.LastIndexOf('/') + 1);
                    if (!CheckPermission(url,NSW.BLL.Admin.AdminPermission.UpdatePermission)){
                        WriteJson(false, "您没有权限！");
                        return;
                    }
                }
                try
                {
                    string tips = GetTypeTitle(typename);
                    switch (typename)
                    {
                        case "news":
                            result = DbSession.Default.Update<tbNews>(tbNews._.OrderID, Order, tbNews._.ID == oid);
                            break;
                        case "newscolumn":
                            result = DbSession.Default.Update<tbNewsColumn>(tbNewsColumn._.OrderID, Order, tbNewsColumn._.ID == oid);
                            break;
                        case "product":
                            result = DbSession.Default.Update<tbProduct>(tbProduct._.OrderID, Order, tbProduct._.ID == oid);
                            break;
                        case "productcolumn":
                            result = DbSession.Default.Update<tbProductColumn>(tbProductColumn._.OrderID, Order, tbProductColumn._.ID == oid);
                            break;
                        case "project":
                            result = DbSession.Default.Update<tbProject>(tbProject._.OrderID, Order, tbProject._.ID == oid);
                            break;
                        case "projectcolumn":
                            result = DbSession.Default.Update<tbProjectColumn>(tbProjectColumn._.OrderID, Order, tbProjectColumn._.ID == oid);
                            break;
                        case "help":
                            result = DbSession.Default.Update<tbHelp>(tbHelp._.OrderID, Order, tbHelp._.ID == oid);
                            break;
                        case "helpcolumn":
                            result = DbSession.Default.Update<tbHelpColumn>(tbHelpColumn._.OrderID, Order, tbHelpColumn._.ID == oid);
                            break;
                        case "agent":
                            result = DbSession.Default.Update<tbAgent>(tbAgent._.OrderID, Order, tbAgent._.ID == oid);
                            break;
                        case "agentcolumn":
                            result = DbSession.Default.Update<tbAgentColumn>(tbAgentColumn._.OrderID, Order, tbAgentColumn._.ID == oid);
                            break;
                        case "systemmenu":
                            result = DbSession.Default.Update<tbSystemMenu>(tbSystemMenu._.OrderID, Order, tbSystemMenu._.ID == oid);
                            break;
                        case "productattributecolumn":
                            result = DbSession.Default.Update<tbProductAttributeColumn>(tbProductAttributeColumn._.OrderID, Order, tbProductAttributeColumn._.ID == oid);
                            break;
                        case "menu":
                            List<MuneXML> listAll = XMLTool.Deserialize(HttpContext.Current.Server.MapPath("/") + "/Config/Mune.xml");
                            MuneXML m = listAll.Find(delegate(MuneXML ml) { return ml.OID == oid.ToString(); });
                            m.Order = Order;
                            XMLTool.SerObject(HttpContext.Current.Server.MapPath("/") + "/Config/Mune.xml", listAll);
                            result = 1;
                            break;
                        case "pdcomment":
                        case "pjcomment":
                        case "newscomment":
                        case "agentcomment":
                        case "helpcomment":
                            result = DbSession.Default.Update<tbComment>(tbComment._.OrderID, Order, tbComment._.ID == oid);
                            break;
                        default:
                            if (!string.IsNullOrEmpty(url) && !string.IsNullOrEmpty(typename = GetTableName(url)))
                            {
                                result = DbSession.Default.Excute(string.Format("update {0} set OrderID={1} where id={2}", typename, Order, oid));
                            }
                            break;

                    }
                    if (result > 0)
                    {
                        AdminTools.InsertLog("修改" + tips + "排序", "(OrderID:" + Order + ")", true, result, UI.BasePage.RequestActions.Update, oid);
                        NVEngine.Tools.NewTools.ClearCache(typename);
                    }
                }
                catch (Exception ex)
                {
                    error = ex.Message;
                }
                if (result > 0)
                {
                    WriteJson(true, "更新成功！");
                    return;
                }
                else
                {
                    WriteJson(false,error);
                    return;
                }
            }
            else {
                WriteJson(false, "拉取记录出错！此记录是否已经被删除!");
                return;
            }
        }
        
        /// <summary>
        /// 取出配置文件中产品图片的大小
        /// </summary>
        public static void initimgsize()
        {
            try
            {
                HttpContext.Current.Response.Write(OConfig2.SMTP.P_img_height + "|" + OConfig2.SMTP.P_img_width);
            }
            catch (Exception e)
            {
                HttpContext.Current.Response.Write("0|0");
            }
        }
        /// <summary>
        /// 生成会员的关键词（八爪图）
        /// </summary>
        private static void SearchKeyWords()
        {
            //获得参数
            string A6 = GF("A6").Replace(",", "").Replace("，", "");
            string A8 = GF("A8").Replace(",", "").Replace("，", "");
            string A10 = GF("A10").Replace(",", "").Replace("，", "");
            string A12 = GF("A12").Replace(",", "").Replace("，", "");
            string A14 = GF("A14").Replace(",", "").Replace("，", "");
            string A16 = GF("A16").Replace(",", "").Replace("，", "");
            string A18 = GF("A18").Replace(",", "").Replace("，", "");
            string A20 = GF("A20").Replace(",", "").Replace("，", "");
            string A22 = GF("A22").Replace(",", "").Replace("，", "");
            string A24 = GF("A24").Replace(",", "").Replace("，", "");
            string A26 = GF("A26").Replace(",", "").Replace("，", "");
            KeyValuePair<string, string> node1;
            KeyValuePair<string, string> node2;
            KeyValuePair<string, string> node3;

            if (A16.Trim().Length == 0 || A16.Trim() == "")
            {
                node1 = new KeyValuePair<string, string>("state", "0");
                node2 = new KeyValuePair<string, string>("msg", "核心关键词不能为空，请点击修改核心关键词！");
                WriteXml(node1, node2);
                return;
            }


            //生成关键词
            string KeyWords = NSW.BLL.KeyWords.GetKeyWordsGenius(A6, A8, A10, A12, A14, A16, A18, A20, A22, A24, A26);


            //返回数据
            if (KeyWords.Trim().Length > 0)
            {
                string temp = "";
                string[] str = KeyWords.Split(',');
                if (str.Length > 15)
                {
                    for (int i = 0; i < 10; i++)
                    {
                        temp += "<span>" + str[i] + "</span>";
                    }
                }
                else
                {
                    for (int i = 0; i < str.Length; i++)
                    {
                        temp += "<span>" + str[i] + "</span>";
                    }
                }

                node1 = new KeyValuePair<string, string>("state", "1");
                node2 = new KeyValuePair<string, string>("msg", KeyWords);
                node3 = new KeyValuePair<string, string>("commend", temp);
                WriteXml(node1, node2, node3);
            }
            else
            {
                node1 = new KeyValuePair<string, string>("state", "0");
                node2 = new KeyValuePair<string, string>("msg", "生成精准关键词失败，请至少填写一项组合项！");
                WriteXml(node1, node2);

            }
        }
        
        /// <summary>
        /// 获取产品分类
        /// </summary>
        private static void GetProductColumns()
        {
            DataTable dataSrc = OCache.ProductColumnTree;
            StringBuilder sbVal = new StringBuilder();
            string clnName;
            int clnId;

            for (int i = 0; i < dataSrc.Rows.Count; i++)
            {
                clnName = dataSrc.Rows[i]["ReName"].ToString();
                clnId = (int)dataSrc.Rows[i]["ID"];

                if (i != 0)
                {
                    sbVal.Append("||");
                }

                sbVal.AppendFormat("{0}{1}{2}", clnId, "$$", clnName);
            }

            WriteString(sbVal.ToString());
        }

        /// <summary>
        /// 设置EC短信中会员的电话cookies值
        /// </summary>
        private static void SetPhonesCookies()
        {

            //1\获得参数
            string Ids = GF("Ids");

            if (!ComUtls.CheckIDsFormat(Ids))
            {
                return;
            }

            WhereClip NWhere = (tbUser._.ID.In(Ids.Split(',')));
            OrderByClip NOrder = (tbUser._.ID.Desc);
            Field[] NField = new BlueCrystal.Data.Field[] { 
                tbUser._.ID,
                tbUser._.MPhone,
                tbUser._.UserName,
                tbUser._.CUserName
            };
            DataTable DT = DbSession.Default.From<tbUser>().Select(NField).Where(NWhere).OrderBy(NOrder).ToDataTable();

            string uid = string.Empty;
            string Phones = string.Empty;
            bool flag = true;

            if (DT.Rows.Count > 0)
            {
                Regex reg = new Regex(@"(((13|15|18)\d{9})|(147\d{8}))$");
                foreach (DataRow ObjRow in DT.Rows)
                {
                    if (reg.IsMatch(ObjRow["MPhone"].ToString()))
                    {
                        if (flag == true)
                        {
                            Phones = ObjRow["MPhone"].ToString();
                            flag = false;
                        }
                        else
                        {
                            Phones += "," + ObjRow["MPhone"].ToString();
                        }

                    }
                }
            }

            string PhonesCookies = OCookie.Mem.EcPhones;
            ArrayList NewCookies = new ArrayList();

            //2\处理参数和cookies
            string[] arr = Phones.Split(',');
            string[] cookies = PhonesCookies.Split(',');

            if (PhonesCookies != "")
            {
                foreach (string cookie in cookies)
                {
                    NewCookies.Add(cookie);
                }
            }

            foreach (string phone in arr)
            {
                if (!NewCookies.Contains(phone))
                {
                    NewCookies.Add(phone);
                }
            }

            //3\处理cookies，组成新的cookies
            bool res = true;
            string NewPhones = string.Empty;
            foreach (string temp in NewCookies)
            {
                if (res == true)
                {
                    NewPhones = temp;
                    res = false;
                }
                else
                {
                    NewPhones += "," + temp;
                }
            }

            OCookie.Mem.EcPhones = NewPhones;
            //4\结束
            WriteString(NewPhones);

        }



        /// <summary>
        /// 获得EC短信中会员的电话cookies值
        /// </summary>
        private static void GetPhonesCookies()
        {

            //1\获得参数
            string DelPhone = GF("DelPhone");
            string PhonesCookies = OCookie.Mem.EcPhones;

            //2\处理参数和cookies
            string[] cookies = PhonesCookies.Split(',');

            //3\处理cookies，组成新的cookies
            bool res = true;
            string NewPhones = string.Empty;
            foreach (string temp in cookies)
            {
                if (temp != DelPhone)
                {
                    if (res == true)
                    {
                        NewPhones = temp;
                        res = false;
                    }
                    else
                    {
                        NewPhones += "," + temp;
                    }
                }

            }

            OCookie.Mem.EcPhones = NewPhones;
            //4\结束
            WriteString(NewPhones);

        }


        /// <summary>
        /// 获得定单状态的EC短信话语
        /// </summary>
        private static void GetUserContent()
        {

            //1\获得参数
            string EcContent = string.Empty;
            int OrderState = ComUtls.ParseInt(GF("OrderState"), -1);

            //2\获得EC短信话语
            switch (OrderState)
            {
                case 0:
                    EcContent = OConfig.GlobalConfig.EC.EcUserContent;
                    break;

                case 1:
                    EcContent = OConfig.GlobalConfig.EC.EcRegContent;
                    break;
                default:
                    EcContent = "请填写要发送的短信内容";
                    break;

            }

            //3\结束
            WriteString(EcContent);

        }


        /// <summary>
        /// 获得定单状态的EC短信话语
        /// </summary>
        private static void GetOrderContent()
        {

            //1\获得参数
            string EcContent = string.Empty;
            int OrderState = ComUtls.ParseInt(GF("OrderState"), 1);

            //2\获得EC短信话语
            EcContent = BLL.EC.EcOrderContent(OrderState);

            //3\结束
            WriteString(EcContent);

        }
        

        /// <summary>
        /// 获取文件内容
        /// </summary>
        private static void GetHTMLFileContent()
        {
            //1>定义变量
            string FileName, ResultString="";

            //2>设置变量值
            FileName = GF("URL");

            try
            {
                //3>检查文件是否存在，如果不存在，则返回错误信息
                if (NSW.Utls.IOUtls.CheckFileType(".aspx|.ascx|.html|.htm|.txt", FileName))
                {

                    //4>检查文件是否存在，如果文件不存在，则提示文件不存在信息
                    if (!IOUtls.IsExist(IOUtls.GetMapPath(FileName), IOUtls.FsoMethod.File))
                    {
                        ResultString="文件名称：" + FileName + "不存在";

                    }
                    //4>把文件内容写入到制定文件
                    else
                    {
                        FileName = IOUtls.GetMapPath(FileName);
                        ResultString = IOUtls.ReadFile(FileName);
                        
                    }

                    //5>结束

                }
                else
                {
                    ResultString="修改的模板名称只能是html|htm|txt格式";

                }
            }
            catch(Exception e)
            {
                ResultString="文件读取出错，请检查文件的物理路径是否正确";
            }
            finally
            {
                WriteString(ResultString);
            }
        }        
        
        
        /// <summary>
        /// 发送获取产品列表通知
        /// </summary>
        private static void SendGetProductByColumn()
        {
            string reason = ClearGF("reason");
            //1\定义变量
            string ColumnID;
            string ResultString = "";

            //2\获取产品数据列表
            ColumnID = GF("columnid");


            //3\绑定数据
            WhereClip nwhere = (VW_Product._.sid.Like(ColumnID + "%")
                && VW_Product._.Enable == true);
            Field[] nfields = new Field[] { 
                VW_Product._.ID,
                VW_Product._.Title                
            };
            DataTable dt = DbSession.Default.From<VW_Product>().Select(nfields).Where(nwhere).ToDataTable(1000);

            foreach (DataRow dr in dt.Rows)
            {
                ResultString += dr[VW_Product._.ID.Name].ToString() + "$$" + dr[VW_Product._.Title.Name].ToString().Replace("$$", "").Replace("||", "");
                ResultString += "||";
            }

            //4\结束
            WriteString(ResultString);

        }
        /// <summary>
        /// 发送获取广告列表通知
        /// </summary>
        private static void SendGetADByColumn()
        {
            string reason = ClearGF("reason");
            //1\定义变量
            string ColumnID;
            string ResultString = "";

            //2\获取产品数据列表
            ColumnID = GF("columnid");


            //3\绑定数据
            WhereClip nwhere = (VW_Ad._.SID.Like(ColumnID + "%")
                && VW_Ad._.Enable == true);
            Field[] nfields = new Field[] { 
                VW_Ad._.KeyName,
                VW_Ad._.Title                
            };
            DataTable dt = DbSession.Default.From<VW_Ad>().Select(nfields).Where(nwhere).ToDataTable(1000);

            foreach (DataRow dr in dt.Rows)
            {
                ResultString += dr[VW_Ad._.KeyName.Name].ToString() + "$$" + dr[VW_Ad._.Title.Name].ToString().Replace("$$", "").Replace("||", "");
                ResultString += "||";
            }

            //4\结束
            WriteString(ResultString);

        }
         /// <summary>
        /// 发送获取帮助文档列表通知
        /// </summary>
        private static void SendGetHelpByColumn()
        {
            string reason = ClearGF("reason");
            //1\定义变量
            string ColumnID;
            string ResultString = "";

            //2\获取产品数据列表
            ColumnID = GF("columnid");


            //3\绑定数据
            WhereClip nwhere = (VW_Help._.sid.Like(ColumnID + "%")
                && VW_Help._.Enable == true);
            Field[] nfields = new Field[] { 
                VW_Help._.ID,
                VW_Help._.Title                
            };
            DataTable dt = DbSession.Default.From<VW_Help>().Select(nfields).Where(nwhere).ToDataTable(1000);

            foreach (DataRow dr in dt.Rows)
            {//1$$asdf||2$$lksdf
                ResultString += dr[VW_Help._.ID.Name].ToString() + "$$" + dr[VW_Help._.Title.Name].ToString().Replace("$$", "").Replace("||", "");
                ResultString += "||";
            }
            if (!string.IsNullOrEmpty(ResultString))
            {
                ResultString = ResultString.Substring(0, ResultString.Length - 2);
            }
            //4\结束
            WriteString(ResultString);

        }

        /// <summary>
        /// 发送获取帮助文档列表通知
        /// </summary>
        private static void SendGetAgentByColumn()
        {
            string reason = ClearGF("reason");
            //1\定义变量
            string ColumnID;
            string ResultString = "";

            //2\获取产品数据列表
            ColumnID = GF("columnid");


            //3\绑定数据
            WhereClip nwhere = (VW_Agent._.sid.Like(ColumnID + "%")
                && VW_Agent._.Enable == true);
            Field[] nfields = new Field[] { 
                VW_Agent._.ID,
                VW_Agent._.Title                
            };
            DataTable dt = DbSession.Default.From<VW_Agent>().Select(nfields).Where(nwhere).ToDataTable(1000);

            foreach (DataRow dr in dt.Rows)
            {
                ResultString += dr[VW_Agent._.ID.Name].ToString() + "$$" + dr[VW_Agent._.Title.Name].ToString().Replace("$$", "").Replace("||", "");
                ResultString += "||";
            }

            //4\结束
            WriteString(ResultString);

        } 
         
        /// <summary>
        /// 发送获取资讯列表通知
        /// </summary>
        private static void SendGetNewsByColumn()
        {
            string reason = ClearGF("reason");
            //1\定义变量
            string ColumnID, SearchText;
            string ResultString = "";

            //2\获取产品数据列表
            ColumnID = GF("columnid");
            SearchText = GF("searchtext");

            WhereClip nwhere;
            //3\绑定数据
            if (SearchText.Length > 0)
            {
                nwhere = (VW_News._.sid.Like(ColumnID + "%") && VW_News._.Title.Like("%" + SearchText + "%")
                    && VW_News._.Enable == true);
            }
            else
            {
                nwhere = (VW_News._.sid.Like(ColumnID + "%")
                    && VW_News._.Enable == true);
            }
            Field[] nfields = new Field[] { 
                VW_News._.ID,
                VW_News._.Title                
            };
            DataTable dt = DbSession.Default.From<VW_News>().Select(nfields).Where(nwhere).ToDataTable(1000);

            foreach (DataRow dr in dt.Rows)
            {
                ResultString += dr[VW_News._.ID.Name].ToString() + "$$" + dr[VW_News._.Title.Name].ToString().Replace("$$", "").Replace("||", "");
                ResultString += "||";
            }

            //4\结束
            WriteString(ResultString);

        }

        /// <summary>
        /// 发送订单已取消邮件通知
        /// </summary>
        private static void SendOrderCanceledMailNotyfi()
        {
            string reason = ClearGF("reason");
            DateTime orderInputTime = ComUtls.ParseDateTime(GF("orderInputTime"));
            DateTime canceledTime = ComUtls.ParseDateTime(GF("canceledTime"));
            string orderNo = ClearGF("orderNo");
            string mailTo = ClearGF("mailTo");
            bool result = BLL.Order.SendOrderCanceledMailNotify(orderInputTime, orderNo, canceledTime, reason, mailTo);

            WriteString(result ? "1" : "0");
        }

        /// <summary>
        /// 发送订单已付款邮件通知
        /// </summary>
        private static void SendOrderPaidMailNotyfi()
        {
            string paymentTitle = ClearGF("paymentTitle");
            DateTime orderInputTime = ComUtls.ParseDateTime(GF("orderInputTime"));
            DateTime paidTime = ComUtls.ParseDateTime(GF("_paidTime"));
            string orderNo = ClearGF("orderNo");
            string mailTo = ClearGF("mailTo");
            bool result = BLL.Order.SendOrderPaidMailNotify(orderInputTime, orderNo, paymentTitle, paidTime, mailTo);

            WriteString(result ? "1" : "0");
        }

        /// <summary>
        /// 发送订单已发货邮件通知
        /// </summary>
        private static void SendOrderDeliveriedMailNotyfi()
        {
            DateTime deliveriedTime = ComUtls.ParseDateTime(GF("deliveriedTime"));
            DateTime orderInputTime = ComUtls.ParseDateTime(GF("orderInputTime"));
            string orderNo = ClearGF("orderNo");
            string mailTo = ClearGF("mailTo");
            bool result = BLL.Order.SendOrderDeliveriedMailNotify(orderInputTime, orderNo, deliveriedTime, mailTo);

            WriteString(result ? "1" : "0");
        }

        ///// <summary>
        ///// 检查指定文件名称是否存在，如果不存在，则返回false,否则返回true
        ///// </summary>
        ///// <returns></returns>
        //private void CheckFile()
        //{
        //    //1\定义变量
        //    bool ReturnValue;

        //    //2\设置变量值
        //    ReturnValue = false;
        //    string input = HttpUtility.UrlDecode(GetUrlParams("params", ""));
        //    string columntype = HttpUtility.UrlDecode(GetUrlParams("columntype", ""));
        //    int columnid = ComUtls.ParseInt(HttpUtility.UrlDecode(GetUrlParams("columnid", "0")),0);
            
        //    int oid = ComUtls.ParseInt(HttpUtility.UrlDecode(GetUrlParams("oid", "0")), 0);
        //    string pageurl = "";

        //    //3\检查文件是否存在，如果不存在，则返回false,否则返回true
        //    if (columntype == "")//加盟的 没有文件夹，就默认
        //    {
        //        if (NSW.Utls.IOUtls.IsExist(NSW.Utls.IOUtls.GetMapPath(input), NSW.Utls.IOUtls.FsoMethod.File))
        //        {
        //            ReturnValue = true;
        //        }
        //        if (input.IndexOf("_1.html") > -1)
        //        {
        //            input = StringUtls.SubmitString(input, "/agents/", "_1.html");
        //        }
        //        else
        //        {
        //            input = StringUtls.SubmitString(input, "/agents/", ".html");
        //        }
        //    }
        //    else {
        //        DataTable dt = new DataTable();
        //        DataRow[] dr;
        //        string directory = "";
        //        switch (columntype)
        //        {
        //            case "news":
        //                dr = MyTool.GetColumnTreeByColumnType(API.ColumnType.News).Select("Enable=1 and id=" + columnid);
        //                directory = GetDirectoryInfo(dr, null, NSW.OConfig.Common.NewsHtmlTargetPath);
        //                break;
        //            case "help":
        //                dr = MyTool.GetColumnTreeByColumnType(API.ColumnType.Help).Select("Enable=1 and id=" + columnid);
        //                directory = GetDirectoryInfo(dr, null, NSW.OConfig.Common.HelpHtmlTargetPath);
        //                break;
        //            case "product":
        //                VW_Product v = DbSession.Default.Get<VW_Product>(VW_Product._.Enable == 1 && VW_Product._.ID == oid);
        //                if (v != null)
        //                { pageurl = v.PageURL; }
        //                dr = MyTool.GetColumnTreeByColumnType(API.ColumnType.Product).Select("Enable=1 and id=" + columnid);
        //                directory = GetDirectoryInfo(dr, null, NSW.OConfig.Common.ProductHtmlTargetPath);
        //                break;
        //            case "project":
        //                VW_Project vv = DbSession.Default.Get<VW_Project>(VW_Project._.Enable == 1 && VW_Project._.ID == oid);
        //                if (vv != null)
        //                { pageurl = vv.PageURL; }
        //                dr = MyTool.GetColumnTreeByColumnType(API.ColumnType.Project).Select("Enable=1 and id=" + columnid);
        //                directory = GetDirectoryInfo(dr, null, NSW.OConfig.Common.ProjectHtmlTargetPath);
        //                break;
        //            default :
        //                directory = columntype;
        //                break;
        //        }
        //        if (directory != "")
        //        {
        //            if (NSW.Utls.IOUtls.IsExist(NSW.Utls.IOUtls.GetMapPath(directory + input), NSW.Utls.IOUtls.FsoMethod.File) && pageurl != directory + input) // 如果存在并且跟原始的文件名一样的话
        //            {
        //                ReturnValue = true;
        //            }
        //        }
                
        //    }

        //    if (input.IndexOf("_1.html") > -1)
        //    {
        //        input = input.Substring(0, input.IndexOf("_1.html"));
        //    }
        //    else
        //    {
        //        input = input.Substring(0, input.IndexOf(".html"));
        //    }
        //    //3.检查是否和扩展链接冲突
        //    if (DbSession.Default.Get<tbExpandURL>(tbExpandURL._.ExpandURL == input) != null && NSW.OConfig.Common.ReWriteUrlExt == ".html")
        //    { ReturnValue = true; }
        //    //4\返回
        //    HttpContext.Current.Response.Write(ReturnValue.ToString().ToLower());

        //}

        private string NullEmpty(string input, string defaultString)
        {
            return string.IsNullOrEmpty(input) ? defaultString : input;
        }

        private string GetDirectoryInfo(DataRow[] dt,string filed, string defaultString)
        {
            if (string.IsNullOrEmpty(filed)) { filed = "directory"; }
            if (dt.Length>0)
            { 
                string _tmp = dt[0][filed].ToString();
                return string.IsNullOrEmpty(_tmp) ? defaultString : _tmp;
            }
            return defaultString;
        }
        
        #region 获取汉字拼音的首字母
        
        private void OutputFirstLetter() 
        {
            string result = "";
            HttpContext.Current.Response.Clear();
            HttpContext.Current.Response.ContentType = "text/plain";
            //1、读取参数
            string input = HttpUtility.UrlDecode(GetUrlParams("params", ""));
            //2、校验参数
            if (string.IsNullOrEmpty(input))
            {
                HttpContext.Current.Response.Write("error");
                return;
            }
            byte[] _cBs = System.Text.Encoding.Default.GetBytes(input);

            if(_cBs.Length<2)
                result=input;

           byte ucHigh, ucLow;
           int  nCode;

           string strFirstLetter = string.Empty;

            for (int i = 0; i < _cBs.Length; i++)
           {

                if (_cBs[i] < 0x80)
                {
                    strFirstLetter += Encoding.Default.GetString(_cBs, i, 1);
                    continue;
               }

                ucHigh = (byte)_cBs[i];
               ucLow = (byte)_cBs[i + 1];
                if ( ucHigh < 0xa1 || ucLow < 0xa1)
                    continue;
                else
                // Treat code by section-position as an int type parameter,
                // so make following change to nCode.
                   nCode = (ucHigh - 0xa0) * 100 + ucLow - 0xa0;

                string str = FirstLetter(nCode);
                
                strFirstLetter += str != string.Empty ? str : Encoding.Default.GetString(_cBs, i, 2);
                i++;
            }
            result = strFirstLetter;
            //3\过滤非法字符
            Regex reg = new Regex(@"[^0-9A-Za-z_]");
            result = reg.Replace(result, "").ToLower();
            //KeyValuePair<string, string> state, outpot;
            //DbSession.Default.f
            
            //WriteXml(new  List<KeyValuePair<string,string>>
            HttpContext.Current.Response.Write(result);
        }
        public  string FirstLetter(int nCode)
        {
            string strLetter = string.Empty;

            if (nCode >= 1601 && nCode < 1637) strLetter = "A";
            if (nCode >= 1637 && nCode < 1833) strLetter = "B";
            if (nCode >= 1833 && nCode < 2078) strLetter = "C";
            if (nCode >= 2078 && nCode < 2274) strLetter = "D";
            if (nCode >= 2274 && nCode < 2302) strLetter = "E";
            if (nCode >= 2302 && nCode < 2433) strLetter = "F";
            if (nCode >= 2433 && nCode < 2594) strLetter = "G";
            if (nCode >= 2594 && nCode < 2787) strLetter = "H";
            if (nCode >= 2787 && nCode < 3106) strLetter = "J";
            if (nCode >= 3106 && nCode < 3212) strLetter = "K";
            if (nCode >= 3212 && nCode < 3472) strLetter = "L";
            if (nCode >= 3472 && nCode < 3635) strLetter = "M";
            if (nCode >= 3635 && nCode < 3722) strLetter = "N";
            if (nCode >= 3722 && nCode < 3730) strLetter = "O";
            if (nCode >= 3730 && nCode < 3858) strLetter = "P";
            if (nCode >= 3858 && nCode < 4027) strLetter = "Q";
            if (nCode >= 4027 && nCode < 4086) strLetter = "R";
            if (nCode >= 4086 && nCode < 4390) strLetter = "S";
            if (nCode >= 4390 && nCode < 4558) strLetter = "T";
            if (nCode >= 4558 && nCode < 4684) strLetter = "W";
            if (nCode >= 4684 && nCode < 4925) strLetter = "X";
            if (nCode >= 4925 && nCode < 5249) strLetter = "Y";
            if (nCode >= 5249 && nCode < 5590) strLetter = "Z";
            if (nCode == 5958) strLetter = "Z";
            if (nCode >= 5601 && nCode < 8794 && nCode != 5958) 
            {
                string CodeData = "cjwgnspgcenegyPBtwxzdxykygtpjnmjqmbsgzscyjsyyfpggbzgydywjkgaljswkbjqhyjwpdzlsgmr"
+ "ybywwccgznkydgttngjeyekzydcjnmcylqlypyqbqrpzslwbdgkjfyxjwcltbncxjjjjcxdtqsqzycdxxhgckbphffss"
+ "pybgmxjbbyglbhlssmzmpjhsojnghdzcdklgjhsgqzhxqgkezzwymcscjnyetxadzpmdssmzjjqjyzcjjfwqjbdzbjgd"
+ "nzcbwhgxhqkmwfbpbqdtjjzkqhylcgxfptyjyyzpsjlfchmqshgmmxsxjpkdcmbbqbefsjwhwwgckpylqbgldlcctnma"
+ "eddksjngkcsgxlhzaybdbtsdkdylhgymylcxpycjndqjwxqxfyyfjlEJBzrwccqhqcsbzkymgplbmcrqcflnymyqmsqt"
+ "rbcjthztqfrxchxmcjcjlxqgjmshzkbswxemdlckfsydsglycjjssjnqbjctyhbftdcyjdgwyghqfrxwckqkxebpdjpx"
+ "jqsrmebwgjlbjslyysmdxlclqkxlhtjrjjmbjhxhwywcbhtrxxglhjhfbmgykldyxzpplggpmtcbbajjzyljtyanjgbj"
+ "flqgdzyqcaxbkclecjsznslyzhlxlzcghbxzhznytdsbcjkdlzayffydlabbgqszkggldndnyskjshdlxxbcghxyggdj"
+ "mmzngmmccgwzszxsjbznmlzdthcqydbdllscddnlkjyhjsycjlkohqasdhnhcsgaehdaashtcplcpqybsdmpjlpcjaql"
+ "cdhjjasprchngjnlhlyyqyhwzpnccgwwmzffjQQqqxxaclbhkdjxdgmmydjxzllsygxgkjrywzwyclzmcsjzldbndcfc"
+ "xyhlschycjqppqagmnyxpfrkssbjlyxyjjglnscmhcwwmnzjjlhmhchsyppttxrycsxbyhcsmxjsxnbwgpxxtaybgajc"
+ "xlypdccwqocwkccsbnhcpdyznbcyytyckskybsqkkytqqxfcwchcwkelcqbsqyjqcclmthsywhmktlkjlychwheqjhtj"
+ "hppqpqscfymmcmgbmhglgsllysdllljpchmjhwljcyhzjxhdxjlhxrswlwzjcbxmhzqxsdzpmgfcsglsdymjshxpjxom"
+ "yqknmyblrthbcftpmgyxlchlhlzylxgsssscclsldclepbhshxyyfhbmgdfycnjqwlqhjjcywjztejjdhfblqxtqkwhd"
+ "chqxagtlxljxmsljhdzkzjecxjcjnmbbjcsfywkbjzghysdcpqyrsljpclpwxsdwejbjcbcnaytmgmbapclyqbclzxcb"
+ "nmsggfnzjjbzsfqyndxhpcqkzczwalsbccjxpozgwkybsgxfcfcdkhjbstlqfsgdslqwzkxtmhsbgzhjcrglyjbpmljs"
+ "xlcjqqhzmjczydjwbmjklddpmjegxyhylxhlqyqhkycwcjmyhxnatjhyccxzpcqlbzwwwtwbqcmlbmynjcccxbbsnzzl"
+ "jpljxyztzlgcldcklyrzzgqtgjhhgjljaxfgfjzslcfdqzlclgjdjcsnclljpjqdcclcjxmyzftsxgcgsbrzxjqqcczh"
+ "gyjdjqqlzxjyldlbcyamcstylbdjbyregklzdzhldszchznwczcllwjqjjjkdgjcolbbzppglghtgzcygezmycnqcycy"
+ "hbhgxkamtxyxnbskyzzgjzlqjdfcjxdygjqjjpmgwgjjjpkjsbgbmmcjssclpqpdxcdyykypcjddyygywchjrtgcnyql"
+ "dkljczzgzccjgdyksgpzmdlcphnjafyzdjcnmwescsglbtzcgmsdllyxqsxsbljsbbsgghfjlwpmzjnlyywdqshzxtyy"
+ "whmcyhywdbxbtlmswyyfsbjcbdxxlhjhfpsxzqhfzmqcztqcxzxrdkdjhnnyzqqfnqdmmgnydxmjgdhcdycbffallztd"
+ "ltfkmxqzdngeqdbdczjdxbzgsqqddjcmbkxffxmkdmcsychzcmljdjynhprsjmkmpcklgdbqtfzswtfgglyplljzhgjj"
+ "gypzltcsmcnbtjbhfkdhbyzgkpbbymtdlsxsbnpdkleycjnycdykzddhqgsdzsctarlltkzlgecllkjljjaqnbdggghf"
+ "jtzqjsecshalqfmmgjnlyjbbtmlycxdcjpldlpcqdhsycbzsckbzmsljflhrbjsnbrgjhxpdgdjybzgdlgcsezgxlblg"
+ "yxtwmabchecmwyjyzlljjshlgndjlslygkdzpzxjyyzlpcxszfgwyydlyhcljscmbjhblyjlycblydpdqysxktbytdkd"
+ "xjypcnrjmfdjgklccjbctbjddbblblcdqrppxjcglzcshltoljnmdddlngkaqakgjgyhheznmshrphqqjchgmfprxcjg"
+ "dychghlyrzqlcngjnzsqdkqjymszswlcfqjqxgbggxmdjwlmcrnfkkfsyyljbmqammmycctbshcptxxzzsmphfshmclm"
+ "ldjfyqxsdyjdjjzzhqpdszglssjbckbxyqzjsGPSxjzqznqtbdkwxjkhhgflbcsmdldgdzdblzkycqnncsybzbfglzzx"
+ "swmsccmqnjqsbdqsjtxxmbldxcclzshzcxrqjgjylxzfjphymzqqydfqjjlcznzjcdgzygcdxmzysctlkphtxhtlbjxj"
+ "lxscdqccbbqjfqzfsltjbtkqbsxjjljchczdbzjdczjccprnlqcgpfczlclcxzdmxmphgsgzgszzqjxlwtjpfsyaslcj"
+ "btckwcwmytcsjjljcqlwzmalbxyfbpnlschtgjwejjxxglljstgshjqlzfkcgnndszfdeqfhbsaqdgylbxmmygszldyd"
+ "jmjjrgbjgkgdhgkblgkbdmbylxwcxyttybkmrjjzxqjbhlmhmjjzmqasldcyxyqdlqcafywyxqhz";
                String _gbcode = nCode.ToString();
                int pos = (Convert.ToInt16(_gbcode.Substring(0, 2)) - 56) * 94 + Convert.ToInt16(_gbcode.Substring(_gbcode.Length - 2, 2));
                strLetter=CodeData.Substring(pos - 1, 1);
            }
            //if (strLetter == string.Empty) 
            //{
            //    string str="";
            //    OutputPinYin(strLetter, out str);
            //    strLetter = str;
            //}
            //    System.Windows.Forms.MessageBox.Show(String.Format("信息：/n{0}为非常用字符编码,不能为您解析相应匹配首字母！",nCode));
            return strLetter;
        }
        #endregion
        
        #region 汉字转拼音
        private System.Collections.Hashtable ht;
        private string g(int num)
        {
            if (num < -20319 || num > -10247)
                return "";
            while (!ht.ContainsKey(num))
                num--;
            return ht[num].ToString();
        }
       
        /// <summary>
        /// 把汉字转换为全拼输入
        /// </summary>
        /// <param name="hz">录入的汉字，类型：字符串</param>
        /// <returns>经过转换的拼音全拼字符串</returns>
        private void OutputPinYin()
        {
            HttpContext.Current.Response.Clear();
            HttpContext.Current.Response.ContentType = "text/plain";
            //1、读取参数
            string input = HttpUtility.UrlDecode(GetUrlParams("params", ""));
            //2、校验参数
            if (string.IsNullOrEmpty(input))
            {
                HttpContext.Current.Response.Write("error");
                return;
            }
            //1、获取汉字表
            if (HttpContext.Current.Cache["HanZiTable"] == null)
            {
                GetHanZiTable();
            }
            ht = (System.Collections.Hashtable)HttpContext.Current.Cache["HanZiTable"];

            //2、开始翻译
            byte[] b = System.Text.Encoding.Default.GetBytes(input);
            int p;
            StringBuilder ret = new StringBuilder();
            for (int i = 0; i < b.Length; i++)
            {
                p = (int)b[i];
                if (p > 160)
                {
                    p = p * 256 + b[++i] - 65536;
                    ret.Append(g(p));
                }
                else
                {
                    ret.Append((char)p);
                }
            }
            string result = ret.ToString();
            //3\过滤非法字符
            Regex reg = new Regex(@"[^0-9A-Za-z_]");
            result = reg.Replace(result, "");
            HttpContext.Current.Response.Write(result);
        }
        #endregion

        #region ***常用对象***

        /// <summary>
        /// 检查类型枚举
        /// </summary>
        public enum CheckingType
        {
            ForbiddenIP = 1,
            BlockToSubmitIPs = 5,
            GlobalCommentabled = 2,
            VerifyCode = 3,
            GlobalSubmittingFrequency = 4
        }

        /// <summary>
        /// 输出 XML 对象
        /// </summary>
        /// <param name="node">节点</param>
        protected static void WriteXml(params KeyValuePair<string, string>[] nodes)
        {

            string xmlCode = "<?xml version=\"1.0\" encoding=\"utf-8\"?>"
                                + "<root>"
                                + "{node}"
                                + "</root>";

            StringBuilder sbNodes = new StringBuilder();

            foreach (KeyValuePair<string, string> node in nodes)
            {
                sbNodes.AppendFormat("<node key=\"{0}\">{1}</node>",
                    node.Key,
                   HttpUtility.HtmlEncode(node.Value));
            }

            xmlCode = xmlCode.Replace("{node}", sbNodes.ToString());

            HttpContext.Current.Response.ContentType = "text/xml";
            HttpContext.Current.Response.Write(xmlCode);
            HttpContext.Current.Response.Flush();
            HttpContext.Current.Response.End();
        }

        /// <summary>
        /// 输出 XML 对象
        /// </summary>
        /// <param name="node">节点</param>
        protected static void WriteXml(string xml)
        {
            HttpContext.Current.Response.Clear();
            HttpContext.Current.Response.ContentType = "text/xml";
            HttpContext.Current.Response.ContentEncoding = System.Text.Encoding.UTF8;
            HttpContext.Current.Response.Write(xml);
            HttpContext.Current.Response.End();

            //HttpContext.Current.Response.ContentType = "text/xml";
            //HttpContext.Current.Response.Write(xml);
            //HttpContext.Current.Response.Flush();
            //HttpContext.Current.Response.End();
        }

        protected static void WriteXml(List<KeyValuePair<string, string>> listNodes)
        {
            KeyValuePair<string, string>[] nodes = new KeyValuePair<string, string>[listNodes.Count];

            for (int i = 0; i < listNodes.Count; ++i)
            {
                nodes[i] = listNodes[i];
            }

            WriteXml(nodes);
        }
        
        /// <summary>
        /// 安全检查
        /// </summary>
        /// <param name="verCode">源验证码，如果不检查验证，则传递null</param>
        /// <param name="checkingTypes">检查类型参数组</param>
        /// <returns>检查是否通过</returns>
        private static bool SecurityCheck(string verCode, params CheckingType[] checkingTypes)
        {
            //bool rtnVal = true;

            if (Contain(checkingTypes, CheckingType.ForbiddenIP))
            {
                if (ComUtls.IsForbiddenIP(OConfig.GlobalConfig.ForbiddenIPs, IP))
                {
                    WriteString(ORes.Error.TheIpIsForbidToSubmitData);
                    return false;
                }
            }


            if (Contain(checkingTypes, CheckingType.BlockToSubmitIPs))
            {
                if (ComUtls.IsForbiddenIP(OConfig.GlobalConfig.BlockToSubmitIPs, IP))
                {
                    WriteString(ORes.Error.TheIpIsForbidden);
                    return false;
                }
            }

            if (Contain(checkingTypes, CheckingType.GlobalCommentabled))
            {
                if (!OConfig.GlobalConfig.Commentabled)
                {
                    WriteString(ORes.Error.CommentIsClosedBySystem);
                    return false;
                }
            }

            if (Contain(checkingTypes, CheckingType.GlobalSubmittingFrequency))
            {
                if (!BLL.OSecurity.CheckSubmitFrequency(OConfig.GlobalConfig.GlobalSubmitDataInterval))
                {
                    WriteString(ORes.Error.ToAvoidMaliceSubmittingPlsWaitAndResubmit);
                    return false;
                }
            }

            if (Contain(checkingTypes, CheckingType.VerifyCode) && verCode != null)
            {
                if (verCode.Length == 0)
                {
                    WriteString(ORes.Error.VerifyCodeIsRequiredField);
                    return false;
                }

                if (!CheckVerifyCode(verCode))
                {
                    WriteString(ORes.Error.VerifyCodeIsInvalidPlsRefreshAndTryAgain);
                    return false;
                }
            }

            return true;
        }


        private static bool Contain(CheckingType[] checkingTypes, CheckingType checking)
        {
            foreach (CheckingType item in checkingTypes)
            {
                if (item == checking)
                    return true;
            }

            return false;
        }

        /// <summary>
        /// 从 URL 解析参数[Request.QueryString]，解析失败则返回 string.Empty
        /// </summary>
        /// <param name="paraName">参数名</param>
        /// <returns>参数值</returns>
        protected static string QS(string paraName)
        {
            string s = HttpContext.Current.Request.QueryString[paraName];
            return s == null ? string.Empty : s;
        }

        /// <summary>
        /// 从 URL 解析参数[Request.QueryString]，解析失败则返回 默认值;
        /// </summary>
        /// <param name="paraName">参数名</param>
        /// <param name="defaultVal">默认值</param>
        /// <returns>参数值</returns>
        protected static string QS(string paraName, string defaultVal)
        {
            string s = HttpContext.Current.Request.QueryString[paraName];
            return s == null ? defaultVal : s;
        }

        /// <summary>
        /// 获取表单值Request.Form并编码，获取失败则返回 string.Empty
        /// </summary>
        /// <param name="paraName"></param>
        /// <returns></returns>
        private static string ClearGF(string paraName)
        {
            return HttpUtility.HtmlEncode(GF(paraName));
        }

        private const string StrRegex = @"^\+/v(8|9)|\b(and|or)\b.{1,6}?(=|>|<|\bin\b|\blike\b)|/\*.+?\*/|<\s*script\b|\bEXEC\b|UNION.+?SELECT|UPDATE.+?SET|INSERT\s+INTO.+?VALUES|(SELECT|DELETE).+?FROM|(CREATE|ALTER|DROP|TRUNCATE)\s+(TABLE|DATABASE)";
        /// <summary>
        /// 获取表单值Request.Form，获取失败则返回 string.Empty
        /// </summary>
        /// <param name="paraName">参数名</param>
        /// <returns>参数值</returns>
        private static string GF(string paraName)
        {
            //string val = HttpContext.Current.Request.Form[paraName];
            //return val == null ? string.Empty : val.Trim();
            string val = HttpContext.Current.Request.Form[paraName];
            if (val == null) { return ""; }
            if (Regex.IsMatch(val, StrRegex))
            {
                //HttpContext.Current.Response.Write("您提交的参数不合法！");
                //HttpContext.Current.Response.End();
                WriteJson(false, "您提交的参数不合法！");
                return "";
            }
            else
            {
                return val == null ? string.Empty : val.Trim();
            }
        }

        /// <summary>
        /// 获取表单值Request.Form，获取失败则返回默认值
        /// </summary>
        /// <param name="paraName">参数名</param>
        /// <param name="defaultVal">默认值</param>
        /// <returns>参数值</returns>
        private static string GF(string paraName, string defaultVal)
        {
            string val = HttpContext.Current.Request.Form[paraName];
            return val == null ? defaultVal : val.Trim();
        }

        /// <summary>
        /// 获取客户端IP地址
        /// </summary>
        protected static string IP
        {
            get
            {
                return ComUtls.HostAddress;
            }
        }

        /// <summary>
        /// 检查验证码
        /// </summary>
        /// <param name="verCode">源验证码</param>
        /// <returns>是否正确</returns>
        protected static bool CheckVerifyCode(string verCode)
        {
            return BLL.OSecurity.CheckVerifyCode(verCode);
        }

        /// <summary>
        /// 输出字符串
        /// </summary>
        /// <param name="str">字符串</param>
        protected static void WriteString(string str)
        {
            HttpContext.Current.Response.ContentType = "plain/text";
            HttpContext.Current.Response.Write(str);
            HttpContext.Current.Response.Flush();
            HttpContext.Current.Response.End();
        }

        protected static void WriteString(string format, params object[] args)
        {
            WriteString(string.Format(format, args));
        }

        public bool IsReusable
        {
            get
            {
                return false;
            }
        }
        #endregion

        #region 读取url参数值
        /// <summary>
        /// 读取url参数值
        /// </summary>
        /// <param name="paramName"></param>
        /// <param name="defaultValue"></param>
        /// <returns></returns>
        private string GetUrlParams(string paramName, string defaultValue)
        {
            string tmp = HttpContext.Current.Request[paramName];
            if (string.IsNullOrEmpty(tmp))
                return defaultValue;
            return tmp.Replace("'", "''");
        }
        #endregion
        /// <summary>
        /// 输出字符串
        /// </summary>
        /// <param name="str">字符串</param>
        protected static void WriteJson(bool state,string msg)
        {
            Hashtable hash = new Hashtable();
            hash["error"] = state ? 1 : 0;
            hash["msg"] = msg;
            HttpContext.Current.Response.AddHeader("Content-Type", "text/html; charset=UTF-8");
            HttpContext.Current.Response.Write(JsonMapper.ToJson(hash));
            HttpContext.Current.Response.Flush();
            HttpContext.Current.Response.End();
        }

        public bool CheckPermission(string Permission)
        {
            string url = HttpContext.Current.Request.UrlReferrer.ToString().ToLower();
            string key = "/" + NSW.OConfig2.PrivateSet.OverrideManagerPath + "/";
            key = key.ToLower();
            if (string.IsNullOrEmpty(url) || !url.Contains(key))
            {
                WriteJson(false, "来源可疑，系统忽略该次请求。");
                return false;
            }
            url = url.Substring(url.IndexOf(key) + key.Length);
            return NSW.BLL.Admin.CheckPermission(key, Permission);
        }

        /// <summary>
        /// 根据类型获取提示
        /// </summary>
        /// <param name="type"></param>
        /// <returns></returns>
        private static string GetTypeTitle(string typename)
        {
            string tips = string.Empty;
            if (!string.IsNullOrEmpty(typename))
            {
                tips = TypeTitle[typename] as string;
                if (!string.IsNullOrEmpty(tips))
                {
                    return tips;
                }
            }
            tips = ClearGF("pagetitle");
            if (!string.IsNullOrEmpty(tips)) {
                return tips;
            }
            return QS("pagetitle", "");
        }

        public bool CheckPermission_(string url, string Permission) {
            
            return OSession.Admin.Username.Equals(NSW.BLL.Admin.AdminPermission.AllPERMISSION) || OSession.Admin.ID.Equals(8) || NSW.BLL.Admin.CheckPermission(url, Permission);
        }
        public bool CheckPermission(string type, string Permission)
        {
            type = type.ToLower();
            if (PageHash.ContainsKey(type))
            {
                string page = PageHash[type].ToString();
                if (page.Contains("#")) {
                    string _page = page.Substring(0, page.LastIndexOf("#"));
                    string permissions = "," + page.Replace(_page, "") + ",";
                    if (permissions.Contains(Permission)) {
                        return NSW.BLL.Admin.CheckPermission(BLL.Admin.AdminPermission.AllPERMISSION);
                    }
                    page = _page;
                }
                return CheckPermission_(page, Permission);
            }
            else if (type.EndsWith(".aspx"))
            {
                return CheckPermission_(type, Permission);
            }
            else {
                WriteJson(false, "来源可疑，系统忽略该次请求。");
                return false;
            }
        }

        private static Hashtable _TypeTitle;
        public static Hashtable TypeTitle
        {
            get
            {
                if (_TypeTitle == null)
                {
                    _TypeTitle = new Hashtable();
                    _TypeTitle.Add("product", "产品");
                    _TypeTitle.Add("productcolumn", "产品分类");

                    _TypeTitle.Add("download", "下载");
                    _TypeTitle.Add("downloadcolumn", "下载分类");
                    
                    _TypeTitle.Add("project", "方案");
                    _TypeTitle.Add("projectcolumn", "方案分类");

                    _TypeTitle.Add("news", "资讯");
                    _TypeTitle.Add("newscolumn", "资讯分类");

                    _TypeTitle.Add("help", "帮助");
                    _TypeTitle.Add("helpcolumn", "帮助分类");

                    _TypeTitle.Add("agent", "招商加盟");
                    _TypeTitle.Add("agentcolumn", "加盟分类");

                    _TypeTitle.Add("productattributecolumn", "产品属性");

                    _TypeTitle.Add("projectattributecolumn", "方案属性");

                    _TypeTitle.Add("picture", "图库");

                    _TypeTitle.Add("admin_systemmenu", "系统菜单");

                    _TypeTitle.Add("vpage", "微网页");
                }
                return _TypeTitle;
            }
            set { _TypeTitle = value; }
        }

        private Hashtable _PageHash;
        public Hashtable PageHash
        {
            get
            {
                if (_PageHash == null)
                {
                    _PageHash = new Hashtable();
                    _PageHash.Add("product", "products.aspx");
                    _PageHash.Add("productcolumn", "product_column.aspx");

                    _PageHash.Add("download", "downloads.aspx");
                    _PageHash.Add("downloadcolumn", "download_column.aspx");
                    
                    _PageHash.Add("project", "projects.aspx");
                    _PageHash.Add("projectcolumn", "project_column.aspx");

                    _PageHash.Add("news", "news.aspx");
                    _PageHash.Add("newscolumn", "news_column.aspx");

                    _PageHash.Add("help", "helps.aspx");
                    _PageHash.Add("helpcolumn", "help_column.aspx");

                    _PageHash.Add("agent", "agents.aspx");
                    _PageHash.Add("agentcolumn", "agent_column.aspx");

                    _PageHash.Add("dellog", "admin_systemlog.aspx");
                    //_PageHash.Add("deladmin", "admin_admin.aspx");
                    _PageHash.Add("systemmenu", "admin_systemmenu.aspx#delpermission,updatepermission");
                    _PageHash.Add("admin", "admin_admin.aspx#insertpermission,updatepermission");
                    _PageHash.Add("usergroup", "usergroup.aspx");
                    _PageHash.Add("users", "users.aspx");
                    _PageHash.Add("menu", "Mune_config.aspx");
                    _PageHash.Add("firendlink", "friend_links_edit.aspx");
                    _PageHash.Add("jobcolumns", "jobs.aspx");
                    _PageHash.Add("keywordcolumns", "keywords.aspx");
                    _PageHash.Add("nvcontrols", "nvcontrols.aspx");
                    _PageHash.Add("sitepagecolumn", "sitepage.aspx");
                    _PageHash.Add("tagcolumn", "tags.aspx");
                    _PageHash.Add("tbleavemessage", "tbleavemessage.aspx");
                    _PageHash.Add("tbforms", "tbforms.aspx");

                    _PageHash.Add("productattributecolumn", "product_attribute.aspx");
                    _PageHash.Add("projectattributecolumn", "project_attribute.aspx");

                    _PageHash.Add("pdcomment", "product_comment.aspx");
                    _PageHash.Add("pjcomment", "project_comment.aspx");
                    _PageHash.Add("newscomment", "news_comment.aspx");
                    _PageHash.Add("agentcomment", "agent_comment.aspx");
                    _PageHash.Add("helpcomment", "help_comment.aspx");

                    _PageHash.Add("picture", "pictures.aspx#delpermission,updatepermission");

                    _PageHash.Add("templatecolumn", "template.aspx#delpermission,updatepermission");

                    _PageHash.Add("admin_systemmenu", "admin_systemmenu.aspx");
                    _PageHash.Add("video", "video_edit.aspx");

                    //界面权限
                    _PageHash.Add("ad_column.aspx", "ads.aspx");
                    _PageHash.Add("template_column.aspx", "template.aspx");

                    _PageHash.Add("job_column.aspx", "jobs.aspx");
                    _PageHash.Add("tbleavemessage.aspx", "tbforms.aspx");
                }
                return _PageHash;
            }
            set { _PageHash = value; }
        }

        private static Hashtable _ColumnSqlTemp;
        public static Hashtable ColumnSqlTemp
        {
            get
            {
                if (_ColumnSqlTemp == null)
                {
                    _ColumnSqlTemp = new Hashtable();
                    _ColumnSqlTemp.Add("productcolumn", @"
INSERT INTO [tbProductColumn]
    ([Title]
    ,[ParentID]
    ,[Directory]
    ,[TitleKeyword]
    ,[PageTitle]
    ,[MetaKeyword]
    ,[MetaDescription]
    ,[PhotoName]
    ,[PhotoPath]
    ,[DefaultTag]
    ,[URL]
    ,[ShortDesc]
    ,[Attribute]
    ,[BrankName]
    ,[Icon]
    ,[ExtendTag]
    ,[isShowSubFolder]
    ,[isShowMsg]
    ,[MsgTags]
    ,[MsgNewsIDs]
    ,[isShowAD]
    ,[ADKeyword]
    ,[isShowCommend]
    ,[Discount]
    ,[OrderID]
    ,[isCommend]
    ,[isBest]
    ,[isTop]
    ,[Enable]
    ,[InputTime]
    ,[ExpandURL]
    ,[Height]
    ,[Width]
    ,[MShowDetail]
    ,[ParsePage]
    ,[MParsePage]
    ,[Authority]
    ,[isFullScreen]
    ,[BannerPath]
    ,[BannerAlt]
    ,[BannerURL]
    ,[BannerHeight]
    ,[PageSize]
    ,[MsgProductIDs]
    ,[isShowDesc]
    ,[CustomFields01]
    ,[CustomFields02]
    ,[TempPath])
VALUES
    ('{0}'
    ,{1}
    ,'{3}'
    ,''
    ,''
    ,''
    ,''
    ,''
    ,''
    ,''
    ,''
    ,''
    ,''
    ,''
    ,''
    ,''
    ,0
    ,0
    ,''
    ,''
    ,0
    ,''
    ,0
    ,0
    ,50
    ,0
    ,0
    ,0
    ,1
    ,getdate()
    ,dbo.procGetPY('{0}',10)
    ,0
    ,0
    ,1
    ,''
    ,''
    ,''
    ,0
    ,''
    ,''
    ,''
    ,''
    ,20
    ,''
    ,0
    ,''
    ,''
    ,'{4}');
");
                    _ColumnSqlTemp.Add("projectcolumn", @"
INSERT INTO [tbProjectColumn]
    ([Title]
    ,[ParentID]
    ,[Directory]
    ,[TitleKeyword]
    ,[PageTitle]
    ,[MetaKeyword]
    ,[MetaDescription]
    ,[PhotoName]
    ,[PhotoPath]
    ,[DefaultTag]
    ,[URL]
    ,[ShortDesc]
    ,[Attribute]
    ,[BrankName]
    ,[Icon]
    ,[ExtendTag]
    ,[isShowSubFolder]
    ,[isShowMsg]
    ,[MsgTags]
    ,[MsgNewsIDs]
    ,[isShowAD]
    ,[ADKeyword]
    ,[isShowCommend]
    ,[Discount]
    ,[OrderID]
    ,[isCommend]
    ,[isBest]
    ,[isTop]
    ,[Enable]
    ,[InputTime]
    ,[ExpandURL]
    ,[Height]
    ,[Width]
    ,[MShowDetail]
    ,[ParsePage]
    ,[MParsePage]
    ,[Authority]
    ,[isFullScreen]
    ,[BannerPath]
    ,[BannerAlt]
    ,[BannerURL]
    ,[BannerHeight]
    ,[PageSize]
    ,[MsgProductIDs]
    ,[isShowDesc]
    ,[CustomFields01]
    ,[CustomFields02]
    ,[TempPath])
VALUES
    ('{0}'
    ,{1}
    ,'{3}'
    ,''
    ,''
    ,''
    ,''
    ,''
    ,''
    ,''
    ,''
    ,''
    ,''
    ,''
    ,''
    ,''
    ,0
    ,0
    ,''
    ,''
    ,0
    ,''
    ,0
    ,0
    ,50
    ,0
    ,0
    ,0
    ,1
    ,getdate()
    ,dbo.procGetPY('{0}',10)
    ,0
    ,0
    ,1
    ,''
    ,''
    ,''
    ,0
    ,''
    ,''
    ,''
    ,''
    ,20
    ,''
    ,0
    ,''
    ,''
    ,'{4}');
");

                    _ColumnSqlTemp.Add("newscolumn", @"
INSERT INTO [tbNewsColumn]
    ([Title]
    ,[ParentID]
    ,[Directory]
    ,[PageTitle]
    ,[MetaKeyword]
    ,[MetaDescription]
    ,[TitleKeyword]
    ,[DefaultTag]
    ,[PhotoName]
    ,[PhotoPath]
    ,[ShowDetail]
    ,[ShortDesc]
    ,[URL]
    ,[OrderID]
    ,[Enable]
    ,[IsOpen]
    ,[InputTime]
    ,[ExpandURL]
    ,[Height]
    ,[Width]
    ,[MShowDetail]
    ,[ParsePage]
    ,[MParsePage]
    ,[isFullScreen]
    ,[BannerPath]
    ,[BannerAlt]
    ,[BannerURL]
    ,[BannerHeight]
    ,[PageSize]
    ,[MsgProductIDs]
    ,[isShowDesc]
    ,[CustomFields01]
    ,[CustomFields02]
    ,[isCommend]
    ,[isBest]
    ,[isTop]
    ,[Authority]
    ,[Icon]
    ,[isShowIntroduction]
    ,[ShowType]
    ,[TempPath])
VALUES
    ('{0}'
    ,{1}
    ,'{3}'
    ,''
    ,''
    ,''
    ,''
    ,''
    ,''
    ,''
    ,0
    ,''
    ,''
    ,50
    ,1
    ,0
    ,getdate()
    ,dbo.procGetPY('{0}',10)
    ,0
    ,0
    ,1
    ,''
    ,''
    ,0
    ,''
    ,''
    ,''
    ,''
    ,20
    ,''
    ,0
    ,''
    ,''
    ,0
    ,0
    ,0
    ,''
    ,''
    ,0
    ,1
    ,'{4}');
");
                    _ColumnSqlTemp.Add("helpcolumn", @"
INSERT INTO [tbHelpColumn]
    ([Title]
    ,[ParentID]
    ,[Directory]
    ,[PageTitle]
    ,[MetaKeyword]
    ,[MetaDescription]
    ,[TitleKeyword]
    ,[DefaultTag]
    ,[PhotoName]
    ,[PhotoPath]
    ,[ShowDetail]
    ,[ShortDesc]
    ,[URL]
    ,[OrderID]
    ,[Enable]
    ,[IsOpen]
    ,[InputTime]
    ,[ExpandURL]
    ,[Height]
    ,[Width]
    ,[MShowDetail]
    ,[ParsePage]
    ,[MParsePage]
    ,[isFullScreen]
    ,[BannerPath]
    ,[BannerAlt]
    ,[BannerURL]
    ,[BannerHeight]
    ,[PageSize]
    ,[MsgProductIDs]
    ,[isShowDesc]
    ,[CustomFields01]
    ,[CustomFields02]
    ,[isCommend]
    ,[isBest]
    ,[isTop]
    ,[Authority]
    ,[Icon]
    ,[isShowIntroduction]
    ,[ShowType]
    ,[TempPath])
VALUES
    ('{0}'
    ,{1}
    ,'{3}'
    ,''
    ,''
    ,''
    ,''
    ,''
    ,''
    ,''
    ,0
    ,''
    ,''
    ,50
    ,1
    ,0
    ,getdate()
    ,dbo.procGetPY('{0}',10)
    ,0
    ,0
    ,1
    ,''
    ,''
    ,0
    ,''
    ,''
    ,''
    ,''
    ,20
    ,''
    ,0
    ,''
    ,''
    ,0
    ,0
    ,0
    ,''
    ,''
    ,0
    ,1
    ,'{4}');
");
                    _ColumnSqlTemp.Add("agentcolumn", @"INSERT INTO [tbAgentColumn]
    ([Title]
    ,[ParentID]
    ,[Directory]
    ,[PageTitle]
    ,[MetaKeyword]
    ,[MetaDescription]
    ,[TitleKeyword]
    ,[DefaultTag]
    ,[PhotoName]
    ,[PhotoPath]
    ,[ShowDetail]
    ,[ShortDesc]
    ,[URL]
    ,[OrderID]
    ,[Enable]
    ,[IsOpen]
    ,[InputTime]
    ,[ExpandURL]
    ,[Height]
    ,[Width]
    ,[MShowDetail]
    ,[ParsePage]
    ,[MParsePage]
    ,[isFullScreen]
    ,[BannerPath]
    ,[BannerAlt]
    ,[BannerURL]
    ,[BannerHeight]
    ,[PageSize]
    ,[MsgProductIDs]
    ,[isShowDesc]
    ,[CustomFields01]
    ,[CustomFields02]
    ,[isCommend]
    ,[isBest]
    ,[isTop]
    ,[Authority]
    ,[Icon]
    ,[isShowIntroduction]
    ,[ShowType]
    ,[TempPath])
VALUES
    ('{0}'
    ,{1}
    ,'{3}'
    ,''
    ,''
    ,''
    ,''
    ,''
    ,''
    ,''
    ,0
    ,''
    ,''
    ,50
    ,1
    ,0
    ,getdate()
    ,dbo.procGetPY('{0}',10)
    ,0
    ,0
    ,1
    ,''
    ,''
    ,0
    ,''
    ,''
    ,''
    ,''
    ,20
    ,''
    ,0
    ,''
    ,''
    ,0
    ,0
    ,0
    ,''
    ,''
    ,0
    ,1
    ,'{4}');
");
                }
                return _ColumnSqlTemp;
            }
            set { _ColumnSqlTemp = value; }
        }


        /// <summary>
        /// 把汉字表存放到Cache里面
        /// </summary>
        private void GetHanZiTable()
        {
            ht = new System.Collections.Hashtable();
            ht.Add(-20319, "a");
            ht.Add(-20317, "ai");
            ht.Add(-20304, "an");
            ht.Add(-20295, "ang");
            ht.Add(-20292, "ao");
            ht.Add(-20283, "ba");
            ht.Add(-20265, "bai");
            ht.Add(-20257, "ban");
            ht.Add(-20242, "bang");
            ht.Add(-20230, "bao");
            ht.Add(-20051, "bei");
            ht.Add(-20036, "ben");
            ht.Add(-20032, "beng");
            ht.Add(-20026, "bi");
            ht.Add(-20002, "bian");
            ht.Add(-19990, "biao");
            ht.Add(-19986, "bie");
            ht.Add(-19982, "bin");
            ht.Add(-19976, "bing");
            ht.Add(-19805, "bo");
            ht.Add(-19784, "bu");
            ht.Add(-19775, "ca");
            ht.Add(-19774, "cai");
            ht.Add(-19763, "can");
            ht.Add(-19756, "cang");
            ht.Add(-19751, "cao");
            ht.Add(-19746, "ce");
            ht.Add(-19741, "ceng");
            ht.Add(-19739, "cha");
            ht.Add(-19728, "chai");
            ht.Add(-19725, "chan");
            ht.Add(-19715, "chang");
            ht.Add(-19540, "chao");
            ht.Add(-19531, "che");
            ht.Add(-19525, "chen");
            ht.Add(-19515, "cheng");
            ht.Add(-19500, "chi");
            ht.Add(-19484, "chong");
            ht.Add(-19479, "chou");
            ht.Add(-19467, "chu");
            ht.Add(-19289, "chuai");
            ht.Add(-19288, "chuan");
            ht.Add(-19281, "chuang");
            ht.Add(-19275, "chui");
            ht.Add(-19270, "chun");
            ht.Add(-19263, "chuo");
            ht.Add(-19261, "ci");
            ht.Add(-19249, "cong");
            ht.Add(-19243, "cou");
            ht.Add(-19242, "cu");
            ht.Add(-19238, "cuan");
            ht.Add(-19235, "cui");
            ht.Add(-19227, "cun");
            ht.Add(-19224, "cuo");
            ht.Add(-19218, "da");
            ht.Add(-19212, "dai");
            ht.Add(-19038, "dan");
            ht.Add(-19023, "dang");
            ht.Add(-19018, "dao");
            ht.Add(-19006, "de");
            ht.Add(-19003, "deng");
            ht.Add(-18996, "di");
            ht.Add(-18977, "dian");
            ht.Add(-18961, "diao");
            ht.Add(-18952, "die");
            ht.Add(-18783, "ding");
            ht.Add(-18774, "diu");
            ht.Add(-18773, "dong");
            ht.Add(-18763, "dou");
            ht.Add(-18756, "du");
            ht.Add(-18741, "duan");
            ht.Add(-18735, "dui");
            ht.Add(-18731, "dun");
            ht.Add(-18722, "duo");
            ht.Add(-18710, "e");
            ht.Add(-18697, "en");
            ht.Add(-18696, "er");
            ht.Add(-18526, "fa");
            ht.Add(-18518, "fan");
            ht.Add(-18501, "fang");
            ht.Add(-18490, "fei");
            ht.Add(-18478, "fen");
            ht.Add(-18463, "feng");
            ht.Add(-18448, "fo");
            ht.Add(-18447, "fou");
            ht.Add(-18446, "fu");
            ht.Add(-18239, "ga");
            ht.Add(-18237, "gai");
            ht.Add(-18231, "gan");
            ht.Add(-18220, "gang");
            ht.Add(-18211, "gao");
            ht.Add(-18201, "ge");
            ht.Add(-18184, "gei");
            ht.Add(-18183, "gen");
            ht.Add(-18181, "geng");
            ht.Add(-18012, "gong");
            ht.Add(-17997, "gou");
            ht.Add(-17988, "gu");
            ht.Add(-17970, "gua");
            ht.Add(-17964, "guai");
            ht.Add(-17961, "guan");
            ht.Add(-17950, "guang");
            ht.Add(-17947, "gui");
            ht.Add(-17931, "gun");
            ht.Add(-17928, "guo");
            ht.Add(-17922, "ha");
            ht.Add(-17759, "hai");
            ht.Add(-17752, "han");
            ht.Add(-17733, "hang");
            ht.Add(-17730, "hao");
            ht.Add(-17721, "he");
            ht.Add(-17703, "hei");
            ht.Add(-17701, "hen");
            ht.Add(-17697, "heng");
            ht.Add(-17692, "hong");
            ht.Add(-17683, "hou");
            ht.Add(-17676, "hu");
            ht.Add(-17496, "hua");
            ht.Add(-17487, "huai");
            ht.Add(-17482, "huan");
            ht.Add(-17468, "huang");
            ht.Add(-17454, "hui");
            ht.Add(-17433, "hun");
            ht.Add(-17427, "huo");
            ht.Add(-17417, "ji");
            ht.Add(-17202, "jia");
            ht.Add(-17185, "jian");
            ht.Add(-16983, "jiang");
            ht.Add(-16970, "jiao");
            ht.Add(-16942, "jie");
            ht.Add(-16915, "jin");
            ht.Add(-16733, "jing");
            ht.Add(-16708, "jiong");
            ht.Add(-16706, "jiu");
            ht.Add(-16689, "ju");
            ht.Add(-16664, "juan");
            ht.Add(-16657, "jue");
            ht.Add(-16647, "jun");
            ht.Add(-16474, "ka");
            ht.Add(-16470, "kai");
            ht.Add(-16465, "kan");
            ht.Add(-16459, "kang");
            ht.Add(-16452, "kao");
            ht.Add(-16448, "ke");
            ht.Add(-16433, "ken");
            ht.Add(-16429, "keng");
            ht.Add(-16427, "kong");
            ht.Add(-16423, "kou");
            ht.Add(-16419, "ku");
            ht.Add(-16412, "kua");
            ht.Add(-16407, "kuai");
            ht.Add(-16403, "kuan");
            ht.Add(-16401, "kuang");
            ht.Add(-16393, "kui");
            ht.Add(-16220, "kun");
            ht.Add(-16216, "kuo");
            ht.Add(-16212, "la");
            ht.Add(-16205, "lai");
            ht.Add(-16202, "lan");
            ht.Add(-16187, "lang");
            ht.Add(-16180, "lao");
            ht.Add(-16171, "le");
            ht.Add(-16169, "lei");
            ht.Add(-16158, "leng");
            ht.Add(-16155, "li");
            ht.Add(-15959, "lia");
            ht.Add(-15958, "lian");
            ht.Add(-15944, "liang");
            ht.Add(-15933, "liao");
            ht.Add(-15920, "lie");
            ht.Add(-15915, "lin");
            ht.Add(-15903, "ling");
            ht.Add(-15889, "liu");
            ht.Add(-15878, "long");
            ht.Add(-15707, "lou");
            ht.Add(-15701, "lu");
            ht.Add(-15681, "lv");
            ht.Add(-15667, "luan");
            ht.Add(-15661, "lue");
            ht.Add(-15659, "lun");
            ht.Add(-15652, "luo");
            ht.Add(-15640, "ma");
            ht.Add(-15631, "mai");
            ht.Add(-15625, "man");
            ht.Add(-15454, "mang");
            ht.Add(-15448, "mao");
            ht.Add(-15436, "me");
            ht.Add(-15435, "mei");
            ht.Add(-15419, "men");
            ht.Add(-15416, "meng");
            ht.Add(-15408, "mi");
            ht.Add(-15394, "mian");
            ht.Add(-15385, "miao");
            ht.Add(-15377, "mie");
            ht.Add(-15375, "min");
            ht.Add(-15369, "ming");
            ht.Add(-15363, "miu");
            ht.Add(-15362, "mo");
            ht.Add(-15183, "mou");
            ht.Add(-15180, "mu");
            ht.Add(-15165, "na");
            ht.Add(-15158, "nai");
            ht.Add(-15153, "nan");
            ht.Add(-15150, "nang");
            ht.Add(-15149, "nao");
            ht.Add(-15144, "ne");
            ht.Add(-15143, "nei");
            ht.Add(-15141, "nen");
            ht.Add(-15140, "neng");
            ht.Add(-15139, "ni");
            ht.Add(-15128, "nian");
            ht.Add(-15121, "niang");
            ht.Add(-15119, "niao");
            ht.Add(-15117, "nie");
            ht.Add(-15110, "nin");
            ht.Add(-15109, "ning");
            ht.Add(-14941, "niu");
            ht.Add(-14937, "nong");
            ht.Add(-14933, "nu");
            ht.Add(-14930, "nv");
            ht.Add(-14929, "nuan");
            ht.Add(-14928, "nue");
            ht.Add(-14926, "nuo");
            ht.Add(-14922, "o");
            ht.Add(-14921, "ou");
            ht.Add(-14914, "pa");
            ht.Add(-14908, "pai");
            ht.Add(-14902, "pan");
            ht.Add(-14894, "pang");
            ht.Add(-14889, "pao");
            ht.Add(-14882, "pei");
            ht.Add(-14873, "pen");
            ht.Add(-14871, "peng");
            ht.Add(-14857, "pi");
            ht.Add(-14678, "pian");
            ht.Add(-14674, "piao");
            ht.Add(-14670, "pie");
            ht.Add(-14668, "pin");
            ht.Add(-14663, "ping");
            ht.Add(-14654, "po");
            ht.Add(-14645, "pu");
            ht.Add(-14630, "qi");
            ht.Add(-14594, "qia");
            ht.Add(-14429, "qian");
            ht.Add(-14407, "qiang");
            ht.Add(-14399, "qiao");
            ht.Add(-14384, "qie");
            ht.Add(-14379, "qin");
            ht.Add(-14368, "qing");
            ht.Add(-14355, "qiong");
            ht.Add(-14353, "qiu");
            ht.Add(-14345, "qu");
            ht.Add(-14170, "quan");
            ht.Add(-14159, "que");
            ht.Add(-14151, "qun");
            ht.Add(-14149, "ran");
            ht.Add(-14145, "rang");
            ht.Add(-14140, "rao");
            ht.Add(-14137, "re");
            ht.Add(-14135, "ren");
            ht.Add(-14125, "reng");
            ht.Add(-14123, "ri");
            ht.Add(-14122, "rong");
            ht.Add(-14112, "rou");
            ht.Add(-14109, "ru");
            ht.Add(-14099, "ruan");
            ht.Add(-14097, "rui");
            ht.Add(-14094, "run");
            ht.Add(-14092, "ruo");
            ht.Add(-14090, "sa");
            ht.Add(-14087, "sai");
            ht.Add(-14083, "san");
            ht.Add(-13917, "sang");
            ht.Add(-13914, "sao");
            ht.Add(-13910, "se");
            ht.Add(-13907, "sen");
            ht.Add(-13906, "seng");
            ht.Add(-13905, "sha");
            ht.Add(-13896, "shai");
            ht.Add(-13894, "shan");
            ht.Add(-13878, "shang");
            ht.Add(-13870, "shao");
            ht.Add(-13859, "she");
            ht.Add(-13847, "shen");
            ht.Add(-13831, "sheng");
            ht.Add(-13658, "shi");
            ht.Add(-13611, "shou");
            ht.Add(-13601, "shu");
            ht.Add(-13406, "shua");
            ht.Add(-13404, "shuai");
            ht.Add(-13400, "shuan");
            ht.Add(-13398, "shuang");
            ht.Add(-13395, "shui");
            ht.Add(-13391, "shun");
            ht.Add(-13387, "shuo");
            ht.Add(-13383, "si");
            ht.Add(-13367, "song");
            ht.Add(-13359, "sou");
            ht.Add(-13356, "su");
            ht.Add(-13343, "suan");
            ht.Add(-13340, "sui");
            ht.Add(-13329, "sun");
            ht.Add(-13326, "suo");
            ht.Add(-13318, "ta");
            ht.Add(-13147, "tai");
            ht.Add(-13138, "tan");
            ht.Add(-13120, "tang");
            ht.Add(-13107, "tao");
            ht.Add(-13096, "te");
            ht.Add(-13095, "teng");
            ht.Add(-13091, "ti");
            ht.Add(-13076, "tian");
            ht.Add(-13068, "tiao");
            ht.Add(-13063, "tie");
            ht.Add(-13060, "ting");
            ht.Add(-12888, "tong");
            ht.Add(-12875, "tou");
            ht.Add(-12871, "tu");
            ht.Add(-12860, "tuan");
            ht.Add(-12858, "tui");
            ht.Add(-12852, "tun");
            ht.Add(-12849, "tuo");
            ht.Add(-12838, "wa");
            ht.Add(-12831, "wai");
            ht.Add(-12829, "wan");
            ht.Add(-12812, "wang");
            ht.Add(-12802, "wei");
            ht.Add(-12607, "wen");
            ht.Add(-12597, "weng");
            ht.Add(-12594, "wo");
            ht.Add(-12585, "wu");
            ht.Add(-12556, "xi");
            ht.Add(-12359, "xia");
            ht.Add(-12346, "xian");
            ht.Add(-12320, "xiang");
            ht.Add(-12300, "xiao");
            ht.Add(-12120, "xie");
            ht.Add(-12099, "xin");
            ht.Add(-12089, "xing");
            ht.Add(-12074, "xiong");
            ht.Add(-12067, "xiu");
            ht.Add(-12058, "xu");
            ht.Add(-12039, "xuan");
            ht.Add(-11867, "xue");
            ht.Add(-11861, "xun");
            ht.Add(-11847, "ya");
            ht.Add(-11831, "yan");
            ht.Add(-11798, "yang");
            ht.Add(-11781, "yao");
            ht.Add(-11604, "ye");
            ht.Add(-11589, "yi");
            ht.Add(-11536, "yin");
            ht.Add(-11358, "ying");
            ht.Add(-11340, "yo");
            ht.Add(-11339, "yong");
            ht.Add(-11324, "you");
            ht.Add(-11303, "yu");
            ht.Add(-11097, "yuan");
            ht.Add(-11077, "yue");
            ht.Add(-11067, "yun");
            ht.Add(-11055, "za");
            ht.Add(-11052, "zai");
            ht.Add(-11045, "zan");
            ht.Add(-11041, "zang");
            ht.Add(-11038, "zao");
            ht.Add(-11024, "ze");
            ht.Add(-11020, "zei");
            ht.Add(-11019, "zen");
            ht.Add(-11018, "zeng");
            ht.Add(-11014, "zha");
            ht.Add(-10838, "zhai");
            ht.Add(-10832, "zhan");
            ht.Add(-10815, "zhang");
            ht.Add(-10800, "zhao");
            ht.Add(-10790, "zhe");
            ht.Add(-10780, "zhen");
            ht.Add(-10764, "zheng");
            ht.Add(-10587, "zhi");
            ht.Add(-10544, "zhong");
            ht.Add(-10533, "zhou");
            ht.Add(-10519, "zhu");
            ht.Add(-10331, "zhua");
            ht.Add(-10329, "zhuai");
            ht.Add(-10328, "zhuan");
            ht.Add(-10322, "zhuang");
            ht.Add(-10315, "zhui");
            ht.Add(-10309, "zhun");
            ht.Add(-10307, "zhuo");
            ht.Add(-10296, "zi");
            ht.Add(-10281, "zong");
            ht.Add(-10274, "zou");
            ht.Add(-10270, "zu");
            ht.Add(-10262, "zuan");
            ht.Add(-10260, "zui");
            ht.Add(-10256, "zun");
            ht.Add(-10254, "zuo");
            ht.Add(-10247, "zz");
            HttpContext.Current.Cache["HanZiTable"] = ht;
        }

        private static Hashtable _InsertHashtable = null;
        public static Hashtable InsertHashtable
        {
            get
            {
                if (_InsertHashtable == null)
                {
                    _InsertHashtable = new Hashtable();

                    _InsertHashtable.Add("tbjobcolumn", @"INSERT INTO [tbJobColumn] ([Title],[PageTitle],[MetaKeyword],[MetaDescription],[PhotoName],[PhotoPath],[ShowDetail],[ShortDesc],[URL],[OrderID],[Enable],[InputTime],[ParentID]) VALUES('{0}','','','','','',0,'','',50,1,getdate(),0)");
                    _InsertHashtable.Add("tbadcolumn", "INSERT INTO [tbAdColumn]([ParentID],[Title],[ShortDesc],[OrderID],[Enable],[InputTime]) VALUES(1,'{0}','',50,1,getdate())");
                    _InsertHashtable.Add("tbvideocolumn", "INSERT INTO [tbVideoColumn]([ParentID],[Title],[ShortDesc],[OrderID],[Enable],[InputTime]) VALUES(1,'{0}','',50,1,getdate())");
                    _InsertHashtable.Add("tbfriendlinkcolumn", "INSERT INTO tbFriendLinkColumn ([ParentID],[Title],[ShortDesc],[OrderID],[Enable],[InputTime]) VALUES(1,'{0}','',50,1,getdate())");

                }
                return _InsertHashtable;
            }
        }
    }
}